<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CLAMS: Learning from Experience</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- WebGL Error Message -->
  <div id="webgl-error" class="error-message hidden">
    <h1>WebGL Required</h1>
    <p>This visualization requires WebGL. Please use a modern browser with WebGL support.</p>
    <p>Supported browsers: Chrome, Firefox, Safari, Edge</p>
  </div>

  <!-- CDN Error Message -->
  <div id="cdn-error" class="error-message hidden">
    <h1>Failed to Load Libraries</h1>
    <p>Failed to load required libraries. Please check your internet connection and refresh.</p>
  </div>

  <!-- 3D Layer (behind) -->
  <canvas id="three-canvas"></canvas>

  <!-- 2D Layer (front) -->
  <div id="content-layer">
    <!-- Act 1: Problem & Solution -->
    <div id="act1-content">
      <!-- Scene 1: Problem Statement -->
      <h1 id="problem-text" class="title hidden">AI Agents Lose Context</h1>
      <div id="problem-subtitles" class="subtitle-container hidden">
        <p id="subtitle-1" class="subtitle hidden">They repeat the same mistakes</p>
        <p id="subtitle-2" class="subtitle hidden">They cannot learn from experience</p>
        <p id="subtitle-3" class="subtitle hidden">They lose context between sessions</p>
      </div>

      <!-- Scene 2: CLAMS Solution Pillars -->
      <div id="pillars-intro" class="pillars-intro hidden">
        <h2>CLAMS: Three Pillars of Persistent Memory</h2>
      </div>
      <div id="pillars" class="pillars-container hidden">
        <div id="pillar-1" class="pillar hidden">
          <div class="pillar-icon">
            <svg viewBox="0 0 64 64" class="icon-svg">
              <circle cx="32" cy="32" r="28" fill="none" stroke="currentColor" stroke-width="2"/>
              <path d="M20 28 L28 20 L44 36 L36 44 Z" fill="currentColor" opacity="0.6"/>
              <circle cx="24" cy="40" r="6" fill="none" stroke="currentColor" stroke-width="2"/>
              <line x1="28" y1="36" x2="38" y2="26" stroke="currentColor" stroke-width="2"/>
            </svg>
          </div>
          <div class="pillar-title">Semantic Code Search</div>
          <div class="pillar-desc">Token-efficient retrieval of relevant code through vector embeddings</div>
        </div>
        <div id="pillar-2" class="pillar hidden">
          <div class="pillar-icon">
            <svg viewBox="0 0 64 64" class="icon-svg">
              <rect x="12" y="38" width="40" height="8" rx="2" fill="currentColor" opacity="0.3"/>
              <rect x="12" y="28" width="40" height="8" rx="2" fill="currentColor" opacity="0.5"/>
              <rect x="12" y="18" width="40" height="8" rx="2" fill="currentColor" opacity="0.7"/>
            </svg>
          </div>
          <div class="pillar-title">Layered Working Memory</div>
          <div class="pillar-desc">Self-observation captures experiences into structured GHAP entries</div>
        </div>
        <div id="pillar-3" class="pillar hidden">
          <div class="pillar-icon">
            <svg viewBox="0 0 64 64" class="icon-svg">
              <circle cx="16" cy="32" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
              <circle cx="48" cy="32" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
              <path d="M24 32 L40 32" stroke="currentColor" stroke-width="2" stroke-dasharray="4 2"/>
              <polygon points="38,28 44,32 38,36" fill="currentColor"/>
            </svg>
          </div>
          <div class="pillar-title">Hook-Based Injection</div>
          <div class="pillar-desc">Context automatically flows into new sessions at the right moment</div>
        </div>
      </div>
    </div>

    <!-- Act 2: GHAP Card (placeholder for now) -->
    <div id="ghap-card" class="card hidden">
      <div class="card-header">GHAP Entry</div>
      <div id="ghap-goal" class="field hidden">
        <span class="label">Goal:</span>
        <span class="value">Fix failing authentication test</span>
      </div>
      <div id="ghap-hypothesis" class="field hidden">
        <span class="label">Hypothesis:</span>
        <span class="value">Token expiration is not being checked</span>
      </div>
      <div id="ghap-action" class="field hidden">
        <span class="label">Action:</span>
        <span class="value">Add token expiry validation</span>
      </div>
      <div id="ghap-prediction" class="field hidden">
        <span class="label">Prediction:</span>
        <span class="value">Test will pass after fix</span>
      </div>
      <div id="ghap-resolution" class="resolution hidden">
        <span class="status confirmed">Confirmed</span>
      </div>
    </div>

    <!-- Act 2: Explanatory text -->
    <div id="cluster-explanation" class="explanation hidden">
      Points cluster by semantic similarity
    </div>

    <!-- Act 2: Centroid computation explanation -->
    <div id="centroid-process" class="centroid-process hidden">
      <div id="centroid-step1" class="centroid-step hidden">
        <span class="step-icon">1</span>
        <span class="step-text">Find cluster center in embedding space</span>
      </div>
      <div id="centroid-step2" class="centroid-step hidden">
        <span class="step-icon">2</span>
        <span class="step-text">Agent proposes value that summarizes nearby memories</span>
      </div>
      <div id="centroid-step3" class="centroid-step hidden">
        <span class="step-icon">3</span>
        <span class="step-text">Embed proposed value, compare to centroid</span>
      </div>
      <div id="centroid-step4" class="centroid-step hidden">
        <span class="step-icon">âœ“</span>
        <span class="step-text">Value validated: close to cluster center</span>
      </div>
    </div>

    <div id="value-statement" class="value-text hidden">
      "When auth tests fail, check token expiration first"
    </div>

    <!-- Act 3: Context Injection -->
    <div id="act3-content" class="hidden">
      <!-- Scene 1: Session Start -->
      <div id="session-container" class="session-container hidden">
        <div id="session-header" class="session-header">
          <span class="session-icon">></span>
          <span class="session-title">Claude Code Session</span>
        </div>
        <div id="user-prompt" class="user-prompt hidden">
          <span class="prompt-label">User:</span>
          <span class="prompt-text">Fix the failing auth test</span>
        </div>
        <div id="hook-trigger" class="hook-trigger hidden">
          <span class="hook-icon">[hook]</span>
          <span class="hook-text">assemble_context()</span>
        </div>
      </div>

      <!-- Scene 2: Semantic Retrieval -->
      <div id="retrieval-container" class="retrieval-container hidden">
        <div id="prompt-vector" class="prompt-vector hidden">
          <div class="vector-label">User prompt</div>
          <div class="vector-arrow">-></div>
          <div class="vector-box">[0.42, -0.18, 0.73, ...]</div>
        </div>
        <div id="retrieval-animation" class="retrieval-animation hidden">
          <div class="search-label">Searching similar experiences...</div>
        </div>
        <div id="retrieved-items" class="retrieved-items hidden">
          <div class="retrieved-item" id="retrieved-1">
            <span class="item-icon">*</span>
            <span class="item-text">"Check token expiration first"</span>
          </div>
          <div class="retrieved-item" id="retrieved-2">
            <span class="item-icon">*</span>
            <span class="item-text">"Auth failures often mask config issues"</span>
          </div>
          <div class="retrieved-item" id="retrieved-3">
            <span class="item-icon">*</span>
            <span class="item-text">"Verify test fixtures match schema"</span>
          </div>
        </div>
      </div>

      <!-- Scene 3: Context Injection -->
      <div id="injection-container" class="injection-container hidden">
        <div id="claude-view" class="claude-view hidden">
          <div class="claude-header">Claude's Context</div>
          <div id="injected-context" class="injected-context">
            <div class="context-item hidden" id="context-1">
              <span class="context-label">Learned Value:</span>
              <span class="context-value">"When auth tests fail, check token expiration first"</span>
            </div>
            <div class="context-item hidden" id="context-2">
              <span class="context-label">Related Experience:</span>
              <span class="context-value">Previous session fixed similar issue in session_handler.py</span>
            </div>
          </div>
        </div>
        <div id="agent-working" class="agent-working hidden">
          <span class="working-icon">...</span>
          <span class="working-text">Agent begins work with context</span>
        </div>
      </div>
    </div>

    <!-- Tagline -->
    <div id="tagline" class="tagline hidden">
      Learning from experience, one session at a time
    </div>
  </div>

  <!-- Timeline Controls -->
  <div id="timeline-controls">
    <button id="play-pause" class="control-btn">Play</button>
    <div id="timeline-bar">
      <input type="range" id="scrubber" min="0" max="100" value="0" step="0.1">
      <div id="act-markers">
        <button class="act-marker" data-act="act1" data-time="0">Act 1</button>
        <button class="act-marker" data-act="act2" data-time="45">Act 2</button>
        <button class="act-marker" data-act="act3" data-time="135">Act 3</button>
      </div>
    </div>
    <div id="time-display">
      <span id="current-time">0:00</span> / <span id="total-time">3:00</span>
    </div>
  </div>

  <!-- Libraries (CDN with SRI) -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"
    integrity="sha512-7eHRwcbYkK4d9g/6tD/mhkf++eoTHwpNM9woBxtPUBWm67zeAfFC+HrdoE2GanKeocly/VxeLvIqwvCdk7qScg=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
    onerror="handleCDNError('gsap')">
  </script>
  <script
    src="https://unpkg.com/three@0.160.0/build/three.min.js"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
    onerror="handleCDNError('three')">
  </script>

  <!-- CDN Fallback Script -->
  <script>
    // Track CDN errors
    var cdnErrors = [];

    function handleCDNError(lib) {
      cdnErrors.push(lib);
      console.warn(lib + ' CDN failed, attempting fallback...');

      // Try loading from local lib/ folder
      var script = document.createElement('script');
      script.src = 'lib/' + lib + '.min.js';
      script.onerror = function() {
        console.error('Failed to load ' + lib + ' from fallback');
        showCDNError();
      };
      document.head.appendChild(script);
    }

    function showCDNError() {
      document.getElementById('cdn-error').classList.remove('hidden');
      document.getElementById('content-layer').style.display = 'none';
      document.getElementById('timeline-controls').style.display = 'none';
    }

    // WebGL detection
    function checkWebGL() {
      try {
        var canvas = document.createElement('canvas');
        var gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (!gl) throw new Error('WebGL not supported');
        return true;
      } catch (e) {
        return false;
      }
    }

    function showWebGLError() {
      document.getElementById('webgl-error').classList.remove('hidden');
      document.getElementById('content-layer').style.display = 'none';
      document.getElementById('timeline-controls').style.display = 'none';
      var canvas = document.getElementById('three-canvas');
      if (canvas) canvas.style.display = 'none';
    }

    // Check WebGL on load
    if (!checkWebGL()) {
      showWebGLError();
    }
  </script>

  <!-- Application scripts (ES modules) -->
  <script type="module" src="js/main.js"></script>
</body>
</html>
