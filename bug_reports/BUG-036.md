# BUG-036: KeyError in distribute_budget on invalid source type

## Reported

- **First noticed on commit**: fd6b43e
- **Reported by**: external investigator
- **Reported at**: 2025-12-11
- **Severity**: medium

## Reproduction Steps

1. Call `distribute_budget(context_types=["invalid_type"], max_tokens=1000)`
2. Observe KeyError

**Expected**: Raises descriptive error or ignores invalid types
**Actual**: KeyError: 'invalid_type'

## Observations

In `src/clams/context/tokens.py` line 89:
```python
total_weight = sum(SOURCE_WEIGHTS[t] for t in context_types)  # KeyError if t not in dict
```

When `context_types` contains a value not in `SOURCE_WEIGHTS`, a KeyError is raised with no context about valid values.

**Investigation needed**:
1. What are the valid source types in `SOURCE_WEIGHTS`?
2. Are callers validating context_types before calling?
3. Should invalid types be ignored, or should a descriptive error be raised?
4. Is this related to validation in `ContextAssembler.assemble_context`?

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
The KeyError is raised with no context about valid types.

### Initial Hypothesis

src/clams/context/tokens.py, distribute_budget function, lines 89-92.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | distribute_budget lacks validation | KeyError on invalid type | Different error | KeyError raised | **Confirmed** |
| 2 | assemble_context validates first | InvalidContextTypeError via assembler | KeyError | assembler validates before calling | **Confirmed (partial mitigation)** |
| 3 | Only called via validated paths | No direct calls possible | Direct calls possible | tests call it directly | **Eliminated** |
| 4 | SOURCE_WEIGHTS out of sync | Keys differ | Keys match | Both have same 5 keys | **Eliminated** |

### Evidentiary Scaffold

**Test 1: Direct call to distribute_budget**:
```python
>>> from clams.context.tokens import distribute_budget
>>> distribute_budget(['invalid_type'], 1000)
KeyError: 'invalid_type'
```

**Test 2: Verify assembler validates first** (assembler.py:66-71):
```python
invalid = [t for t in context_types if t not in VALID_CONTEXT_TYPES]
if invalid:
    raise InvalidContextTypeError(invalid[0], list(VALID_CONTEXT_TYPES))
```

**Test 3: Verify SOURCE_WEIGHTS keys**:
```python
>>> SOURCE_WEIGHTS
{'memories': 1, 'code': 2, 'experiences': 3, 'values': 1, 'commits': 2}
```

### Root Cause (Proven)

**The bug is caused by**: Missing input validation in distribute_budget() at src/clams/context/tokens.py:89-92. The function assumes all context_types are valid keys in SOURCE_WEIGHTS, but performs no validation.

**Evidence**:
1. Direct call distribute_budget(['invalid_type'], 1000) raises KeyError: 'invalid_type'
2. Lines 89-92 show direct dictionary access without validation
3. No 'if t not in SOURCE_WEIGHTS' check exists

**Why alternatives were eliminated**:
- Hypothesis 3: distribute_budget is public, tests call it directly
- Hypothesis 4: SOURCE_WEIGHTS.keys() matches VALID_CONTEXT_TYPES exactly

---

## Fix Plan

### Code Changes

1. **File**: `src/clams/context/tokens.py`
   **Function**: `distribute_budget`
   **Change**: Validate context_types against SOURCE_WEIGHTS.keys() before processing
   **Rationale**: Provides clear error message with valid options

```python
def distribute_budget(context_types: list[str], max_tokens: int):
    invalid = [t for t in context_types if t not in SOURCE_WEIGHTS]
    if invalid:
        raise ValueError(f"Invalid context types: {invalid}. Valid: {list(SOURCE_WEIGHTS.keys())}")
    ...
```

### Regression Test

**Test file**: `tests/context/test_bug_036_regression.py`

**Test should**:
1. Call distribute_budget with invalid context type
2. Verify no raw KeyError
3. Verify descriptive error message

**Test outline**:
```python
def test_bug_036_invalid_context_type():
    with pytest.raises(ValueError, match="Invalid context types"):
        distribute_budget(context_types=["invalid_type"], max_tokens=1000)
```

### Verification

After implementing the fix:
```bash
# Run specific test
pytest tests/context/test_bug_036_regression.py -xvs

# Run full test suite
pytest -xvs
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
