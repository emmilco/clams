# BUG-066: claws-worktree merge does not update task phase

## Reported

- **First noticed on commit**: c9b0f37 (2026-01-27)
- **Reported by**: orchestrator
- **Reported at**: 2026-01-27
- **Severity**: medium

## Reproduction Steps

1. Create a bug task and worktree: `claws-task create BUG-XXX "Test" --type bug && claws-worktree create BUG-XXX`
2. Make changes, pass all gates through TESTED phase
3. Transition to MERGED: `claws-task transition BUG-XXX MERGED --gate-result pass`
4. Run merge: `claws-worktree merge BUG-XXX`
5. Check task status: `claws-task show BUG-XXX`

**Expected**: Task phase should be DONE (or at least a warning should be displayed)
**Actual**: Task phase remains MERGED, worktree_path is cleared but phase unchanged

---

## Investigation (filled by Bug Investigator)

> **MINIMUM REQUIREMENTS FOR GATE PASSAGE**
>
> Before attempting REPORTED-INVESTIGATED transition, ensure:
> - [x] At least 3 hypotheses in differential diagnosis (or 2 with justification)
> - [x] Exactly 1 hypothesis marked CONFIRMED
> - [x] Each eliminated hypothesis has specific evidence cited
> - [x] Evidentiary scaffold contains actual code
> - [x] Captured output from scaffold run is included
> - [x] Fix plan references specific files and functions

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
During session startup on 2026-01-27, `claws-status` showed:
- 9 blocked tasks
- Multiple bugs in TESTED/MERGED/INVESTIGATED phases
- But investigation revealed all worktrees had been deleted and all code merged to main

13+ tasks were found in wrong phases, all requiring manual SQL fixes:
```
BUG-053 through BUG-065: All merged to main, database showed TESTED/MERGED/INVESTIGATED
SPEC-025, SPEC-028, SPEC-042, SPEC-043: All merged, database showed wrong phases
```

### Initial Hypothesis

The `claws-worktree merge` command clears `worktree_path` but never updates the `phase` column, leaving tasks in stale phases after merge.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | merge command doesn't update phase | No UPDATE statement for phase in merge function | UPDATE statement exists but conditional | Searched code: `grep "UPDATE tasks.*phase" .claude/bin/claws-worktree` returns empty | CONFIRMED |
| 2 | Phase update exists but fails silently | UPDATE statement exists, SQL error in logs | No UPDATE statement | No UPDATE for phase found in script | Eliminated |
| 3 | Race condition with concurrent operations | Intermittent failures, some tasks updated | Consistent failure across all tasks | All 13+ tasks consistently showed wrong phase - no intermittency | Eliminated |

### Reduced Hypothesis Justification

Only 2 alternative hypotheses listed because the code inspection definitively shows no phase update logic exists. The bug is a missing feature, not a malfunction of existing code.

### Evidentiary Scaffold

**Logging/assertions added**:
```bash
# Location: .claude/bin/claws-worktree line 264
# Purpose: Confirm what the merge command actually updates
# Searched for any phase updates in the merge function
grep -n "UPDATE tasks" .claude/bin/claws-worktree
```

**Test command**:
```bash
grep -n "UPDATE tasks" .claude/bin/claws-worktree
```

**Captured output**:
```
264:    sqlite3 "$DB_PATH" "UPDATE tasks SET worktree_path = NULL, updated_at = CURRENT_TIMESTAMP WHERE id = '$task_id';"
481:    sqlite3 "$DB_PATH" "UPDATE tasks SET worktree_path = NULL, updated_at = CURRENT_TIMESTAMP WHERE id = '$task_id';"
```

Both UPDATE statements only modify `worktree_path` and `updated_at` - no phase update.

### Root Cause (Proven)

**The bug is caused by**: The `do_merge()` function in `.claude/bin/claws-worktree` (line ~264) only clears `worktree_path` after a successful merge. It never updates the task `phase`.

**Evidence**:
- `grep "UPDATE tasks.*phase" .claude/bin/claws-worktree` returns no matches
- The only UPDATE statements modify `worktree_path` and `updated_at`
- 13+ tasks found in wrong phases with their worktrees deleted and code on main

**Why alternatives were eliminated**:
- Hypothesis 2 eliminated because: No UPDATE for phase exists in the code at all
- Hypothesis 3 eliminated because: 100% of checked tasks showed the issue - no intermittency

---

## Fix Plan

### Code Changes

1. **File**: `.claude/bin/claws-worktree`
   **Function**: `do_merge()` (around line 264)
   **Change**: After successful merge, automatically transition the task:
   - For bugs: Update phase to DONE
   - For features: Update phase to VERIFY
   **Rationale**: Closes the gap between merge and phase update, matching user mental model

2. **File**: `.claude/bin/claws-worktree`
   **Function**: `do_merge()` (success message section)
   **Change**: Log the phase transition for visibility:
   ```
   Merge complete: <SHA>
   Task phase updated: MERGED â†’ DONE
   ```
   **Rationale**: Transparency about automatic transitions

### Regression Test

**Test file**: `tests/claws/test_worktree_merge_phase.py`

**Test should**:
1. Create a task in MERGED phase with a worktree
2. Run the merge command
3. Verify task phase is updated to DONE
4. Verify worktree_path is NULL

**Test outline**:
```python
def test_merge_updates_phase_to_done():
    """BUG-066: Verify merge command updates task phase."""
    # Setup: create task in MERGED phase
    task_id = "TEST-BUG-066"
    run(f"claws-task create {task_id} 'Test merge phase' --type bug")
    run(f"claws-worktree create {task_id}")
    # Fast-forward to MERGED phase
    db_update(f"UPDATE tasks SET phase = 'MERGED' WHERE id = '{task_id}'")

    # Action: run merge
    run(f"claws-worktree merge {task_id}")

    # Assert: phase should be DONE
    result = db_query(f"SELECT phase, worktree_path FROM tasks WHERE id = '{task_id}'")
    assert result.phase == "DONE"
    assert result.worktree_path is None
```

### Verification

After implementing the fix:
```bash
# Run specific test
pytest tests/claws/test_worktree_merge_phase.py -xvs

# Run full test suite
pytest -xvs
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
