# Bug Report: BUG-075

## Title
Editable install conflicts between worktrees

## First Noticed On Commit
eeee713

## Reproduction Steps
1. Create multiple worktrees with `calm worktree create`
2. Each worktree shares the same editable install of the `calm` package
3. Running `pip install -e .` in one worktree can break the install for others
4. Import paths may resolve to the wrong worktree's code

## Expected Behavior
Each worktree should have an isolated environment or at least not interfere with other worktrees. When running tests in a worktree, imports should resolve to the worktree's own code.

## Actual Behavior
Editable installs in worktrees can conflict because they all share the same Python environment. The last `pip install -e .` wins and other worktrees' imports may resolve incorrectly.

More critically: even WITHOUT running `pip install -e .` in a worktree, tests in worktrees always execute against the main repo's code, not the worktree's code. Worker code changes are never actually tested until they are merged to main.

---

## Investigation

### Reproduction Confirmed

- [x] Steps reproduced bug

**Reproduction method**: Added a unique marker attribute `_BUG_075_WORKTREE_MARKER = True` to the worktree's `src/calm/__init__.py`, then ran a pytest test that checked for it. The marker was NOT visible to pytest, confirming that pytest loaded `calm` from the main repo instead.

**Key evidence from reproduction**:

```
test_marker_check.py::test_worktree_marker
  Marker present: None
  calm loaded from: /Users/elliotmilco/Documents/GitHub/clams/src/calm/__init__.py
  TEST RESULT: pytest loaded the MAIN REPO code (BUG CONFIRMED)
```

### Mechanism

The editable install uses a PEP 660 `.pth` file mechanism:

- File: `/Users/elliotmilco/.pyenv/versions/3.13.6/lib/python3.13/site-packages/_calm.pth`
- Content: `/Users/elliotmilco/Documents/GitHub/clams/src`
- This `.pth` file is loaded at Python startup and adds the main repo's `src/` to `sys.path`

When pytest runs in a worktree:
1. Python starts and processes `.pth` files, adding main repo `src/` to `sys.path`
2. pytest sets rootdir to the worktree directory
3. pytest does NOT add the worktree's `src/` to `sys.path` (it adds the rootdir, not rootdir/src)
4. `import calm` resolves via the `.pth` file to the main repo
5. Test files are loaded from the worktree's `tests/` directory (correct)
6. But imports of `calm.*` resolve to the main repo's `src/calm/` (incorrect)

**Evidence (sys.path during pytest in worktree)**:
```
SYS_PATH_SRC: ['/Users/elliotmilco/Documents/GitHub/clams/src']
CALM_FROM: /Users/elliotmilco/Documents/GitHub/clams/src/calm/__init__.py
Worktree src on sys.path: False
Main src on sys.path: True
WINNER: Only main src on path
```

### Differential Diagnosis

| # | Hypothesis | If True | If False | Evidence | Status |
|---|-----------|---------|----------|----------|--------|
| 1 | `.pth` file always resolves to main repo, so worktree tests run against main repo code | Tests import `calm` from main repo regardless of cwd | Tests import from worktree `src/` | Marker test: marker in worktree `__init__.py` not visible to pytest; `calm.__file__` points to main repo | **CONFIRMED** |
| 2 | Running `pip install -e .` in a worktree overwrites the `.pth` file and breaks all other worktrees | `.pth` file and `direct_url.json` would change to worktree path | `.pth` file remains unchanged | Not triggered by current automation (no code runs `pip install -e .` in worktrees). Historical evidence: retrospective sessions 702c35c9, 94a13da2 show this DID happen with manual intervention. | **TRUE but not automated** |
| 3 | `uv sync` in a worktree could redirect editable install | `uv sync` would change `.pth` file | `.pth` remains pointing to main | `merge_worktree()` runs `uv sync` with `cwd=main_repo` (not worktree), so this is handled correctly | **ELIMINATED** |
| 4 | pytest automatically adds `src/` layout directories to sys.path | Worktree `src/` would appear in sys.path | Only main repo `src/` in sys.path | Path diagnostic test showed worktree `src/` NOT on sys.path. The `.pth` file from the editable install takes precedence over pytest's rootdir-based path detection. | **ELIMINATED** |

### Root Cause (Proven)

**The bug has two aspects:**

**Primary (always present)**: The PEP 660 editable install creates a `.pth` file (`_calm.pth`) that hardcodes the main repo's `src/` directory path. This `.pth` file is processed at Python startup, before pytest can modify `sys.path`. As a result, `import calm` always resolves to the main repo's code, regardless of which worktree pytest is running in. Workers' code modifications in worktrees are never tested by their own gate check tests.

**Secondary (manually triggered)**: If anyone runs `pip install -e .` or `uv pip install -e .` inside a worktree directory, the `.pth` file is overwritten to point to that worktree's `src/`. This breaks imports for the main repo and all other worktrees. When the worktree is later deleted, all imports break entirely. No current automation triggers this, but it has happened historically with manual intervention.

**Evidence**:
- `.pth` file content: `/Users/elliotmilco/Documents/GitHub/clams/src` (always main repo)
- `direct_url.json`: `"url": "file:///Users/elliotmilco/Documents/GitHub/clams"` (always main repo)
- Marker test: unique attribute added to worktree's `__init__.py` was NOT visible to pytest
- Retrospective 2025-12-14 Theme 3 documents 7 incidents of worktree import confusion
- Session cbe3dfb7: "Tests in worktrees load code from main repo's editable install instead of worktree code"
- Session 3efe4045: "Python import path confusion across worktrees"

### Why Alternatives Were Eliminated

- **H3 (uv sync redirect)**: The `merge_worktree()` function correctly runs `uv sync` with `cwd=main_repo`, so it would never redirect the editable install to a worktree path. Verified by code inspection.
- **H4 (pytest auto-detection)**: Tested directly -- pytest's rootdir-based path detection does NOT override the `.pth` file from the editable install. The worktree's `src/` is simply never added to `sys.path`.

### Impact Analysis

**Scenario 1: Worker adds NEW function/file in worktree**
- Test tries to import the new symbol -> ImportError
- Worker notices immediately
- Severity: LOW (self-correcting)

**Scenario 2: Worker MODIFIES existing function in worktree**
- Tests run against OLD (main repo) code
- Tests may silently pass even if the worker's changes are broken
- Bug not caught until VERIFY phase on main
- Severity: HIGH (silent false positives)

**Scenario 3: Another worktree merges to main while this worktree is active**
- This worktree's tests now run against the merged code (which may differ from what the worktree branched from)
- Spurious failures or passes possible
- Severity: MEDIUM (confusing but visible)

---

## Root Cause

The PEP 660 editable install mechanism (`_calm.pth` file in site-packages) hardcodes the main repository's `src/` directory. When pytest runs in a worktree, Python's import system resolves `calm.*` imports to the main repo's code rather than the worktree's code. This means workers' code changes are never actually tested during gate checks in worktrees.

The core issue is that all worktrees share a single Python environment with a single editable install that can only point to one source directory at a time.

## Fix Plan

Three fix options were evaluated. Option A (conftest.py sys.path fix) is recommended as the primary fix, with Option B as a secondary enhancement.

### Option A: Add worktree `src/` to `sys.path` via conftest.py (Recommended - Simple)

**File**: `tests/conftest.py`
**Change**: At the top of the file, detect if running in a worktree and prepend the worktree's `src/` directory to `sys.path` so it takes priority over the `.pth` file.

```python
import sys
from pathlib import Path

# Ensure worktree's src/ takes priority over main repo's editable install
_src_dir = str(Path(__file__).resolve().parent.parent / "src")
if _src_dir not in sys.path:
    sys.path.insert(0, _src_dir)
```

This ensures that regardless of what the `.pth` file says, Python will find `calm` in the current project's `src/` first (whether that's a worktree or the main repo).

**Pros**: Simple, no external tooling changes, works immediately
**Cons**: Only affects pytest; other Python scripts in worktrees still use main repo code

### Option B: Use PYTHONPATH in gate checks (Alternative)

**File**: `src/calm/orchestration/gates.py`
**Functions**: `_check_tests_pass`, `_check_types_clean`
**Change**: Set `PYTHONPATH` environment variable when running subprocess commands in worktrees.

```python
env = os.environ.copy()
env["PYTHONPATH"] = str(worktree / "src") + os.pathsep + env.get("PYTHONPATH", "")
result = subprocess.run(["pytest", ...], env=env, ...)
```

**Pros**: Affects all Python processes spawned by gate checks
**Cons**: More invasive, only helps automated gate checks

### Option C: Per-worktree virtual environments (Most Robust)

**File**: `src/calm/orchestration/worktrees.py`
**Function**: `create_worktree`
**Change**: Create a virtual environment in each worktree and install the package in editable mode there.

**Pros**: Complete isolation, mirrors real deployment
**Cons**: Significant overhead (venv creation + dependency installation for each worktree), slower worktree creation

### Recommended Approach

**Option A** is recommended as the primary fix because:
1. It is the simplest change with the highest impact
2. It ensures test files AND code under test come from the same directory
3. It works for both worktrees and the main repo (the conftest.py's parent's parent's `src/` will always be correct)
4. It has no performance overhead
5. It requires no changes to the worktree creation or gate check infrastructure

**Option B** should be added as a secondary fix to ensure gate check subprocesses (mypy, etc.) also resolve to the correct code.

### Regression Test Requirements

The regression test should:
1. Verify that `sys.path` contains the project's own `src/` directory at position 0 (or at least before any other `calm` source)
2. Verify that `calm.__file__` resolves to a path under the current project's `src/` directory (not some other directory)
3. These tests themselves will validate the fix since they run inside the test suite

**Test outline**:
```python
# tests/test_import_isolation.py
import sys
from pathlib import Path

def test_calm_imports_from_project_src():
    """Verify calm is imported from this project's src/, not another location."""
    import calm
    project_root = Path(__file__).resolve().parent.parent
    expected_src = project_root / "src"
    calm_path = Path(calm.__file__).resolve()
    assert str(calm_path).startswith(str(expected_src)), (
        f"calm imported from {calm_path}, expected under {expected_src}"
    )

def test_project_src_on_sys_path():
    """Verify project src/ is on sys.path for proper import resolution."""
    project_root = Path(__file__).resolve().parent.parent
    expected_src = str(project_root / "src")
    assert expected_src in sys.path, (
        f"{expected_src} not found in sys.path"
    )
```

### Verification

After implementing the fix:
1. Run the regression tests in the main repo -- should pass
2. Create a worktree, add a unique marker to `src/calm/__init__.py` in the worktree, run the regression test in the worktree -- should detect the worktree's code, not the main repo's

---

## Resolution

- **Fixed in commit**: [pending implementation]
- **Verified by**: [pending]
- **Closed at**: [pending]
