# BUG-065: Add next-commands to handoff format

## Reported

- **First noticed on commit**: Multiple sessions (see retrospective-2025-12-14.md Theme 8)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-14
- **Severity**: low

## Reproduction Steps

1. Session ends with `/wrapup continue`
2. Handoff is saved with summary and task status
3. Next session starts
4. Orchestrator must re-analyze tasks to determine next actions
5. Time wasted re-deriving what should be done next

**Expected**: Handoff should include explicit next commands/actions to execute.
**Actual**: Handoff has summary but no actionable next steps.

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
- Session 43763784: "Had to re-read all task states to figure out next actions"
- Session c97d59ea: "Handoff said 'continue' but didn't say how"
- Retrospective Theme 8: Session handoffs missing actionable next steps

### Initial Hypothesis

Handoff format lacks explicit "next commands" section.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | No next-commands in handoff | Manual re-derivation needed | Commands ready to run | Reviewed handoff format - no next-commands section | Confirmed |

### Root Cause (Proven)

**The bug is caused by**: Handoff format includes summary and task states but no explicit next actions.

**Evidence**: Reviewed `.claude/bin/claws-session` - handoff template has summary, tasks, friction points, but no next-commands.

---

## Fix Plan

### Code Changes

1. **File**: `.claude/bin/claws-session`
   **Function**: save section
   **Change**: Add next-commands section to handoff:
   ```bash
   # Handoff format addition
   cat >> "$handoff_file" << EOF

   ## Next Commands

   Execute these commands to continue work:

   \`\`\`bash
   # Resume task $highest_priority_task
   .claude/bin/claws-task show $highest_priority_task
   cd .worktrees/$highest_priority_task

   # Next action based on phase
   $(get_next_action $highest_priority_task)
   \`\`\`

   ## Pending Actions

   $(for task in $active_tasks; do
       phase=$(.claude/bin/claws-task show $task --format phase)
       echo "- $task ($phase): $(describe_next_action $task $phase)"
   done)
   EOF
   ```

2. **File**: `.claude/bin/claws-session`
   **Change**: Add helper function for next action derivation:
   ```bash
   get_next_action() {
       task_id=$1
       phase=$(.claude/bin/claws-task show $task_id --format phase)

       case $phase in
           REPORTED)
               echo "# Dispatch bug investigator"
               ;;
           INVESTIGATED)
               echo ".claude/bin/claws-gate check $task_id INVESTIGATED-FIXED"
               ;;
           IMPLEMENT)
               echo ".claude/bin/claws-gate check $task_id IMPLEMENT-CODE_REVIEW"
               ;;
           CODE_REVIEW)
               echo "# Dispatch reviewer #1"
               ;;
           TEST)
               echo ".claude/bin/claws-gate check $task_id TEST-INTEGRATE"
               ;;
           INTEGRATE)
               echo ".claude/bin/claws-worktree merge $task_id"
               ;;
           *)
               echo "# Check task status"
               ;;
       esac
   }
   ```

3. **File**: Session display on startup
   **Change**: Display next-commands section prominently:
   ```
   === Resuming from previous session ===

   Next Commands (copy-paste ready):
   ----------------------------------
   .claude/bin/claws-task show BUG-042
   .claude/bin/claws-gate check BUG-042 INVESTIGATED-FIXED

   Pending Tasks:
   - BUG-042 (INVESTIGATED): Run gate check and transition
   - SPEC-001-02 (CODE_REVIEW): Dispatch reviewer #1
   ```

### Regression Test

Manual verification:
1. Create session with active tasks in various phases
2. Run `claws-session save --continue`
3. Verify next-commands section is populated
4. Verify commands are correct for each task's phase
5. Start new session, verify commands display

### Verification

After implementing the fix:
```bash
# Save session and check handoff
.claude/bin/claws-session save --continue

# View the saved handoff
.claude/bin/claws-session list | head -1 | xargs .claude/bin/claws-session show
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
