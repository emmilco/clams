# BUG-001: GHAP strategy enum schema mismatch

## Reported

- **First noticed on commit**: b731c62
- **Reported by**: orchestrator (via manual MCP tool testing)
- **Reported at**: 2025-12-05
- **Severity**: medium

## Reproduction Steps

1. Start a Claude Code session with the learning-memory-server MCP configured
2. Try to call `start_ghap` with any strategy value from the JSON schema (e.g., `hypothesis_testing`, `divide_and_conquer`)
3. Observe validation error

**Expected**: The tool should accept strategy values that match the JSON schema definition (underscored names like `hypothesis_testing`, `divide_and_conquer`, `pattern_matching`, `root_cause_analysis`, `incremental`, `other`)

**Actual**: The server validates against different enum values (hyphenated names like `systematic-elimination`, `root-cause-analysis`), causing validation errors when using schema-compliant values

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
The bug is confirmed by examining the source code. Any attempt to call `start_ghap` with a strategy value from the JSON schema (e.g., `hypothesis_testing`) will fail server validation because the server validates against a completely different set of strategy values.

### Initial Hypothesis

The JSON schema in `src/learning_memory_server/server/tools/__init__.py` (lines 415-418) defines strategy enum values that don't match the actual validation logic in `src/learning_memory_server/server/tools/enums.py` (lines 19-29) and the Python enum in `src/learning_memory_server/observation/models.py` (lines 22-33).

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | JSON schema has outdated enum values that weren't updated during implementation | Schema values differ completely from server validation and Python enum | Schema values would match server validation | Schema has: `hypothesis_testing`, `divide_and_conquer`, `pattern_matching`, `root_cause_analysis`, `incremental`, `other`. Server has: `systematic-elimination`, `trial-and-error`, `research-first`, `divide-and-conquer`, `root-cause-analysis`, `copy-from-similar`, `check-assumptions`, `read-the-error`, `ask-user` | **Confirmed** |
| 2 | Server validation has wrong values (schema is correct) | Tests would fail for strategy validation, server would accept schema values | Tests would pass, validation would work | Tests in `tests/server/tools/test_enums.py` verify server validation against `STRATEGIES` list. Tests pass, meaning server validation is intentional and correct | **Eliminated** |
| 3 | Python enum doesn't match either schema or validation | Three different sets of values across three files | Enum would match at least one of them | Python enum in `models.py` uses hyphenated values matching server validation exactly (e.g., `SYSTEMATIC_ELIMINATION = "systematic-elimination"`) | **Eliminated** |

### Evidentiary Scaffold

**No dynamic logging needed** - bug is evident from static code analysis:

**File 1**: `src/learning_memory_server/server/tools/__init__.py:415-418`
```python
"strategy": {
    "type": "string",
    "description": "Problem-solving strategy",
    "enum": ["hypothesis_testing", "divide_and_conquer", "pattern_matching", "root_cause_analysis", "incremental", "other"],
},
```

**File 2**: `src/learning_memory_server/server/tools/enums.py:19-29`
```python
STRATEGIES = [
    "systematic-elimination",
    "trial-and-error",
    "research-first",
    "divide-and-conquer",
    "root-cause-analysis",
    "copy-from-similar",
    "check-assumptions",
    "read-the-error",
    "ask-user",
]
```

**File 3**: `src/learning_memory_server/observation/models.py:22-33`
```python
class Strategy(Enum):
    """Strategy values match parent spec SPEC-001 exactly."""

    SYSTEMATIC_ELIMINATION = "systematic-elimination"
    TRIAL_AND_ERROR = "trial-and-error"
    RESEARCH_FIRST = "research-first"
    DIVIDE_AND_CONQUER = "divide-and-conquer"
    ROOT_CAUSE_ANALYSIS = "root-cause-analysis"
    COPY_FROM_SIMILAR = "copy-from-similar"
    CHECK_ASSUMPTIONS = "check-assumptions"
    READ_THE_ERROR = "read-the-error"
    ASK_USER = "ask-user"
```

### Root Cause (Proven)

**The bug is caused by**: The JSON schema in `_get_all_tool_definitions()` was not updated when the strategy enum values were finalized. The schema defines 6 underscored strategy values (`hypothesis_testing`, etc.) while the server implementation validates against 9 hyphenated values (`systematic-elimination`, etc.).

**Evidence**:
1. Direct inspection shows JSON schema defines: `["hypothesis_testing", "divide_and_conquer", "pattern_matching", "root_cause_analysis", "incremental", "other"]`
2. Server validation (`enums.py:STRATEGIES`) expects: `["systematic-elimination", "trial-and-error", "research-first", "divide-and-conquer", "root-cause-analysis", "copy-from-similar", "check-assumptions", "read-the-error", "ask-user"]`
3. Python enum (`models.py:Strategy`) matches the server validation exactly
4. Only 2 values overlap: `divide-and-conquer` and `root-cause-analysis` (both using hyphens in the overlap)
5. Tests in `test_enums.py` verify the server validation is correct and intentional

**Why alternatives were eliminated**:
- Hypothesis 2 (server validation is wrong) eliminated because: Tests explicitly verify `STRATEGIES` list is correct, and `models.py` enum matches it exactly with comment "Strategy values match parent spec SPEC-001 exactly"
- Hypothesis 3 (enum doesn't match) eliminated because: `models.py:Strategy` enum values exactly match `enums.py:STRATEGIES` list (e.g., both use `systematic-elimination`, `trial-and-error`, etc.)

---

## Fix Plan

### Code Changes

1. **File**: `src/learning_memory_server/server/tools/__init__.py`
   **Function**: `_get_all_tool_definitions()`
   **Lines**: 415-418 (start_ghap strategy enum) and 458-461 (update_ghap strategy enum)
   **Change**: Replace the strategy enum arrays with the correct values from `enums.py:STRATEGIES`
   **Rationale**: The JSON schema must match the server validation to prevent client-server mismatch. The server validation and Python enum are correct (tested and documented), so the schema needs to be updated.

   **Before** (line 418):
   ```python
   "enum": ["hypothesis_testing", "divide_and_conquer", "pattern_matching", "root_cause_analysis", "incremental", "other"],
   ```

   **After** (line 418):
   ```python
   "enum": ["hypothesis_testing", "divide_and_conquer", "pattern_matching", "root_cause_analysis", "incremental", "other"],
   ```

   Should be:
   ```python
   "enum": ["systematic-elimination", "trial-and-error", "research-first", "divide-and-conquer", "root-cause-analysis", "copy-from-similar", "check-assumptions", "read-the-error", "ask-user"],
   ```

   **Note**: This change must be made in TWO places:
   - Line 418: `start_ghap` tool definition
   - Line 461: `update_ghap` tool definition

### Regression Test

**Test file**: `tests/server/tools/test_ghap.py` (already exists, add new test)

**Test should**:
1. Verify that JSON schema enum values match the STRATEGIES constant from enums.py
2. Verify that all strategy values from the schema are accepted by validate_strategy()
3. Ensure the test will fail if the schema is updated without updating validation (or vice versa)

**Test outline**:
```python
def test_bug_001_schema_validation_alignment():
    """Regression test for BUG-001: JSON schema must match server validation.

    The JSON schema in _get_all_tool_definitions() must define the same
    strategy enum values that the server validates against in enums.STRATEGIES.
    """
    from learning_memory_server.server.tools import _get_all_tool_definitions
    from learning_memory_server.server.tools.enums import STRATEGIES, validate_strategy

    # Get tool definitions
    tools = _get_all_tool_definitions()

    # Find start_ghap tool
    start_ghap_tool = next(t for t in tools if t.name == "start_ghap")
    schema_strategies = start_ghap_tool.inputSchema["properties"]["strategy"]["enum"]

    # Verify schema matches server validation
    assert set(schema_strategies) == set(STRATEGIES), \
        f"Schema strategies {schema_strategies} don't match STRATEGIES {STRATEGIES}"

    # Verify all schema values are valid (would have failed before fix)
    for strategy in schema_strategies:
        validate_strategy(strategy)  # Should not raise

    # Also check update_ghap tool
    update_ghap_tool = next(t for t in tools if t.name == "update_ghap")
    update_schema_strategies = update_ghap_tool.inputSchema["properties"]["strategy"]["enum"]
    assert set(update_schema_strategies) == set(STRATEGIES)
```

### Verification

After implementing the fix:
```bash
# Run the new regression test
pytest tests/server/tools/test_ghap.py::test_bug_001_schema_validation_alignment -xvs

# Run all GHAP tests to ensure nothing broke
pytest tests/server/tools/test_ghap.py -xvs

# Run enum validation tests
pytest tests/server/tools/test_enums.py -xvs

# Run full test suite
pytest -xvs
```

---

## Implementation (filled by Implementer)

- **Implemented by**: W-1764997785-9581
- **Commit**: 675ee92
- **Regression test file**: `tests/server/tools/test_ghap.py::test_bug_001_schema_validation_alignment`

### Changes Made

Followed the fix plan exactly as documented. All changes implemented successfully.

**File 1**: `src/learning_memory_server/server/tools/__init__.py`

**Change 1** - Line 418 (`start_ghap` strategy enum):
```python
# BEFORE:
"enum": ["hypothesis_testing", "divide_and_conquer", "pattern_matching", "root_cause_analysis", "incremental", "other"],

# AFTER:
"enum": ["systematic-elimination", "trial-and-error", "research-first", "divide-and-conquer", "root-cause-analysis", "copy-from-similar", "check-assumptions", "read-the-error", "ask-user"],
```

**Change 2** - Line 461 (`update_ghap` strategy enum):
```python
# BEFORE:
"enum": ["hypothesis_testing", "divide_and_conquer", "pattern_matching", "root_cause_analysis", "incremental", "other"],

# AFTER:
"enum": ["systematic-elimination", "trial-and-error", "research-first", "divide-and-conquer", "root-cause-analysis", "copy-from-similar", "check-assumptions", "read-the-error", "ask-user"],
```

**File 2**: `tests/server/tools/test_ghap.py`

Added regression test `test_bug_001_schema_validation_alignment()` that:
- Verifies JSON schema enum values match `enums.STRATEGIES`
- Verifies all schema values pass `validate_strategy()`
- Checks both `start_ghap` and `update_ghap` tool definitions
- Will catch future schema/validation mismatches

### Test Results

```
$ pytest tests/server/tools/test_ghap.py -xvs

======================== 19 passed in 0.18s =========================
```

All GHAP tests pass, including the new regression test. The fix ensures that:
1. MCP clients can successfully call `start_ghap` and `update_ghap` using the strategy values advertised in the JSON schema
2. The schema will stay in sync with server validation going forward (regression test will catch drift)

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
