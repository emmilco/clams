# BUG-029: GHAP start should error when active entry exists

## Reported

- **First noticed on commit**: 22902b24ba20f1df332c8504901132ff379cb2e4
- **Reported by**: orchestrator
- **Reported at**: 2025-12-10T02:36:00Z
- **Severity**: low

## Reproduction Steps

1. Call `start_ghap` to create a new GHAP entry
2. Without calling `resolve_ghap`, call `start_ghap` again with different parameters
3. Observe the error returned

**Expected**: A clear, helpful error message like `"Active GHAP exists (id: ghap_xxx). Resolve it first with resolve_ghap or abandon it."`

**Actual**: Returns generic `{"error": {"type": "internal_error", "message": "Internal server error"}}`

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
Code inspection confirms the issue. When `start_ghap` is called with an active entry, the code at `src/clams/server/tools/ghap.py:104-114` only logs a warning but allows the operation to proceed, orphaning the previous entry.

### Initial Hypothesis

The `start_ghap` handler in `src/clams/server/tools/ghap.py` does not return an error when an active GHAP exists - it logs a warning and continues.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | Missing active GHAP check | No check for active entry in code | Check exists | Line 105: `current = await collector.get_current()` | Eliminated |
| 2 | Check exists but doesn't error | Warning logged, operation continues | Error returned to client | Lines 106-114 show `if current is not None:` only logs warning | **Confirmed** |
| 3 | Exception raised but caught | Exception in logs, generic error | No exception | No exception raised - code intentionally continues | Eliminated |

### Evidentiary Scaffold

**Code inspection at `src/clams/server/tools/ghap.py:104-114`**:
```python
# Check for active GHAP (warn but allow)
current = await collector.get_current()
if current is not None:
    # Log warning about orphaning previous entry
    logger.warning(
        "Starting new GHAP with active entry - previous entry orphaned",
        current_ghap_id=current.id,
        current_domain=current.domain.value,
        current_strategy=current.strategy.value,
    )
# ... continues to create new entry at line 117
```

**Evidence**: The comment on line 104 explicitly states "(warn but allow)" - this is intentional but incorrect behavior.

### Root Cause (Proven)

**The bug is caused by**: The `start_ghap` handler intentionally allows creating a new GHAP when one is already active, only logging a warning instead of returning a helpful error.

**Evidence**:
- Line 104 comment: "Check for active GHAP (warn but allow)"
- Lines 107-114: Only log a warning, do not return error
- Execution continues to line 117 to create new entry

**Why alternatives were eliminated**:
- Hypothesis 1 eliminated: Check exists at line 105 (`collector.get_current()`)
- Hypothesis 3 eliminated: No exception is raised - code explicitly continues

---

## Fix Plan

### Code Changes

1. **File**: `src/clams/server/tools/ghap.py` (or wherever start_ghap is implemented)
   **Function**: `start_ghap` tool handler
   **Change**: Check for active GHAP before creating new one; return specific error with active GHAP ID
   **Rationale**: Clear error messages help agents self-correct without confusion

### Regression Test

**Test file**: `tests/server/tools/test_bug_029_regression.py`

**Test should**:
1. Create a GHAP entry with start_ghap
2. Attempt to create another without resolving
3. Verify error type is `active_ghap_exists` (not `internal_error`)
4. Verify error message includes the active GHAP ID
5. Verify error message suggests resolution action

**Test outline**:
```python
async def test_bug_029_start_ghap_with_active_returns_helpful_error():
    # Setup: create an active GHAP
    result1 = await start_ghap(domain="debugging", ...)
    assert "id" in result1

    # Action: try to create another
    result2 = await start_ghap(domain="testing", ...)

    # Assert: get helpful error, not internal_error
    assert "error" in result2
    assert result2["error"]["type"] == "active_ghap_exists"
    assert result1["id"] in result2["error"]["message"]
    assert "resolve_ghap" in result2["error"]["message"]
```

### Verification

After implementing the fix:
```bash
# Run specific test
pytest tests/server/tools/test_bug_029_regression.py -xvs

# Run full test suite
pytest -xvs
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
