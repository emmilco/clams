# Bug Report: BUG-079

## Title
CollectionName.CODE ('code') vs CodeIndexer COLLECTION_NAME ('code_units') naming mismatch

## First Noticed On Commit
ea642437bf20283161b07cc1cd21f5f460d95cbb

## Reproduction Steps
1. Index a codebase: call the `index_codebase` MCP tool (writes to Qdrant collection `"code_units"`)
2. Call `search_code` MCP tool — this uses `src/calm/tools/code.py` which queries `"code_units"` directly → **works**
3. Call `Searcher.search_code()` from `src/calm/search/searcher.py` — this queries `CollectionName.CODE` which resolves to `"code"` → **fails with CollectionNotFoundError**

## Expected Behavior
All code paths that read/write the code collection should use the same collection name. `Searcher.search_code()` should successfully find code indexed by `CodeIndexer`.

## Actual Behavior
Two different names exist for the same collection:
- `CollectionName.CODE = "code"` in `src/calm/search/collections.py:14`
- `CodeIndexer.COLLECTION_NAME = "code_units"` in `src/calm/indexers/indexer.py:26`
- Hardcoded `"code_units"` strings in `src/calm/tools/code.py:123,127,131,260,339`
- Hardcoded `"code_units"` in `src/calm/orchestration/backups.py:40` (can't use `CollectionName.CODE` because it's wrong)

The `Searcher` uses `CollectionName.CODE` ("code") but the actual Qdrant collection is named "code_units". This means:
- `Searcher.search_code()` always raises `CollectionNotFoundError`
- `ContextAssembler` (which uses `Searcher`) cannot include code results
- The `search_code` and `find_similar_code` MCP tools bypass `Searcher` and query `"code_units"` directly, so they work

## Root Cause
The collection was originally named `"code_units"` in the CodeIndexer. When `CollectionName` was created as a centralized registry (SPEC-002-09), the code collection was registered as `"code"` instead of `"code_units"`. The MCP tool code in `src/calm/tools/code.py` was never updated to use `CollectionName.CODE` — it kept the hardcoded `"code_units"` strings, which is why the MCP tools work. The `Searcher` was built to use `CollectionName` constants, so it got the wrong name.

The backup system (`backups.py:40`) reveals the inconsistency clearly: it uses `CollectionName.*` for all collections except code, where it hardcodes `"code_units"` because using `CollectionName.CODE` would target a non-existent collection.

## Fix Plan

**Approach**: Update `CollectionName.CODE` from `"code"` to `"code_units"`, then replace all hardcoded `"code_units"` strings with `CollectionName.CODE`.

### Files to Change

1. **`src/calm/search/collections.py:14`** — Change `CODE = "code"` to `CODE = "code_units"`

2. **`src/calm/tools/code.py`** — Replace all hardcoded `"code_units"` with `CollectionName.CODE`:
   - Line 123: `name="code_units"` → `name=CollectionName.CODE`
   - Line 127: `name="code_units"` in log → `name=CollectionName.CODE`
   - Line 131: `name="code_units"` in log → `name=CollectionName.CODE`
   - Line 260: `collection="code_units"` → `collection=CollectionName.CODE`
   - Line 339: `collection="code_units"` → `collection=CollectionName.CODE`

3. **`src/calm/indexers/indexer.py:26`** — Replace `COLLECTION_NAME = "code_units"` with import and reference to `CollectionName.CODE`

4. **`src/calm/orchestration/backups.py:40`** — Replace hardcoded `"code_units"` with `CollectionName.CODE`

### Regression Test

Add a test that asserts `CollectionName.CODE == CodeIndexer.COLLECTION_NAME` to prevent future drift. Also verify that `ALL_COLLECTIONS` in backups uses only `CollectionName` constants (no hardcoded strings).

### Risk Assessment
- **Low risk**: This is a name constant change. The actual Qdrant collection name stays `"code_units"` — we're just fixing the constant to match reality.
- **No data migration needed**: The Qdrant collection is already named `"code_units"`.
- **Fixes a real bug**: `Searcher.search_code()` and `ContextAssembler` code search are currently broken.
