# BUG-062: Auto-detect project type in gate checks

## Reported

- **First noticed on commit**: Multiple sessions (see retrospective-2025-12-14.md Theme 5)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-14
- **Severity**: low

## Reproduction Steps

1. Gate check assumes Python project (looks for pyproject.toml, runs pytest, etc.)
2. Worker implements JavaScript/TypeScript/other language code
3. Gate check runs wrong tools or fails to find appropriate tools

**Expected**: Gate checks should auto-detect project type and run appropriate tools.
**Actual**: Gate checks are Python-centric and may fail or be irrelevant for other project types.

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
- Session 43763784: "Gate tried to run pytest on project with only shell scripts"
- Retrospective Theme 5: Gate checks need project type awareness

### Initial Hypothesis

Gate checks hardcode Python-specific tools without detecting project type.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | No project type detection | Always runs pytest | Runs appropriate tools | Reviewed claws-gate - hardcoded pytest | Confirmed |

### Root Cause (Proven)

**The bug is caused by**: Gate script assumes Python project and runs Python-specific tools without checking project type.

**Evidence**:
- `claws-gate` always runs `pytest`, `mypy`, `ruff`
- No detection of package.json, Cargo.toml, go.mod, etc.

---

## Fix Plan

### Code Changes

1. **File**: `.claude/bin/claws-common.sh`
   **Change**: Add project type detection function:
   ```bash
   detect_project_type() {
       # Check for explicit override in .claude/project.json
       # Auto-detect based on marker files (pyproject.toml, package.json, etc.)
   }
   ```

2. **File**: `.claude/bin/claws-gate`
   **Change**: Use project type to dispatch appropriate tools:
   - IMPLEMENT-CODE_REVIEW: Run language-appropriate checks
   - INVESTIGATED-FIXED: Run language-appropriate checks

### Regression Test

File: `tests/scripts/test_bug_062_regression.py`
- Tests all 4 language detections (Python, JavaScript, Rust, Go)
- Tests explicit project.json override
- Tests unknown project type fallback

---

## Implementation (filled by Implementer)

- **Implemented by**: W-1765734203-30706
- **Commit**: 25617a3
- **Regression test file**: tests/scripts/test_bug_062_regression.py

### Changes Made

1. Added `detect_project_type()` function to `claws-common.sh`:
   - Detects Python (pyproject.toml, setup.py, requirements.txt)
   - Detects JavaScript (package.json)
   - Detects Rust (Cargo.toml)
   - Detects Go (go.mod)
   - Supports explicit override via `.claude/project.json`

2. Updated `claws-gate` to use project type detection:
   - IMPLEMENT-CODE_REVIEW now dispatches appropriate checks by project type
   - INVESTIGATED-FIXED now runs language-appropriate checks and test patterns
   - Unknown project types get a warning with instructions

3. Added comprehensive regression test with 9 test cases.

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
