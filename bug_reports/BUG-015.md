# BUG-015: list_ghap_entries returns internal server error (regression)

## Reported

- **First noticed on commit**: 722c1b07ca0274746cdc7505599e7a87235fea4e
- **Reported by**: orchestrator
- **Reported at**: 2025-12-08T18:00:00Z
- **Severity**: high

## Reproduction Steps

1. Start the clams MCP server
2. Call `list_ghap_entries` tool with any parameters (e.g., `{"limit": 5}`)
3. Observe the response

**Expected**: A JSON response with a list of GHAP entries (or empty list if none exist)
**Actual**: `{"error": {"type": "internal_error", "message": "Internal server error"}}`

## Notes

- This was previously fixed in BUG-008 but appears to have regressed
- The `start_ghap`, `update_ghap`, and `get_active_ghap` tools work correctly
- Only `list_ghap_entries` and `resolve_ghap` fail in the GHAP tool group

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [X] Steps reproduced bug

**Observations during reproduction**:
The integration test for `list_ghap_entries` fails to start the server:
```
FileNotFoundError: [Errno 2] No such file or directory: '.venv/bin/learning-memory-server'
```

The test fixture in `tests/integration/test_mcp_protocol.py` line 74 references the old package name `learning-memory-server` instead of the new name `clams-server`.

However, when testing the tool function directly (without MCP protocol), it works correctly and returns proper results.

### Initial Hypothesis

The bug report title suggests `list_ghap_entries` returns an internal server error, but investigation reveals this is not a code bug - it's a test infrastructure bug. The actual tool function works correctly. The issue is that the SPEC-007 rename changed the entry point from `learning-memory-server` to `clams-server`, but the integration test fixture wasn't updated.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | BUG-008 fix was reverted during SPEC-007 rename | Code in ghap.py would have `vector_store = persister._vector_store` at module level (registration time) | Code would have it inside the function (call time) | Code has it inside function at line 503 (correct) | Eliminated |
| 2 | Persister's vector_store is None at call time | Manual test would fail with AttributeError | Manual test would succeed | Manual test succeeds, returns proper results | Eliminated |
| 3 | Integration test fixture references old command name | Test would fail with FileNotFoundError for 'learning-memory-server' | Test would run successfully | Test fails with FileNotFoundError at line 74 | Confirmed |

### Evidentiary Scaffold

**Logging/assertions added**:
None - not needed for this investigation. The bug is in test infrastructure, not product code.

**Test commands**:
```bash
# 1. Verify integration test fails with old command name
python -m pytest tests/integration/test_mcp_protocol.py::TestMCPToolDiscoveryRegression::test_list_ghap_entries_callable -xvs

# 2. Verify tool function works directly
python test_list_ghap_manual.py
```

**Captured output**:
```
# Integration test:
FileNotFoundError: [Errno 2] No such file or directory: '.venv/bin/learning-memory-server'

# Manual test:
Calling list_ghap_entries...
Result: {'results': [], 'count': 0}
SUCCESS: No error in result
Got 0 results
```

### Root Cause (Proven)

**The bug is caused by**: The integration test fixture in `tests/integration/test_mcp_protocol.py` line 74 references the old package entry point name `learning-memory-server` instead of the current name `clams-server`. This was missed during the SPEC-007 rename (commit 662f9ac).

**Evidence**:
1. The test fails with `FileNotFoundError: [Errno 2] No such file or directory: '.venv/bin/learning-memory-server'`
2. The `pyproject.toml` shows the correct entry point is `clams-server = "clams.server.main:main"`
3. The actual tool code works correctly when tested directly (no internal errors)
4. The BUG-008 fix is still present in the code (line 503 accesses `persister._vector_store` at call time, not registration time)

**Why alternatives were eliminated**:
- Hypothesis 1 (BUG-008 fix reverted) eliminated because: Code inspection shows `vector_store = persister._vector_store` is inside the `list_ghap_entries` function body at line 503, not at module level. This is the correct placement from the BUG-008 fix.
- Hypothesis 2 (vector_store is None) eliminated because: Manual testing of the tool function succeeds and returns proper results. If vector_store were None, we'd see an AttributeError, not success.

---

## Fix Plan

### Code Changes

1. **File**: `tests/integration/test_mcp_protocol.py`
   **Location**: Line 74
   **Change**: Update the server command from `".venv/bin/learning-memory-server"` to `".venv/bin/clams-server"`
   **Rationale**: This aligns the test fixture with the current package entry point name after the SPEC-007 rename. The correct entry point is defined in `pyproject.toml` as `clams-server = "clams.server.main:main"`.

### Regression Test

**Test file**: The existing test `tests/integration/test_mcp_protocol.py::TestMCPToolDiscoveryRegression::test_list_ghap_entries_callable` is already the regression test for BUG-008. Once we fix the fixture, this test will:

1. Start the MCP server using the correct `clams-server` command
2. Call the `list_ghap_entries` tool through the MCP protocol
3. Verify it returns results without an internal error
4. Fail if the BUG-008 issue regresses (if `vector_store` is accessed at registration time instead of call time)

The test was added in commit 0d8a46a specifically to catch this regression.

### Verification

After implementing the fix:
```bash
# Run the specific BUG-008 regression test
pytest tests/integration/test_mcp_protocol.py::TestMCPToolDiscoveryRegression::test_list_ghap_entries_callable -xvs

# Run all integration tests to ensure no other fixtures are broken
pytest tests/integration/ -xvs

# Clean up manual test file
rm test_list_ghap_manual.py
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
