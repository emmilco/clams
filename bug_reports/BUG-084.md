# Bug Report: BUG-084

## Title
Daemon uses sys.executable (global Python) instead of venv

## First Noticed On Commit
9eb86cd (main branch, 2026-02-12)

## Reproduction Steps
1. Install CALM into a virtualenv (e.g., `python -m venv .venv && source .venv/bin/activate && pip install -e .`)
2. Deactivate the venv (`deactivate`)
3. Run `calm server start` from global Python (outside the venv)
4. The daemon spawns using `sys.executable` which now points to the global Python interpreter
5. The global Python lacks CALM's dependencies (qdrant-client, sentence-transformers, etc.)
6. The daemon crashes with ImportError or protocol errors

## Expected Behavior
The daemon should detect and use the virtualenv Python interpreter that has CALM's dependencies installed, even when the CLI is invoked from a different Python.

## Actual Behavior
`daemon.py:start_daemon()` uses `sys.executable` directly, which points to whichever Python invoked the CLI. When that's the global/system Python, the spawned daemon process cannot import CALM's dependencies, causing protocol crashes from dependency drift.

The same issue exists in `hooks/session_start.py:ensure_server_running()` which also uses `sys.executable` to spawn the server.

## Root Cause

Two call sites use `sys.executable` to spawn CALM subprocesses without verifying that the interpreter has access to CALM's dependencies:

1. **`src/calm/server/daemon.py` line 72**: `start_daemon()` builds its command with `sys.executable` directly.
2. **`src/calm/hooks/session_start.py` line 45**: `ensure_server_running()` uses `sys.executable` to start the server.

When invoked from a global Python (not inside a virtualenv), `sys.executable` points to the system interpreter. The system interpreter typically does not have CALM's dependencies installed, causing the spawned process to crash on import.

### Differential Diagnosis

| Hypothesis | Evidence | Eliminated? |
|------------|----------|-------------|
| `sys.executable` always wrong | No -- works fine when run from inside the venv | Yes |
| Only affects daemon spawn | No -- `session_start.py` has the same pattern | Partially (both affected) |
| Missing `VIRTUAL_ENV` handling | `VIRTUAL_ENV` env var is set by venv activation but never checked | Root cause |
| Missing pyvenv.cfg detection | Python venvs place `pyvenv.cfg` in the venv root; never checked | Contributing factor |

### Why Other Uses of sys.executable Are Safe

Test files (`test_bug_082_regression.py`, `test_bug_042_regression.py`) also use `sys.executable` but these are safe because:
- Tests always run in the development environment where dependencies are installed
- They use `sys.executable` to run small inline scripts, not to spawn long-running daemons

## Fix Plan

1. Add `get_python_executable()` helper to `daemon.py` that resolves the correct Python:
   - Check `VIRTUAL_ENV` env var -> use `{VIRTUAL_ENV}/bin/python`
   - Check for `pyvenv.cfg` in parent dirs of `sys.executable`
   - Fall back to `sys.executable`
2. Update `daemon.py:start_daemon()` to use the helper
3. Update `session_start.py:ensure_server_running()` to use the helper
4. Add regression tests covering all three strategies
5. Add tests verifying both call sites use the helper
