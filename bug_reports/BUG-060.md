# BUG-060: Detect file overlaps when creating worktree

## Reported

- **First noticed on commit**: Multiple sessions (see retrospective-2025-12-14.md Theme 4)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-14
- **Severity**: medium

## Reproduction Steps

1. Have two tasks (TASK-A, TASK-B) that both need to modify the same file (e.g., `src/api.py`)
2. Create worktrees for both tasks in parallel
3. Both workers modify the same file
4. First merge succeeds, second merge has conflicts
5. Conflict resolution is error-prone and wastes time

**Expected**: When creating a worktree, detect if any existing worktrees have uncommitted changes to files the new task might touch (based on spec/proposal analysis).
**Actual**: No detection of potential overlaps, leading to merge conflicts.

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
- Session a4f3b7d1: "Two tasks both modified conftest.py, causing merge conflict"
- Session 8b91c3e2: "Worker spent 30 minutes resolving conflict that could have been avoided"
- Retrospective Theme 4: Worktree management includes parallel task conflicts

### Initial Hypothesis

No pre-check exists for potential file overlaps between worktrees.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | No overlap detection | Conflicts discovered at merge time | Warning at worktree create time | Reviewed claws-worktree - no overlap check | Confirmed |

### Root Cause (Proven)

**The bug is caused by**: `claws-worktree create` does not check for potential file overlaps with other active worktrees.

**Evidence**: Reviewed `.claude/bin/claws-worktree` - create function only creates branch, no analysis of potential conflicts.

---

## Fix Plan

### Code Changes

1. **File**: `.claude/bin/claws-worktree`
   **Function**: create section
   **Change**: Add optional overlap detection:
   ```bash
   claws-worktree create TASK-002 --check-overlaps

   # Output:
   # WARNING: Potential overlap with active worktrees:
   #   BUG-042: modifying src/api.py (uncommitted changes)
   #   SPEC-001-02: mentions src/api.py in proposal
   #
   # Recommend: Complete or merge BUG-042 before starting TASK-002
   # Continue anyway? [y/N]
   ```

   **Detection methods**:
   - Check uncommitted changes in all worktrees
   - Parse spec.md/proposal.md for file mentions
   - Check git diff of each worktree

2. **File**: `.claude/bin/claws-worktree`
   **Change**: Add `--force` flag to bypass warning

### Implementation Notes

```bash
# Pseudocode for overlap detection
check_overlaps() {
    new_task=$1

    # Get files mentioned in new task's spec/proposal
    mentioned_files=$(grep -hE "src/|tests/" planning_docs/$new_task/*.md 2>/dev/null | sort -u)

    # Check each existing worktree
    for worktree in .worktrees/*; do
        task_id=$(basename "$worktree")
        [ "$task_id" = "$new_task" ] && continue

        # Check uncommitted changes
        cd "$worktree"
        changed_files=$(git diff --name-only; git diff --cached --name-only)

        # Check for overlaps
        for file in $changed_files; do
            if echo "$mentioned_files" | grep -q "$file"; then
                echo "WARNING: $task_id has uncommitted changes to $file"
            fi
        done
    done
}
```

### Regression Test

Manual verification:
1. Create worktree A, modify file X
2. Create worktree B with spec mentioning file X
3. Verify warning is shown
4. Verify `--force` bypasses warning

### Verification

After implementing the fix:
```bash
# Test overlap detection
.claude/bin/claws-worktree create TEST-002 --check-overlaps

# Test force bypass
.claude/bin/claws-worktree create TEST-002 --force
```

---

## Implementation (filled by Implementer)

- **Implemented by**: W-1765692193-89119
- **Commit**: 8bef232
- **Regression test file**: `tests/scripts/test_bug_060_worktree_overlaps.py`

### Changes Made

1. **`.claude/bin/claws-worktree`**:
   - Modified `cmd_create()` to parse `--check-overlaps` and `--force` flags
   - Added overlap detection logic that calls `check_overlaps()` before creating worktree
   - Shows confirmation prompt when overlaps are detected (unless `--force` is used)
   - Rewrote `check_overlaps()` function to:
     - Scan all existing worktrees for uncommitted changes (via `git diff`)
     - Scan planning docs and bug reports for file mentions
     - Report active modifications with task IDs
     - Provide recommendations for resolving potential conflicts

2. **`tests/scripts/test_bug_060_worktree_overlaps.py`**:
   - Added 9 regression tests verifying the overlap detection implementation:
     - `--check-overlaps` flag is supported
     - `--force` flag is supported
     - `check_overlaps()` function exists
     - Uncommitted changes are checked
     - Planning docs are scanned
     - Confirmation prompt is shown
     - `--force` bypasses confirmation
     - All worktrees are iterated
     - Task IDs are reported in warnings

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
