# BUG-033: mcp_client.py spawns new MCP server process instead of using existing one

## Reported

- **First noticed on commit**: fd6b43e
- **Reported by**: orchestrator
- **Reported at**: 2025-12-11
- **Severity**: high

## Reproduction Steps

1. Start Claude Code with CLAMS MCP server running
2. Trigger a hook that calls mcp_client.py (e.g., session start)
3. Observe process list or timing

**Expected**: Hook connects to the already-running MCP server that Claude Code uses
**Actual**: Hook spawns a NEW MCP server process via python -m clams

## Observations

In .claude/hooks/mcp_client.py line 131-133:
```python
client = MCPClient(
    server_command=["python", "-m", "clams"], timeout=10.0
)
```

This spawns a new server process instead of connecting to the existing one.

Additional issues:
- Uses system python instead of venv Python
- Entry point naming inconsistency: clams-server (pyproject.toml) vs python -m clams (mcp_client.py)
- No src/clams/__main__.py exists to support python -m clams

This bug is likely the root cause of BUG-032 (slow hook startup). Fixing this should also fix BUG-032.

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:

Examined the code at .claude/hooks/mcp_client.py line 131-133:
```python
client = MCPClient(
    server_command=["python", "-m", "clams"], timeout=10.0
)
```

Key findings:
1. The stdio_client function from mcp.client.stdio spawns a subprocess using StdioServerParameters. This is by design - MCP stdio clients communicate with servers via stdin/stdout of a spawned process.
2. The command ["python", "-m", "clams"] is incorrect:
   - Uses system python instead of venv Python (where dependencies are installed)
   - Attempts to run python -m clams but no src/clams/__main__.py exists
   - The correct entry point is clams-server (defined in pyproject.toml line 46)
3. The integration tests at tests/integration/test_mcp_protocol.py line 73-74 use the correct approach:
   ```python
   server_params = StdioServerParameters(
       command=".venv/bin/clams-server",
       args=[],
   )
   ```

### Initial Hypothesis

The bug is a configuration error: the MCP client uses an incorrect server command that:
1. Does not use the venv Python where CLAMS is installed
2. Tries to invoke a module entry point (python -m clams) that does not exist

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | Command uses wrong entry point | No __main__.py in src/clams/ | __main__.py exists and works | Glob search found no __main__.py files | **CONFIRMED** |
| 2 | Should connect to existing server instead of spawning | MCP has HTTP/SSE transport for connecting to running servers | stdio transport is the only/correct way | stdio is the standard MCP transport; no alternative client exists | **Eliminated** - stdio is correct for hooks |
| 3 | pyproject.toml entry point is different | Entry point mismatch | Entry point matches | pyproject.toml line 46: clams-server = "clams.server.main:main" | **CONFIRMED** - mismatch exists |
| 4 | Tests use different command | Tests pass with different command | Tests use same command | Integration tests use .venv/bin/clams-server successfully | **CONFIRMED** |

### Evidentiary Scaffold

**Code examination** (no logging needed - static analysis):

1. **mcp_client.py lines 131-133**: Uses ["python", "-m", "clams"]
2. **pyproject.toml line 46**: Defines clams-server = "clams.server.main:main"
3. **tests/integration/test_mcp_protocol.py line 74**: Uses .venv/bin/clams-server
4. **Glob for __main__.py**: No __main__.py found in src/clams/

**Evidence from SPEC-002-19 proposal**:
- Original proposal (planning_docs/SPEC-002-19/proposal.md line 248) used ["python", "-m", "learning_memory_server"]
- During SPEC-007 rename, line 116 shows the plan to update to ["python", "-m", "clams"]
- However, no __main__.py was ever created to support this invocation

### Root Cause (Proven)

**The bug is caused by**: Two configuration errors in .claude/hooks/mcp_client.py:

1. **Wrong Python interpreter**: Uses bare python which resolves to system Python (3.13.6 per pyenv), not the venv Python where CLAMS and dependencies are installed.

2. **Non-existent module entry point**: Uses python -m clams but:
   - No src/clams/__main__.py file exists to support -m invocation
   - The correct entry point is clams-server (a console script defined in pyproject.toml)

**Evidence**:
- Glob search confirms no __main__.py in the codebase
- pyproject.toml defines only clams-server entry point
- Integration tests prove .venv/bin/clams-server works correctly
- config.yaml at line 45 also references incorrect command: ["python", "-m", "learning_memory_server"] (stale from before rename)

**Why alternatives were eliminated**:
- Hypothesis 2 (connect to existing server): Eliminated because MCP stdio transport is the correct architecture for hook scripts. Each hook invocation is short-lived and spawning a server per call is the intended design. The slowness is a separate concern (BUG-032) that could be addressed with HTTP transport in the future, but not a bug in the current design.

---

## Fix Plan

### Code Changes

1. **File**: .claude/hooks/mcp_client.py
   **Function**: main() (line 131-133)
   **Change**: Update server command from ["python", "-m", "clams"] to use the correct venv binary path
   ```python
   # Before:
   client = MCPClient(
       server_command=["python", "-m", "clams"], timeout=10.0
   )

   # After:
   # Get the repo root (hooks are in .claude/hooks/)
   import os
   script_dir = os.path.dirname(os.path.abspath(__file__))
   repo_root = os.path.dirname(os.path.dirname(script_dir))
   clams_server = os.path.join(repo_root, ".venv", "bin", "clams-server")

   client = MCPClient(
       server_command=[clams_server], timeout=10.0
   )
   ```
   **Rationale**: Uses the installed clams-server binary from the venv, matching how integration tests successfully invoke the server.

2. **File**: .claude/hooks/config.yaml
   **Section**: mcp.server_command (line 45)
   **Change**: Update from ["python", "-m", "learning_memory_server"] to match the corrected mcp_client.py
   ```yaml
   # Before:
   mcp:
     server_command: ["python", "-m", "learning_memory_server"]

   # After:
   mcp:
     # Note: This config is currently not used - mcp_client.py has hardcoded path
     # If config-based command is implemented, use: [".venv/bin/clams-server"]
     server_command: [".venv/bin/clams-server"]
   ```
   **Rationale**: Keeps config in sync even though mcp_client.py currently does not read it.

3. **File**: tests/hooks/test_mcp_client.py
   **Function**: test_init() (line 29-31)
   **Change**: Update test to use correct command pattern
   **Rationale**: Tests should reflect the actual configuration.

### Regression Test

**Test file**: tests/hooks/test_bug_033_regression.py

**Test should**:
1. Verify the server command in mcp_client.py uses the correct binary path
2. Verify the command does not use python -m clams
3. Verify the path construction is correct for the repo structure

**Test outline**:
```python
"""Regression test for BUG-033: mcp_client.py uses wrong server command."""

import os
import sys
from pathlib import Path

import pytest


class TestBug033Regression:
    """Tests for BUG-033 fix: correct MCP server command."""

    def test_server_command_uses_venv_binary(self) -> None:
        """Verify mcp_client uses .venv/bin/clams-server, not python -m clams."""
        # Import the module to check the actual command construction
        hooks_dir = Path(__file__).parent.parent.parent / ".claude" / "hooks"
        sys.path.insert(0, str(hooks_dir))

        # Read the source file and check for correct pattern
        mcp_client_path = hooks_dir / "mcp_client.py"
        source = mcp_client_path.read_text()

        # Should NOT contain the buggy pattern
        assert '["python", "-m", "clams"]' not in source, (
            "BUG-033 REGRESSION: mcp_client.py still uses python -m clams"
        )

        # Should contain reference to clams-server binary
        assert "clams-server" in source, (
            "mcp_client.py should reference clams-server binary"
        )

    def test_server_command_path_is_absolute(self) -> None:
        """Verify the server command constructs an absolute path."""
        hooks_dir = Path(__file__).parent.parent.parent / ".claude" / "hooks"
        mcp_client_path = hooks_dir / "mcp_client.py"
        source = mcp_client_path.read_text()

        # Should construct path relative to repo root
        assert ".venv" in source and "bin" in source, (
            "mcp_client.py should construct path to .venv/bin/"
        )
```

### Verification

After implementing the fix:
```bash
# Run specific regression test
pytest tests/hooks/test_bug_033_regression.py -xvs

# Run all hook tests
pytest tests/hooks/ -xvs

# Run full test suite
pytest -xvs
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
