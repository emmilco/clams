# BUG-043: Qdrant collections not auto-created on first use

## Reported

- **First noticed on commit**: bb517737532f5d6995c398273333373001753643
- **Reported by**: orchestrator
- **Reported at**: 2025-12-13T03:16:00Z
- **Severity**: medium

## Reproduction Steps

1. Start fresh with no Qdrant collections (or delete existing ones)
2. Call `store_memory` tool with valid parameters
3. Observe error response

**Expected**: The `memories` collection is auto-created and the memory is stored successfully.

**Actual**: Returns error: `Unexpected Response: 404 (Not Found) - Collection 'memories' doesn't exist!`

Same issue affects:
- `memories` collection (used by memory tools)
- `commits` collection (used by git indexing tools)
- `values` collection (used by clustering/value tools)

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
Code inspection confirms the issue. When Qdrant collections don't exist:
- `store_memory` calls `services.vector_store.upsert(collection="memories", ...)` on line 92 of `src/clams/server/tools/memory.py`
- Qdrant raises `UnexpectedResponse: 404 (Not Found)` because the collection doesn't exist
- Same issue occurs for `commits` collection in `GitAnalyzer._upsert_commit()` and `values` collection in `ValueStore.store_value()`

### Initial Hypothesis

The `memories`, `commits`, and `values` collections are never created during server initialization or lazily on first use. While BUG-016 fixed this for GHAP collections by adding `await observation_persister.ensure_collections()` to server startup (line 880 of `__init__.py`), and `CodeIndexer` has `_ensure_collection()` pattern, these three collections have no initialization mechanism.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | Collections never created - no ensure_collections() pattern | Qdrant 404 error on first upsert | Different error or success | Code inspection: no `ensure_collections()` or `_ensure_collection()` in `memory.py`, `analyzer.py`, or `store.py` | **Confirmed** |
| 2 | Collections created at startup but not working | Collections exist in Qdrant, different error | 404 error | Code inspection: `initialize_services()` only creates QdrantVectorStore, no collection creation | Eliminated |
| 3 | Qdrant client auto-creates collections | Success on first upsert | 404 error | Bug report confirms 404 error | Eliminated |
| 4 | Only affects certain tools | Some tools work, others fail | All three collections fail | Code inspection: all three collections have same missing pattern | **Confirmed (all three affected)** |

### Evidentiary Scaffold

**Code inspection performed** (no runtime scaffold needed - code path analysis is sufficient):

1. **Memory tools** (`src/clams/server/tools/memory.py`):
   - Line 92: `await services.vector_store.upsert(collection="memories", ...)`
   - No `ensure_collections()` call anywhere in memory.py or initialization
   - Collection name hardcoded as `"memories"`

2. **Git analyzer** (`src/clams/git/analyzer.py`):
   - Line 282: `await self.vector_store.upsert(collection="commits", ...)`
   - No `_ensure_collection()` method exists in GitAnalyzer
   - Collection name hardcoded as `"commits"`

3. **Value store** (`src/clams/values/store.py`):
   - Line 278: `await self.vector_store.upsert(collection=VALUES_COLLECTION, ...)`
   - `VALUES_COLLECTION = "values"` (line 23)
   - No `_ensure_collection()` method exists in ValueStore

4. **Contrast with working implementations**:
   - `CodeIndexer` (line 39): has `async def _ensure_collection(self)` called at lines 96, 255
   - `ObservationPersister` (line 128): has `async def ensure_collections(self)` called at startup (line 880 of `__init__.py`)

**Search command**:
```bash
grep -n "ensure_collections\|_ensure_collection" src/clams/**/*.py
```

**Result**: Only found in `indexers/indexer.py` and `observation/persister.py`, NOT in `memory.py`, `git/analyzer.py`, or `values/store.py`.

### Root Cause (Proven)

**The bug is caused by**: Missing collection auto-creation for `memories`, `commits`, and `values` collections.

**Location**:
- `src/clams/server/tools/memory.py` - memory tools
- `src/clams/git/analyzer.py` - git indexing tools
- `src/clams/values/store.py` - value store tools

**Evidence**:
1. Code inspection shows no `ensure_collections()` or `_ensure_collection()` pattern for these three domains
2. Memory tools directly call `vector_store.upsert()` without ensuring collection exists
3. GitAnalyzer directly calls `vector_store.upsert()` without ensuring collection exists
4. ValueStore directly calls `vector_store.upsert()` without ensuring collection exists
5. BUG-016 fix added `ensure_collections()` call for GHAP collections at server startup (line 880), proving the pattern works
6. CodeIndexer uses `_ensure_collection()` lazy pattern, proving the alternative pattern works

**Why alternatives were eliminated**:
- Hypothesis 2 eliminated: `initialize_services()` (lines 66-165 in `__init__.py`) creates `QdrantVectorStore` but never calls any collection creation
- Hypothesis 3 eliminated: Qdrant does NOT auto-create collections on upsert (returns 404)

---

## Fix Plan

### Code Changes

There are two approaches. Choose **Approach A** for consistency with existing patterns:

#### Approach A: Lazy Creation (Consistent with CodeIndexer pattern)

1. **File**: `src/clams/server/tools/memory.py`
   **Function**: Add `ensure_memories_collection()` helper and call it before operations
   **Change**: Add lazy collection creation before first upsert/search/scroll
   **Rationale**: Consistent with CodeIndexer pattern, collection created on first use

2. **File**: `src/clams/git/analyzer.py`
   **Function**: Add `_ensure_commits_collection()` method to `GitAnalyzer`
   **Change**: Call before `index_commits()` and `search_commits()`
   **Rationale**: Consistent with CodeIndexer pattern

3. **File**: `src/clams/values/store.py`
   **Function**: Add `_ensure_values_collection()` method to `ValueStore`
   **Change**: Call before `store_value()` and `list_values()`
   **Rationale**: Consistent with CodeIndexer pattern

#### Approach B: Startup Creation (Consistent with GHAP pattern)

1. **File**: `src/clams/server/tools/__init__.py`
   **Function**: `register_all_tools()`
   **Change**: Add collection creation calls after line 880 for `memories`, `commits`, `values`
   **Rationale**: All collections exist immediately on server startup

**Recommended**: Approach A (lazy creation) because:
- More consistent with the majority of existing code (CodeIndexer)
- Avoids startup slowdown if collections aren't needed
- Self-contained within each module

### Specific Changes for Approach A

**1. Memory tools** (`src/clams/server/tools/memory.py`):
```python
# Add at module level after VALID_CATEGORIES
_memories_collection_ensured = False

async def _ensure_memories_collection(services: ServiceContainer) -> None:
    """Ensure memories collection exists."""
    global _memories_collection_ensured
    if _memories_collection_ensured:
        return
    try:
        await services.vector_store.create_collection(
            name="memories",
            dimension=services.semantic_embedder.dimension,
            distance="cosine",
        )
    except Exception as e:
        if "already exists" not in str(e).lower() and "409" not in str(e):
            raise
    _memories_collection_ensured = True

# Call at start of store_memory(), retrieve_memories(), list_memories()
```

**2. Git analyzer** (`src/clams/git/analyzer.py`):
```python
# Add to GitAnalyzer class
_collection_ensured: bool = False

async def _ensure_commits_collection(self) -> None:
    """Ensure commits collection exists."""
    if self._collection_ensured:
        return
    try:
        await self.vector_store.create_collection(
            name="commits",
            dimension=self.embedding_service.dimension,
            distance="cosine",
        )
    except Exception as e:
        if "already exists" not in str(e).lower() and "409" not in str(e):
            raise
    self._collection_ensured = True

# Call at start of index_commits(), search_commits()
```

**3. Value store** (`src/clams/values/store.py`):
```python
# Add to ValueStore class
_collection_ensured: bool = False

async def _ensure_values_collection(self) -> None:
    """Ensure values collection exists."""
    if self._collection_ensured:
        return
    try:
        await self.vector_store.create_collection(
            name=VALUES_COLLECTION,
            dimension=self.embedding_service.dimension,
            distance="cosine",
        )
    except Exception as e:
        if "already exists" not in str(e).lower() and "409" not in str(e):
            raise
    self._collection_ensured = True

# Call at start of store_value(), list_values()
```

### Regression Test

**Test file**: `tests/server/test_bug_043_regression.py`

**Test should**:
1. Create fresh in-memory VectorStore (no collections)
2. Call store_memory without pre-creating collection
3. Verify the memory is stored successfully
4. Repeat for commits and values collections

**Test outline**:
```python
import pytest
from unittest.mock import AsyncMock, MagicMock

from clams.server.tools.memory import get_memory_tools
from clams.server.tools import ServiceContainer


@pytest.fixture
def fresh_vector_store() -> AsyncMock:
    """Vector store with no collections."""
    store = AsyncMock()
    store.create_collection = AsyncMock()
    store.upsert = AsyncMock()
    return store


@pytest.fixture
def mock_embedder() -> MagicMock:
    """Mock embedding service."""
    embedder = MagicMock()
    embedder.dimension = 768
    embedder.embed = AsyncMock(return_value=[0.0] * 768)
    return embedder


@pytest.mark.asyncio
async def test_bug_043_store_memory_creates_collection(
    fresh_vector_store: AsyncMock,
    mock_embedder: MagicMock,
) -> None:
    """Test that store_memory creates collection if it doesn't exist.

    Regression test for BUG-043: Collections should be auto-created on first use.
    """
    # Setup: ServiceContainer with fresh vector store
    services = ServiceContainer(
        code_embedder=mock_embedder,
        semantic_embedder=mock_embedder,
        vector_store=fresh_vector_store,
        metadata_store=AsyncMock(),
    )

    # Get memory tools
    tools = get_memory_tools(services)

    # Action: store a memory (should auto-create collection)
    result = await tools["store_memory"](
        content="Test memory content",
        category="fact",
    )

    # Assert: collection was created before upsert
    fresh_vector_store.create_collection.assert_called_once_with(
        name="memories",
        dimension=768,
        distance="cosine",
    )

    # Assert: memory was stored
    fresh_vector_store.upsert.assert_called_once()
    assert "id" in result
    assert result["content"] == "Test memory content"
```

### Verification

After implementing the fix:
```bash
# Run specific regression test
pytest tests/server/test_bug_043_regression.py -xvs

# Run memory tool tests
pytest tests/server/test_memory.py -xvs

# Run git analyzer tests
pytest tests/git/test_analyzer.py -xvs

# Run value store tests
pytest tests/values/test_store.py -xvs

# Run full test suite
pytest -xvs
```

---

## Implementation (filled by Implementer)

- **Implemented by**: W-1765596918-44224
- **Commit**: 085007f
- **Regression test file**: tests/server/test_bug_043_regression.py

### Changes Made

Implemented Approach A (lazy creation) as recommended in the fix plan:

1. **memory.py** (`src/clams/server/tools/memory.py`):
   - Added module-level `_memories_collection_ensured` flag
   - Added `_ensure_memories_collection(services)` helper function
   - Call before `store_memory`, `retrieve_memories`, `list_memories`

2. **analyzer.py** (`src/clams/git/analyzer.py`):
   - Added instance-level `_collection_ensured` attribute
   - Added `_ensure_commits_collection()` method
   - Call before `index_commits` and `search_commits`

3. **store.py** (`src/clams/values/store.py`):
   - Added instance-level `_collection_ensured` attribute
   - Added `_ensure_values_collection()` method
   - Call before `store_value` and `list_values`

All implementations follow the pattern from `CodeIndexer._ensure_collection()`:
- Check cached flag first (fast path)
- Try to create collection
- Catch "already exists" or "409" errors gracefully
- Set cached flag to avoid repeated creation attempts

### Regression Test

Created `tests/server/test_bug_043_regression.py` with 10 tests:
- 6 tests for memories collection (store, retrieve, list, caching, error handling)
- 2 tests for commits collection (index, search)
- 2 tests for values collection (store, list)

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
