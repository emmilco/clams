# BUG-057: Investigate worker agent permission model

## Reported

- **First noticed on commit**: Multiple sessions (see retrospective-2025-12-14.md Theme 3)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-14
- **Severity**: high

## Reproduction Steps

1. Dispatch a worker agent to operate in a worktree
2. Worker can potentially run commands outside worktree scope
3. Worker lacks explicit sandboxing/permission constraints

**Expected**: Workers should have clearly defined permissions - which files they can modify, which commands they can run, which directories are off-limits.
**Actual**: Workers operate with full agent permissions, no explicit constraints documented or enforced.

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
- Session 43763784: Worker modified files outside its designated worktree
- Session c97d59ea: Workers had unclear boundaries about what they could modify
- Retrospective Theme 3: "Worker permission model unclear" identified as friction point

### Initial Hypothesis

No permission model exists for worker agents - they inherit full Claude Code permissions without worktree-specific constraints.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | No explicit permission model | Workers can modify anything | Clear permission errors | Reviewed CLAUDE.md and roles - no permission constraints | Confirmed |
| 2 | Worktree isolation not enforced | Workers edit main repo files | Workers constrained to worktree | Multiple sessions show cross-worktree edits | Confirmed |

### Root Cause (Proven)

**The bug is caused by**: No explicit permission model for worker agents. Workers are dispatched with task context but no technical enforcement of scope boundaries.

**Evidence**:
- CLAUDE.md defines specialist roles but not permission boundaries
- Worker prompts don't include explicit file/directory restrictions
- No mechanism exists to constrain agent tool calls to worktree scope

---

## Fix Plan

### Code Changes

This is an investigation task to design the permission model. Implementation will follow in separate tasks.

1. **Research Phase**:
   - Document current worker capabilities and implicit constraints
   - Identify risk categories (file access, command execution, network access)
   - Review Claude Code permission model options

2. **Design Phase** (outputs to `docs/worker-permission-model.md`):
   - Define permission levels (read-only, worktree-write, main-write)
   - Define directory constraints per role
   - Define command allowlists per role
   - Define escalation procedures for permission upgrades

3. **Proposed Permission Categories**:
   ```
   WORKTREE_ONLY:
   - Can read any file in repo
   - Can write ONLY in .worktrees/{task_id}/
   - Cannot run commands that affect main repo

   WORKTREE_PLUS_MAIN_READ:
   - Can read any file
   - Can write in worktree
   - Can read main repo state (git log, etc.)

   FULL_ACCESS (orchestrator only):
   - Can read/write anywhere
   - Can run any command
   - Required for merge operations
   ```

4. **File**: `.claude/roles/*.md`
   **Change**: Add permission section to each role specifying:
   - File access scope
   - Allowed commands
   - Prohibited actions

5. **File**: `.claude/bin/claws-worker`
   **Change**: Generate worker prompts that include explicit permission constraints

### Investigation Deliverables

**Output file**: `docs/worker-permission-model.md`

**Should include**:
1. Current state analysis
2. Risk assessment
3. Proposed permission model
4. Implementation roadmap
5. Migration plan for existing roles

### Verification

After investigation complete:
- [ ] Permission model document exists
- [ ] All roles have permission annotations
- [ ] Escalation procedures documented
- [ ] Implementation tasks identified

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
