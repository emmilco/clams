# BUG-011: search_commits returns empty results

## Reported

- **First noticed on commit**: fac4624 (main)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-07
- **Severity**: low

## Reproduction Steps

1. Start the learning-memory-server MCP server
2. Call the `search_commits` tool:
   ```json
   {
     "query": "bug fix",
     "limit": 3
   }
   ```
3. Observe the response

**Expected**: A list of commits matching the semantic search query

**Actual**: Returns `{"results": [], "count": 0}` even though the repository has many commits with bug fixes

## Technical Details

Other git tools work correctly:
- `get_file_history` - works (returns commit history for files)
- `get_churn_hotspots` - works (returns file change statistics)
- `get_code_authors` - works (returns author statistics)

Tried multiple queries:
- `"bug fix"` - empty
- `"add feature implementation"` - empty

The issue may be that commits need to be indexed into the vector store before semantic search works, similar to how `index_codebase` must be called before `search_code` works.

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
- The `search_commits` tool is exposed in the MCP server's tool list
- The GitAnalyzer.search_commits() method exists and is correctly implemented
- Other git tools (get_file_history, get_churn_hotspots, get_code_authors) work because they query git directly, not the vector store
- The VectorStore search in GitAnalyzer.search_commits() queries the "commits" collection

### Initial Hypothesis

Commits are not being indexed into the vector store, so semantic search has no data to search against.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | Commits not indexed - no `index_commits` MCP tool exists | No tool to call before searching | An `index_commits` tool in tool list | Tool list has `index_codebase` but NOT `index_commits` | CONFIRMED |
| 2 | GitAnalyzer.search_commits() has a bug | Code would fail or error | Code executes, returns empty | Code is correct, searches vector store properly | ELIMINATED |
| 3 | VectorStore "commits" collection doesn't exist | Search would error (collection not found) | Search succeeds with empty results | Search succeeds, returns `{"results": [], "count": 0}` | ELIMINATED |
| 4 | Other git tools work by different mechanism | Other tools query vector store too | Other tools query git directly | get_file_history calls `git_reader.get_file_history()` (git directly) | CONFIRMED |

### Root Cause (Proven)

**Root Cause**: The `index_commits` MCP tool is missing. While the GitAnalyzer has an `index_commits()` method (lines 55-157 in analyzer.py), there is NO corresponding MCP tool exposed to users.

**Evidence**:
1. Tool list check: Examined `src/learning_memory_server/server/tools/__init__.py` - found `index_codebase` tool for code indexing but NO `index_commits` tool for commit indexing
2. Code pattern: The code tool has both `index_codebase` (to populate vector store) and `search_code` (to query it)
3. Git tools: The git tools only expose `search_commits` without a corresponding indexing tool
4. Search behavior: GitAnalyzer.search_commits() at line 310-365 searches the "commits" collection in the vector store, which is empty because it was never populated
5. Other git tools work: get_file_history, get_churn_hotspots, and get_code_authors all query git history directly via GitReader, not the vector store

**Why the asymmetry exists**:
- Code tools: `index_codebase` → populates vector store → `search_code` queries it ✓
- Git tools: ❌ missing tool → empty vector store → `search_commits` returns empty []

**Comparison with working tools**:
- `get_file_history`: Calls `git_reader.get_file_history()` - queries git directly
- `get_churn_hotspots`: Calls `git_reader.get_commits()` - queries git directly
- `get_code_authors`: Calls `git_reader.get_file_history()` - queries git directly
- `search_commits`: Calls `vector_store.search(collection="commits")` - queries vector store (empty)

---

## Fix Plan

### Code Changes

**1. Add `index_commits` tool definition to `src/learning_memory_server/server/tools/__init__.py`**

In the `_get_all_tool_definitions()` function, add a new Tool definition for `index_commits` after the existing git tools. Pattern should match the `index_codebase` tool:

```python
Tool(
    name="index_commits",
    description="Index git commits for semantic search.",
    inputSchema={
        "type": "object",
        "properties": {
            "since": {
                "type": "string",
                "description": "Optional date filter (ISO format YYYY-MM-DD)",
            },
            "limit": {
                "type": "integer",
                "description": "Optional max commits to index (default: all from last 5 years)",
            },
            "force": {
                "type": "boolean",
                "description": "Force reindex all commits (default: false, incremental)",
                "default": False,
            },
        },
        "required": [],
    },
)
```

**2. Add `index_commits` implementation to `src/learning_memory_server/server/tools/git.py`**

In the `get_git_tools()` function, add the implementation:

```python
async def index_commits(
    since: str | None = None,
    limit: int | None = None,
    force: bool = False,
) -> dict[str, Any]:
    """Index git commits for semantic search.

    Args:
        since: Optional date filter (ISO format YYYY-MM-DD)
        limit: Optional max commits to index
        force: Force reindex all commits (default: incremental)

    Returns:
        Indexing statistics

    Raises:
        ValidationError: If parameters are invalid
        MCPError: If indexing fails or GitAnalyzer not available
    """
    logger.info("git.index_commits", since=since, limit=limit, force=force)

    # Check if git analyzer is available
    if not services.git_analyzer:
        raise MCPError(
            "Git commit indexing not available. "
            "GitAnalyzer service not initialized."
        )

    # Parse date if provided
    since_dt = None
    if since:
        try:
            since_dt = datetime.fromisoformat(since)
        except ValueError as e:
            raise ValidationError(
                f"Invalid date format '{since}'. Use ISO format: YYYY-MM-DD"
            ) from e

    # Validate limit if provided
    if limit is not None and limit < 1:
        raise ValidationError(f"Limit must be positive, got {limit}")

    try:
        # Delegate to GitAnalyzer
        stats = await services.git_analyzer.index_commits(
            since=since_dt,
            limit=limit,
            force=force,
        )

        # Format response
        return {
            "commits_indexed": stats.commits_indexed,
            "commits_skipped": stats.commits_skipped,
            "duration_ms": stats.duration_ms,
            "errors": [
                {
                    "sha": e.sha,
                    "error_type": e.error_type,
                    "message": e.message,
                }
                for e in stats.errors
            ],
        }

    except Exception as e:
        logger.error("git.index_commits_failed", error=str(e), exc_info=True)
        raise MCPError(f"Failed to index commits: {e}") from e
```

**3. Register the tool in the tool registry**

Add `"index_commits": index_commits` to the return dictionary in `get_git_tools()`.

### Regression Test

**Test file**: `tests/server/tools/test_git.py`

Add a test that verifies the index-then-search workflow:

```python
async def test_index_and_search_commits_workflow():
    """Test that commits must be indexed before they can be searched."""
    # Setup: Create git analyzer with mock services
    # ...

    # 1. Search before indexing - should return empty
    results_before = await search_commits(query="test", limit=5)
    assert results_before["count"] == 0
    assert results_before["results"] == []

    # 2. Index commits
    index_stats = await index_commits(force=True)
    assert index_stats["commits_indexed"] > 0

    # 3. Search after indexing - should find results
    results_after = await search_commits(query="test", limit=5)
    assert results_after["count"] > 0
    # Verify results have expected structure
    for commit in results_after["results"]:
        assert "sha" in commit
        assert "message" in commit
        assert "author" in commit
```

**Additional test**: Verify incremental indexing works correctly (index once, add commits, index again without force flag).

### Verification

**Manual verification steps**:

1. Start the MCP server
2. Call `index_commits` with `force=true` to populate the vector store
3. Verify indexing stats show commits_indexed > 0
4. Call `search_commits` with query "bug fix"
5. Verify results are returned (not empty)
6. Compare with `get_file_history` to verify the commits actually exist

**Automated verification**:
- Run the regression test suite
- Verify all existing git tool tests still pass
- Verify the new `test_index_and_search_commits_workflow` passes

---

## Implementation (filled by Implementer)

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
