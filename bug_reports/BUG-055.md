# BUG-055: Mark and exclude slow tests

## Reported

- **First noticed on commit**: Multiple sessions (see retrospective-2025-12-14.md Theme 2)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-14
- **Severity**: medium

## Reproduction Steps

1. Run full test suite
2. Observe tests that take >15 seconds
3. Gate checks take unnecessarily long for quick feedback

**Expected**: Slow tests (>15s) are marked with `@pytest.mark.slow` and excluded from default gate runs.
**Actual**: All tests run by default, making gate checks slow.

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
- Session f324d9e6: "test_bug_014_large_indexing_completes takes 1.5 minutes"
- Various tests loading ML models take significant time

### Initial Hypothesis

No consistent marking of slow tests, no pytest configuration to exclude them by default.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | No slow marker configured | All tests run | Slow tests excluded | Checked pyproject.toml - no slow marker | Confirmed |

### Root Cause (Proven)

**The bug is caused by**: No `@pytest.mark.slow` marker configured and no default exclusion.

**Evidence**: pyproject.toml has no slow marker defined, all tests run by default.

---

## Fix Plan

### Code Changes

1. **File**: `pyproject.toml`
   **Section**: `[tool.pytest.ini_options]`
   **Change**: Add marker definition and default exclusion:
   ```toml
   markers = ["slow: marks tests as slow (>15s, excluded by default)"]
   addopts = "-m 'not slow'"
   ```
   **Rationale**: Excludes slow tests from default runs

2. **Audit and mark slow tests**:
   - Run `pytest --durations=0` to identify slow tests
   - Add `@pytest.mark.slow` to any test >15 seconds
   - Tests loading ML models (NomicEmbedding, sentence-transformers)
   - Large indexing tests
   - Integration tests with significant I/O

3. **File**: `.claude/bin/claws-gate`
   **Change**: Document that slow tests are excluded by default via addopts

### Regression Test

**Test file**: `tests/test_bug_055_regression.py`

**Test should**:
1. Verify slow marker is recognized
2. Verify marked tests can be run with explicit flag

**Test outline**:
```python
import pytest

@pytest.mark.slow
def test_slow_marker_exists():
    """This test is marked slow and should be excluded by default."""
    pass

def test_fast_test_runs_by_default():
    """This test should run in the default test suite."""
    pass
```

### Verification

After implementing the fix:
```bash
# Default run should exclude slow tests
pytest --collect-only 2>&1 | grep "slow"

# Explicit slow run should include them
pytest -m slow --collect-only

# Full run should include everything
pytest -m "" --collect-only
```

---

## Implementation (filled by Implementer)

- **Implemented by**: W-1765688937-34977
- **Commit**: 9e055255da8c28b608488364c05a7b216fc3dca4
- **Regression test file**: tests/test_bug_055_regression.py

### Changes Made

1. **pyproject.toml**: Added `addopts = "-m 'not slow'"` to exclude slow tests by default. Updated marker description to clarify ">15s, excluded by default".

2. **tests/git/test_analyzer.py**: Added `@pytest.mark.slow` to `test_integration_with_real_repo` (26.82s).

3. **tests/gates/test_check_types.py**: Added `@pytest.mark.slow` to `test_check_types_completes_standalone` (22.72s). Added pytest import.

4. **tests/integration/test_e2e.py**: Added `pytest.mark.slow` to module-level `pytestmark` (entire module ~30s+ for tests).

5. **tests/integration/test_mcp_protocol.py**: Added `pytest.mark.slow` to module-level `pytestmark` (server startup ~23s).

6. **tests/test_bug_055_regression.py**: Created regression test file with:
   - `test_slow_marker_is_recognized`: Verifies marker is configured
   - `test_slow_tests_excluded_by_default`: Verifies slow tests are excluded
   - `test_slow_tests_can_be_explicitly_run`: Verifies -m slow works
   - `test_all_tests_can_be_run_with_empty_marker`: Verifies -m '' runs all
   - `test_this_test_is_marked_slow`: Sample slow test for verification
   - `test_this_test_runs_by_default`: Sample fast test for verification

### Test Results

- **Default run**: 708 passed, 34 deselected in 151.61s (2:31)
- **Previous**: 736 passed in 358.20s (5:58)
- **Improvement**: ~2.4x faster for gate checks

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
