# BUG-059: Add worktree health check command

## Reported

- **First noticed on commit**: Multiple sessions (see retrospective-2025-12-14.md Theme 4)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-14
- **Severity**: medium

## Reproduction Steps

1. Work with multiple worktrees over several sessions
2. Some worktrees become stale (task done but worktree not cleaned)
3. Some worktrees have uncommitted changes that block operations
4. No easy way to audit worktree state

**Expected**: A health check command that audits all worktrees and reports issues.
**Actual**: Must manually inspect each worktree to find problems.

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
- Session 027c2be2: "Stale worktree from abandoned task blocking new worktree creation"
- Session f324d9e6: "Uncommitted changes in worktree caused merge conflict"
- Retrospective Theme 4: Worktree management is a recurring pain point

### Initial Hypothesis

No command exists to audit worktree health status.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | No health check command | Manual inspection required | `claws-worktree health` exists | Reviewed claws-worktree - no health subcommand | Confirmed |

### Root Cause (Proven)

**The bug is caused by**: No automated worktree health auditing capability.

**Evidence**: `claws-worktree` has create/list/merge/remove but no health/audit command.

---

## Fix Plan

### Code Changes

1. **File**: `.claude/bin/claws-worktree`
   **Change**: Add `health` subcommand that checks:
   ```bash
   claws-worktree health

   # Output:
   # Worktree Health Report
   # =====================
   #
   # BUG-042: OK
   #   - Clean working tree
   #   - Task in IMPLEMENT phase (active)
   #   - Branch up to date with main
   #
   # SPEC-001-02: WARNING
   #   - Uncommitted changes: 3 files
   #   - Task in DONE phase (should be cleaned up)
   #
   # BUG-039: ERROR
   #   - Task not found in database
   #   - Orphaned worktree (recommend: claws-worktree remove BUG-039)
   ```

   **Health checks**:
   - Uncommitted changes (warning)
   - Untracked files (info)
   - Task phase vs worktree existence (error if DONE with worktree, warning if worktree without task)
   - Branch divergence from main (info)
   - Stale worktree (no commits in >7 days) (warning)
   - Disk usage per worktree (info)

2. **File**: `.claude/bin/claws-worktree`
   **Change**: Add `health --fix` option to auto-remediate:
   ```bash
   claws-worktree health --fix

   # Auto-fix actions:
   # - Remove orphaned worktrees (no task record)
   # - Remove worktrees for DONE tasks
   # - Warn but don't auto-fix uncommitted changes
   ```

### Implementation Notes

```bash
# Pseudocode for health check
worktree_health() {
    for worktree in .worktrees/*; do
        task_id=$(basename "$worktree")

        # Check task exists
        task_phase=$(.claude/bin/claws-task show "$task_id" --format phase 2>/dev/null)
        if [ -z "$task_phase" ]; then
            echo "ERROR: $task_id - Orphaned (no task record)"
            continue
        fi

        # Check working tree clean
        cd "$worktree"
        if ! git diff --quiet; then
            echo "WARNING: $task_id - Uncommitted changes"
        fi

        # Check if task is done but worktree exists
        if [ "$task_phase" = "DONE" ]; then
            echo "WARNING: $task_id - Task DONE but worktree exists"
        fi

        # Check staleness
        last_commit=$(git log -1 --format=%ct)
        now=$(date +%s)
        days_stale=$(( (now - last_commit) / 86400 ))
        if [ "$days_stale" -gt 7 ]; then
            echo "WARNING: $task_id - No commits in $days_stale days"
        fi
    done
}
```

### Regression Test

Manual verification:
1. Create stale worktree, verify health check detects it
2. Create worktree with uncommitted changes, verify warning
3. Create orphaned worktree (no task), verify error
4. Run `--fix` and verify cleanup actions

### Verification

After implementing the fix:
```bash
# Run health check
.claude/bin/claws-worktree health

# Verify output format
.claude/bin/claws-worktree health | grep -E "(OK|WARNING|ERROR)"

# Test fix mode
.claude/bin/claws-worktree health --fix --dry-run
```

---

## Implementation (filled by Implementer)

- **Implemented by**: W-1765692192-88267
- **Commit**: e7f92b6
- **Regression test file**: tests/scripts/test_bug_059_worktree_health.py

### Changes Made

Implemented the `claws-worktree health` command exactly as specified in the fix plan:

1. **Added `cmd_health()` function** to `.claude/bin/claws-worktree` (230+ lines)
   - Iterates through all worktree directories
   - Checks each worktree for various health conditions:
     - Orphaned worktrees (no task in database) - ERROR
     - DONE tasks with worktrees still present - WARNING
     - Uncommitted changes - WARNING
     - Untracked files - INFO (reported but not status change)
     - Branch divergence from main - INFO
     - Stale worktrees (no commits in 7+ days) - WARNING
     - Disk usage - INFO
   - Also checks for database records pointing to missing worktree directories

2. **Added `--fix` and `--dry-run` options**
   - `--fix`: Removes orphaned worktrees, removes DONE task worktrees, clears orphaned database records
   - `--dry-run`: Shows what would be fixed without making changes

3. **Additional fixes** (pre-existing linter issues):
   - Removed unused `Mount` import from `src/clams/server/http.py`
   - Added per-file-ignores for `generate_*.py` files in `pyproject.toml`

4. **Regression test** at `tests/scripts/test_bug_059_worktree_health.py`
   - Verifies health command exists in script
   - Verifies usage documentation
   - Verifies key health checks are implemented
   - Verifies --fix and --dry-run options exist
   - Verifies structured output with OK/WARNING/ERROR indicators
   - Verifies script is executable

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
