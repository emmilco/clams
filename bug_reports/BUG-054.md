# BUG-054: Test isolation fixture for resource leaks

## Reported

- **First noticed on commit**: Multiple sessions (see retrospective-2025-12-14.md Theme 2)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-14
- **Severity**: high

## Reproduction Steps

1. Write a test that creates an async task or subprocess
2. Test completes without explicitly cleaning up the resource
3. pytest hangs during shutdown waiting for the resource

**Expected**: Tests should have automatic cleanup of common resource types, and fail explicitly if resources are leaked.
**Actual**: Leaked resources cause silent hangs with no indication of what's wrong.

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
- Session cfc84635: "aiosqlite connections not closed in ServiceContainer"
- Session 027c2be2: "GitPython processes not cleaned up"
- Session 397dc07e: "background threads from torch/tokenizers prevent clean exit"

### Initial Hypothesis

No pytest fixture exists to track and clean up resources created during tests.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | No resource tracking fixture | Resources leak silently | Tests fail on leak | Reviewed conftest.py - no such fixture | Confirmed |

### Root Cause (Proven)

**The bug is caused by**: No automatic resource tracking or cleanup mechanism in tests.

**Evidence**: Tests create async tasks, threads, and subprocesses that persist after test completion, causing hangs.

---

## Fix Plan

### Code Changes

1. **File**: `tests/conftest.py`
   **Change**: Create a `resource_tracker` fixture that:
   - Captures baseline of async tasks, threads before test
   - In teardown, compares current state to baseline
   - Attempts cleanup of any new resources
   - **Fails the test** if cleanup was needed (indicating a leak)
   **Rationale**: Makes resource leaks explicit failures rather than silent hangs

### Implementation Notes

```python
import asyncio
import threading
import pytest

@pytest.fixture(autouse=True)
def resource_tracker():
    """Track and fail tests that leak resources."""
    # Capture baseline
    try:
        loop = asyncio.get_running_loop()
        baseline_tasks = set(asyncio.all_tasks(loop))
    except RuntimeError:
        baseline_tasks = set()

    baseline_threads = set(t for t in threading.enumerate()
                          if t.daemon is False and t.name != 'MainThread')

    yield

    # Check for leaks
    try:
        loop = asyncio.get_running_loop()
        current_tasks = set(asyncio.all_tasks(loop))
    except RuntimeError:
        current_tasks = set()

    current_threads = set(t for t in threading.enumerate()
                         if t.daemon is False and t.name != 'MainThread')

    leaked_tasks = current_tasks - baseline_tasks
    leaked_threads = current_threads - baseline_threads

    # Clean up leaked resources
    for task in leaked_tasks:
        task.cancel()

    if leaked_tasks or leaked_threads:
        pytest.fail(
            f"Resource leak detected: "
            f"{len(leaked_tasks)} async tasks, "
            f"{len(leaked_threads)} threads"
        )
```

### Regression Test

**Test file**: `tests/test_bug_054_regression.py`

**Test should**:
1. Verify the fixture catches leaked async tasks
2. Verify the fixture catches leaked threads
3. Verify properly-cleaned-up tests pass

**Test outline**:
```python
import pytest
import asyncio
import threading

def test_clean_test_passes():
    """A test that cleans up properly should pass."""
    pass

def test_leaked_task_fails():
    """A test that leaks an async task should fail."""
    # This test intentionally leaks - verify fixture catches it
    # Mark as xfail since it's testing the failure detection
    pass
```

### Verification

After implementing the fix:
```bash
pytest tests/test_bug_054_regression.py -xvs
pytest -xvs
```

---

## Implementation (filled by Implementer)

- **Implemented by**: W-1765688936-34128
- **Commit**: a5cc2f9
- **Regression test file**: tests/bugs/test_bug_054_resource_leaks.py

### Changes Made

Implemented a thread leak detection fixture in `tests/conftest.py`:

1. **Thread Leak Tracker Fixture** (`thread_leak_tracker`):
   - Autouse fixture that captures baseline threads before each test
   - After test completion, checks for new threads that weren't joined
   - Fails the test with a clear error message listing leaked thread names
   - Uses `pytest.mark.no_resource_tracking` marker to opt out

2. **Thread Filtering Logic** (`_is_tracked_thread`, `_check_thread_leaks`):
   - Excludes daemon threads (they're killed at exit anyway)
   - Excludes known background threads via `_IGNORED_THREAD_PREFIXES`:
     - MainThread, ThreadPoolExecutor, Tokenizer, torch, asyncio_,
       concurrent.futures, QueueFeederThread, Thread-, pydevd

3. **Scope Note**: Async task tracking was attempted but removed due to
   complexity with pytest-asyncio's event loop management. Async task leaks
   manifest as test hangs or pytest-asyncio warnings, which are more
   debuggable than silent hangs. Thread leak detection addresses the
   primary issue from the bug reports.

4. **Regression Tests** (14 tests):
   - Verify fixture exists and is properly configured
   - Verify thread filtering logic works correctly
   - Verify leak detection catches single and multiple leaked threads
   - Verify cleaned threads are not reported
   - Test real-world patterns (background workers, thread pools)

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
