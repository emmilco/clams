# BUG-023: Hardcoded dimension in NomicEmbedding and related config

## Reported

- **First noticed on commit**: e2fab06
- **Reported by**: orchestrator (bug hunt agent)
- **Reported at**: 2025-12-08
- **Severity**: medium

## Reproduction Steps

1. Set `CLAMS_SEMANTIC_MODEL` to a model with different dimensions (e.g., 384-dim model)
2. Initialize NomicEmbedding
3. Check the `dimension` property

**Expected**: `dimension` should return the actual model's embedding dimension
**Actual**: `dimension` returns hardcoded `768` regardless of actual model

## Code Locations

### Primary Bug: NomicEmbedding

**File**: `src/clams/embedding/nomic.py`
**Lines**: 26, 112-119

```python
_DIMENSION = 768  # Hardcoded

@property
def dimension(self) -> int:
    """Return the dimensionality of embeddings (768)."""
    return self._DIMENSION  # Should query model like MiniLMEmbedding does
```

### Comparison: MiniLMEmbedding (correct implementation)

**File**: `src/clams/embedding/minilm.py`
**Lines**: 51-61

```python
@property
def dimension(self) -> int:
    """Get embedding dimension from the loaded model."""
    dim = self.model.get_sentence_embedding_dimension()
    if dim is None:
        raise EmbeddingModelError("Model did not return embedding dimension")
    return dim
```

### Related: Hardcoded config default

**File**: `src/clams/server/config.py`
**Line**: 24

```python
embedding_dimension: int = 768  # Default assumes Nomic, but model is configurable
```

### Related: MockEmbedding (acceptable for testing)

**File**: `src/clams/embedding/mock.py`
**Line**: 19

```python
_DIMENSION = 768  # OK for mock - always produces 768-dim vectors
```

## Analysis

The `semantic_model` is configurable via `CLAMS_SEMANTIC_MODEL` environment variable. If a user configures a different model (e.g., one that produces 384, 512, or 1024-dimensional embeddings), the following problems occur:

1. **Vector store mismatch**: Collections created with wrong dimension
2. **Search failures**: Dimension mismatch errors when storing/querying
3. **Silent corruption**: If dimensions happen to align but semantics differ

### Codebase Search Results

Locations where `.dimension` is used (all would be affected):
- `src/clams/observation/persister.py:138` - Creates collections with wrong dimension
- `src/clams/indexers/indexer.py:56,60,61,72,77` - Dimension comparison and collection creation
- `src/clams/embedding/registry.py:48,66` - Dual embedding service dimension reporting

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [ ] Steps reproduced bug

**Observations during reproduction**:
[What did you observe when reproducing?]

### Initial Hypothesis

[What do you believe is causing this bug? Be specific: file, function, line.]

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | [Hypothesis A] | [Observable X] | [Observable Y] | [What you saw] | [Eliminated/Confirmed/Pending] |

### Evidentiary Scaffold

**Logging/assertions added**:
```python
# Location: file.py:123
# Purpose: Distinguish between hypothesis 1 and 2
logger.debug(f"State at critical point: {state}")
```

**Test command**:
```bash
[Command to run with scaffold in place]
```

**Captured output**:
```
[Actual output from scaffold run]
```

### Root Cause (Proven)

**The bug is caused by**: [Specific root cause]

**Evidence**: [What proves this is the cause]

**Why alternatives were eliminated**:
- Hypothesis 1 eliminated because: [reason with evidence]

---

## Fix Plan

### Code Changes

1. **File**: `src/clams/embedding/nomic.py`
   **Function**: `dimension` property
   **Change**: Query model for actual dimension like MiniLMEmbedding does
   **Rationale**: Ensures dimension matches actual model output

2. **File**: `src/clams/server/config.py`
   **Change**: Consider removing `embedding_dimension` or documenting it's only a fallback
   **Rationale**: Dimension should come from the model, not config

### Regression Test

**Test file**: `tests/test_bug_023_regression.py`

**Test should**:
1. Create NomicEmbedding with different model configs
2. Verify dimension property matches actual embedding output
3. Verify collection creation uses correct dimension

**Test outline**:
```python
async def test_bug_023_nomic_dimension_matches_model():
    # Setup: create NomicEmbedding
    embedding = NomicEmbedding(settings)

    # Get actual embedding
    vector = await embedding.embed("test")

    # Assert: dimension property matches actual vector length
    assert embedding.dimension == len(vector)
```

### Verification

After implementing the fix:
```bash
# Run specific test
pytest tests/test_bug_023_regression.py -xvs

# Run full test suite
pytest -xvs
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
