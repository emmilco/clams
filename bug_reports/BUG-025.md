# BUG-025: InMemoryVectorStore missing range filter support

## Reported

- **First noticed on commit**: e2fab06
- **Reported by**: orchestrator (bug hunt agent)
- **Reported at**: 2025-12-08
- **Severity**: high

## Reproduction Steps

1. Use `InMemoryVectorStore` as the vector store backend
2. Call `searcher.search_commits(query="fix bug", since=datetime(2024, 1, 1))`
3. Observe results

**Expected**: Returns commits after January 1, 2024
**Actual**: Returns empty results (no matches)

## Code Locations

### Searcher filter construction

**File**: `src/clams/search/searcher.py`
**Lines**: 60-62, 413

```python
if isinstance(value, datetime):
    filters[key] = {"$gte": value.timestamp()}  # Creates operator-based filter
```

### InMemoryVectorStore filter application (buggy)

**File**: `src/clams/storage/memory.py`
**Lines**: 183-205

```python
def _apply_filters(self, results: list, filters: dict) -> list:
    if not filters:
        return results
    filtered = []
    for result in results:
        payload = result.payload or {}
        match = True
        for key, value in filters.items():
            if key not in payload or payload[key] != value:  # Strict equality only!
                match = False
                break
        if match:
            filtered.append(result)
    return filtered
```

### QdrantVectorStore filter application (correct)

**File**: `src/clams/storage/qdrant.py`
**Lines**: 270-282

```python
# Handles $gte, $lte, $gt, $lt, $in operators correctly
```

## Analysis

When `search_commits` is called with `since=datetime(2024, 1, 1)`, it creates a filter:
```python
{"committed_at": {"$gte": 1704067200.0}}
```

The `InMemoryVectorStore._apply_filters` does strict equality:
```python
payload[key] != value
# Compares: 1704067200.0 != {"$gte": 1704067200.0}
# Always True (no match)
```

This means:
1. **All date-filtered searches return empty results with InMemoryVectorStore**
2. Tests using InMemoryVectorStore with date filters silently pass with wrong behavior
3. `InMemoryVectorStore` is not a valid substitute for `QdrantVectorStore` in testing

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [ ] Steps reproduced bug

**Observations during reproduction**:
[What did you observe when reproducing?]

### Initial Hypothesis

[What do you believe is causing this bug? Be specific: file, function, line.]

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | [Hypothesis A] | [Observable X] | [Observable Y] | [What you saw] | [Eliminated/Confirmed/Pending] |

### Evidentiary Scaffold

**Logging/assertions added**:
```python
# Location: file.py:123
# Purpose: Distinguish between hypothesis 1 and 2
logger.debug(f"State at critical point: {state}")
```

**Test command**:
```bash
[Command to run with scaffold in place]
```

**Captured output**:
```
[Actual output from scaffold run]
```

### Root Cause (Proven)

**The bug is caused by**: [Specific root cause]

**Evidence**: [What proves this is the cause]

**Why alternatives were eliminated**:
- Hypothesis 1 eliminated because: [reason with evidence]

---

## Fix Plan

### Code Changes

1. **File**: `src/clams/storage/memory.py`
   **Function**: `_apply_filters`
   **Change**: Add support for operator-based filters (`$gte`, `$lte`, `$gt`, `$lt`, `$in`)
   **Rationale**: Match QdrantVectorStore behavior for testing consistency

### Regression Test

**Test file**: `tests/test_bug_025_regression.py`

**Test should**:
1. Create InMemoryVectorStore with timestamped entries
2. Search with `$gte` filter
3. Verify correct entries are returned

**Test outline**:
```python
async def test_bug_025_inmemory_supports_gte_filter():
    # Setup: insert entries with various timestamps
    store = InMemoryVectorStore()
    await store.create_collection("test", dimension=768)

    # Insert entries: one old, one new
    await store.upsert("test", id="old", vector=v, payload={"ts": 1000})
    await store.upsert("test", id="new", vector=v, payload={"ts": 2000})

    # Search with $gte filter
    results = await store.search(
        "test", query_vector=v, limit=10,
        filters={"ts": {"$gte": 1500}}
    )

    # Assert: only "new" entry returned
    assert len(results) == 1
    assert results[0].id == "new"
```

### Verification

After implementing the fix:
```bash
# Run specific test
pytest tests/test_bug_025_regression.py -xvs

# Run full test suite
pytest -xvs
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
