# BUG-027: TypeError in list_ghap_entries datetime parsing

## Reported

- **First noticed on commit**: e2fab06
- **Reported by**: orchestrator (bug hunt agent)
- **Reported at**: 2025-12-08
- **Severity**: critical

## Reproduction Steps

1. Create a GHAP entry using `start_ghap` tool
2. Resolve it using `resolve_ghap` tool
3. Call `list_ghap_entries` tool

**Expected**: List of GHAP entries with timestamps
**Actual**: `TypeError: an integer is required (got type str)`

## Code Locations

### Storage (writes ISO string)

**File**: `src/clams/observation/persister.py`
**Line**: 311

```python
"created_at": entry.created_at.isoformat(),  # Stores: "2024-01-15T10:30:45+00:00"
```

### Reading (expects numeric timestamp)

**File**: `src/clams/server/tools/ghap.py`
**Lines**: 562-566

```python
created_at = (
    datetime.fromtimestamp(r.payload["created_at"]).isoformat()  # Expects float!
    if "created_at" in r.payload
    else None
)
```

## Analysis

The code stores `created_at` as an ISO format string:
```python
"2024-01-15T10:30:45+00:00"
```

But reads it expecting a numeric timestamp:
```python
datetime.fromtimestamp("2024-01-15T10:30:45+00:00")
# Raises: TypeError: an integer is required (got type str)
```

**Note**: `captured_at` is stored correctly as `.timestamp()` (line 312), so this only affects `created_at`.

**Impact**:
- `list_ghap_entries` tool crashes on any real data
- Users cannot view their GHAP history
- Tool is completely broken for production use

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [ ] Steps reproduced bug

**Observations during reproduction**:
[What did you observe when reproducing?]

### Initial Hypothesis

[What do you believe is causing this bug? Be specific: file, function, line.]

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | [Hypothesis A] | [Observable X] | [Observable Y] | [What you saw] | [Eliminated/Confirmed/Pending] |

### Evidentiary Scaffold

**Logging/assertions added**:
```python
# Location: file.py:123
# Purpose: Distinguish between hypothesis 1 and 2
logger.debug(f"State at critical point: {state}")
```

**Test command**:
```bash
[Command to run with scaffold in place]
```

**Captured output**:
```
[Actual output from scaffold run]
```

### Root Cause (Proven)

**The bug is caused by**: [Specific root cause]

**Evidence**: [What proves this is the cause]

**Why alternatives were eliminated**:
- Hypothesis 1 eliminated because: [reason with evidence]

---

## Fix Plan

### Code Changes

Option A (minimal change): Fix the reader
1. **File**: `src/clams/server/tools/ghap.py`
   **Line**: 563
   **Change**: Use `datetime.fromisoformat()` instead of `datetime.fromtimestamp()`
   **Rationale**: Matches how data is stored

Option B (consistency): Store as timestamp
1. **File**: `src/clams/observation/persister.py`
   **Line**: 311
   **Change**: Store `created_at` as `.timestamp()` like `captured_at`
   **Rationale**: Consistent storage format, but requires migration

### Regression Test

**Test file**: `tests/test_bug_027_regression.py`

**Test should**:
1. Create and persist a GHAP entry
2. Call list_ghap_entries
3. Verify no exception and correct timestamp returned

**Test outline**:
```python
async def test_bug_027_list_ghap_entries_parses_dates():
    # Setup: create and persist a GHAP entry
    collector = ObservationCollector()
    entry = collector.create_ghap(...)
    await persister.persist(entry)

    # Action: list entries
    result = await list_ghap_entries(...)

    # Assert: no exception, dates parsed correctly
    assert result["entries"][0]["created_at"] is not None
```

### Verification

After implementing the fix:
```bash
# Run specific test
pytest tests/test_bug_027_regression.py -xvs

# Run full test suite
pytest -xvs
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
