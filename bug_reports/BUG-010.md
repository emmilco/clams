# BUG-010: store_value returns internal server error

## Reported

- **First noticed on commit**: fac4624 (main)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-07
- **Severity**: medium

## Reproduction Steps

1. Start the learning-memory-server MCP server
2. Call the `store_value` tool:
   ```json
   {
     "text": "Always test each component individually before integration",
     "cluster_id": "full_0",
     "axis": "full"
   }
   ```
3. Observe the response

**Expected**: The value is stored and a confirmation with value_id is returned

**Actual**: Returns `{"error": {"type": "internal_error", "message": "Internal server error"}}`

## Technical Details

Related tools status:
- `get_clusters` - works (returns "insufficient data" when < 20 experiences)
- `get_cluster_members` - works (returns empty list)
- `validate_value` - also fails with internal server error (BUG-009)
- `list_values` - works (returns empty list)
- `search_experiences` - works

Note: BUG-009 and BUG-010 may share the same root cause since both involve the ValueStore.

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
- Examined code path from `store_value` MCP tool through to `ValueStore.store_value()`
- Traced execution through validation and clustering calls
- Identified unhandled `ValueError` exception when no cluster data exists

### Initial Hypothesis

The error occurs because `store_value` attempts to validate against a cluster that doesn't exist (insufficient data for clustering).

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | Missing exception handling for `ValueError` from clustering | Internal server error when < 20 experiences | Graceful error message about insufficient data | Code review shows `ValueError` from `cluster_axis()` not caught in `ValueStore` methods | **CONFIRMED** |
| 2 | Database/VectorStore connection issue | All VectorStore operations fail | Only clustering-dependent operations fail | `get_cluster_members` and `list_values` work correctly | ELIMINATED |
| 3 | Invalid function signature or parameter mismatch | Error on all calls regardless of data | Error only when insufficient data | `list_values` works, suggesting correct signatures | ELIMINATED |

### Root Cause (Proven)

**Root Cause**: `ValueError` exceptions from the clustering layer are not caught by `ValueStore` methods, causing them to bubble up as internal server errors.

**Evidence Chain**:
1. `store_value()` tool (learning.py:342) calls `value_store.store_value()`
2. `ValueStore.store_value()` (store.py:228) calls `validate_value_candidate()`
3. `validate_value_candidate()` (store.py:170) calls `_get_cluster()`
4. `_get_cluster()` (store.py:343) calls `get_clusters()`
5. `get_clusters()` (store.py:80) calls `clusterer.cluster_axis()`
6. `ExperienceClusterer.cluster_axis()` (experience.py:107-109) raises `ValueError` when no embeddings found
7. This `ValueError` propagates back through the call chain unhandled
8. The exception handler in `learning.py:371-378` catches all `Exception` types but returns generic "internal_error"

**Why alternatives eliminated**:
- **Database issue**: Ruled out because `list_values` and `get_cluster_members` (which use VectorStore) work correctly
- **Invalid signatures**: Ruled out because successful tools share the same initialization and service dependencies

**Shared root cause with BUG-009**:
Both `validate_value` and `store_value` call `value_store.validate_value_candidate()`, which follows the same code path through `_get_cluster()` → `get_clusters()` → `cluster_axis()`. Both fail with the same unhandled `ValueError`.

---

## Fix Plan

### Code Changes

**1. Add exception handling in `ValueStore` methods** (`src/learning_memory_server/values/store.py`):

- Modify `get_clusters()` (line 58) to catch `ValueError` from `cluster_axis()` and raise a more specific exception
- Modify `_get_cluster()` (line 325) to catch cluster-not-found errors and raise `ValueError` with clear message
- Modify `validate_value_candidate()` (line 154) to catch clustering errors and return `ValidationResult(valid=False, reason=...)`
- Modify `store_value()` (line 213) to let validation errors propagate properly

**2. Update error handling in tool layer** (`src/learning_memory_server/server/tools/learning.py`):

- The existing exception handlers at lines 289-304 (validate_value) and 363-378 (store_value) already catch `ValidationError` and `NotFoundError`
- Ensure clustering-related errors are properly mapped to these exception types

**Specific changes**:

**In `store.py`:**
```python
async def get_clusters(self, axis: str) -> list[ClusterInfo]:
    # ... existing validation ...
    try:
        clustering_results = await self.clusterer.cluster_axis(axis)
    except ValueError as e:
        # Re-raise with context about insufficient data
        raise ValueError(f"Cannot get clusters for axis '{axis}': {e}")
    # ... rest of method ...
```

**In `store.py`:**
```python
async def validate_value_candidate(
    self, text: str, cluster_id: str
) -> ValidationResult:
    try:
        cluster = await self._get_cluster(cluster_id)
        members = await self.get_cluster_members(cluster_id)
    except ValueError as e:
        return ValidationResult(valid=False, reason=str(e))
    # ... rest of validation logic ...
```

### Regression Test

Add test in `tests/values/test_store.py`:

```python
async def test_store_value_with_insufficient_data(value_store, embedding_service):
    """Test that store_value returns proper error when cluster doesn't exist."""
    # Attempt to store value when no experiences exist (< 20 for clustering)
    with pytest.raises(ValueError, match="Cannot get clusters"):
        await value_store.store_value(
            text="Test value",
            cluster_id="full_0",
            axis="full"
        )

async def test_validate_value_with_insufficient_data(value_store):
    """Test that validate_value returns ValidationResult with valid=False."""
    result = await value_store.validate_value_candidate(
        text="Test value",
        cluster_id="full_0"
    )
    assert result.valid is False
    assert "cluster" in result.reason.lower()
```

**Integration test** to verify MCP tool response:
```python
async def test_store_value_tool_insufficient_data(learning_tools):
    """Test store_value tool returns validation_error, not internal_error."""
    result = await learning_tools["store_value"](
        text="Test value",
        cluster_id="full_0",
        axis="full"
    )
    assert "error" in result
    assert result["error"]["type"] == "validation_error"
    assert "cluster" in result["error"]["message"].lower()
```

### Verification

1. Run unit tests for `ValueStore`:
   ```bash
   pytest tests/values/test_store.py -v
   ```

2. Run integration tests for learning tools:
   ```bash
   pytest tests/server/tools/test_learning.py -v
   ```

3. Manual verification with MCP server:
   - Start server with empty database
   - Call `store_value` with test data
   - Verify response is `{"error": {"type": "validation_error", "message": "...cluster..."}}`
   - NOT `{"error": {"type": "internal_error", "message": "Internal server error"}}`

4. Verify BUG-009 is also fixed (same root cause):
   - Call `validate_value` with test data
   - Verify proper validation error response

---

## Implementation (filled by Implementer)

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
