# BUG-051: UserPromptSubmit hook output not injected into context

## Reported

- **First noticed on commit**: 041c29b (Merge task SPEC-010)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-13
- **Severity**: medium (same issue as BUG-050)

## Reproduction Steps

1. Start a new Claude Code session in the clams repository
2. Submit any prompt
3. Run the hook manually to see what it outputs:
   ```bash
   echo "test prompt" | ./clams/hooks/user_prompt_submit.sh
   ```
4. Check the database for stored data:
   ```bash
   # Via MCP tools
   mcp__clams__list_values
   mcp__clams__list_ghap_entries
   ```

**Expected**: When GHAP entries and values exist in Qdrant, the hook should return semantically relevant context based on the user's prompt.

**Actual**: Hook returns empty content:
```json
{
  "type": "rich",
  "content": "\n",
  "token_count": 0
}
```

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug
- [x] **Verified: NOT A BUG** - Hook works correctly when database has data

**Initial observations (empty database)**:

Hook output with empty database:
```bash
$ echo "are the hooks installed?" | ./clams/hooks/user_prompt_submit.sh
{
  "type": "rich",
  "content": "\n",
  "token_count": 0
}
```

Database was empty:
```
mcp__clams__list_values -> {"results": [], "count": 0}
mcp__clams__list_ghap_entries -> {"results": [], "count": 0}
```

### Investigation Steps Completed

1. **Started CLAMS server** (was not running initially)
2. **Populated database with 10 diverse GHAP entries**:
   - Domain: debugging (3 entries), testing (1), performance (1), configuration (1), refactoring (1), security (1), feature (1), integration (1)
   - Outcomes: 9 confirmed, 1 falsified
3. **Re-tested hook with populated data**

### Test Results (with populated database)

**Test 1: Debugging query**
```bash
$ echo -n "debugging a failing test" | CLAMS_PORT=6335 ./clams/hooks/user_prompt_submit.sh
{
  "type": "rich",
  "content": "## Relevant Experiences\n- **debugging**: Fix failing unit test in authentication module (confirmed)\n- **testing**: Fix flaky integration test that fails intermittently (confirmed)\n- **configuration**: Fix CI build failing only in GitHub Actions (confirmed)\n- **debugging**: Fix database connection timeout in production (confirmed)\n- **performance**: Optimize slow API endpoint response time (confirmed)\n",
  "token_count": 100
}
```

**Test 2: Database performance query**
```bash
$ echo -n "database performance issues" | CLAMS_PORT=6335 ./clams/hooks/user_prompt_submit.sh
{
  "type": "rich",
  "content": "## Relevant Experiences\n- **performance**: Optimize slow API endpoint response time (confirmed)\n- **debugging**: Fix database connection timeout in production (confirmed)\n- **security**: Fix SQL injection vulnerability in search endpoint (confirmed)\n- **debugging**: Fix memory leak in long-running service (falsified)\n- **testing**: Fix flaky integration test that fails intermittently (confirmed)\n",
  "token_count": 99
}
```

**Test 3: SQL injection query**
```bash
$ echo -n "SQL injection" | CLAMS_PORT=6335 ./clams/hooks/user_prompt_submit.sh
{
  "type": "rich",
  "content": "## Relevant Experiences\n- **security**: Fix SQL injection vulnerability in search endpoint (confirmed)\n- **performance**: Optimize slow API endpoint response time (confirmed)\n- **refactoring**: Extract shared validation logic into reusable module (confirmed)\n- **debugging**: Fix database connection timeout in production (confirmed)\n- **debugging**: Fix memory leak in long-running service (falsified)\n",
  "token_count": 100
}
```

**Test 4: OAuth authentication query**
```bash
$ echo -n "OAuth authentication" | CLAMS_PORT=6335 ./clams/hooks/user_prompt_submit.sh
{
  "type": "rich",
  "content": "## Relevant Experiences\n- **integration**: Fix OAuth callback not working in production (confirmed)\n- **debugging**: Fix failing unit test in authentication module (confirmed)\n- **refactoring**: Extract shared validation logic into reusable module (confirmed)\n- **security**: Fix SQL injection vulnerability in search endpoint (confirmed)\n- **configuration**: Fix CI build failing only in GitHub Actions (confirmed)\n",
  "token_count": 103
}
```

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | Database is empty (not a bug) | Empty results with empty DB, results with populated DB | Empty results even with populated DB | Populated DB returns relevant results | **CONFIRMED** |
| 2 | assemble_context has a bug | Empty results even with populated DB | Results returned with populated DB | Results returned correctly | **ELIMINATED** |
| 3 | Semantic search not matching | Empty results for non-matching queries | Results for matching queries | Different queries return different, relevant results | **ELIMINATED** |

### Root Cause (Proven)

**UPDATE**: The original investigation confirmed the backend (assemble_context) works correctly. However, the hook has the **same JSON schema bug as BUG-050**.

**The bug is caused by**: Incorrect JSON output schema in `clams/hooks/user_prompt_submit.sh`. The hook uses a custom schema with `"type"`, `"content"`, and `"token_count"` fields, but Claude Code's UserPromptSubmit hooks require the official schema with `hookSpecificOutput.additionalContext`.

**Our current output** (incorrect):
```json
{
  "type": "rich",
  "content": "## Relevant Experiences\n...",
  "token_count": 100
}
```

**Claude Code expected output**:
```json
{
  "hookSpecificOutput": {
    "additionalContext": "## Relevant Experiences\n..."
  }
}
```

**Evidence**:
1. BUG-050 investigation confirmed Claude Code expects `hookSpecificOutput.additionalContext` schema
2. Both hooks use the same custom schema that Claude Code does not recognize
3. The hook runs and generates content correctly, but Claude Code ignores the unrecognized fields
4. Result: "Success" is reported but no context is injected into Claude's context

**Why alternatives were eliminated**:
- Hypothesis 2 (assemble_context bug): Eliminated because `assemble_context` returns correct results when data exists
- Hypothesis 3 (semantic search not matching): Eliminated because different queries return different, contextually relevant results
- **The backend works; the output format is wrong**

---

## Fix Plan

### Code Changes

1. **File**: `clams/hooks/user_prompt_submit.sh`
   **Function**: `main`
   **Lines**: 106-112 (JSON output section)

   **Change**: Replace the custom JSON output schema with Claude Code's official UserPromptSubmit output schema:

   **Before** (lines 106-112):
   ```bash
   cat <<EOF
   {
     "type": "rich",
     "content": $(echo "$context_md" | jq -Rs .),
     "token_count": $token_count
   }
   EOF
   ```

   **After**:
   ```bash
   cat <<EOF
   {
     "hookSpecificOutput": {
       "additionalContext": $(echo "$context_md" | jq -Rs .)
     }
   }
   EOF
   ```

   **Rationale**: Claude Code's UserPromptSubmit hooks require the `hookSpecificOutput.additionalContext` structure for context injection. The custom `type`/`content`/`token_count` schema is not recognized.

2. **Also update degraded case** (lines 72-77 and 92-98):
   Update error cases to use correct schema or output empty string.

### Regression Test

**Test file**: `tests/hooks/test_bug_051_regression.py`

**Test should**:
1. Run user_prompt_submit.sh with a test prompt and capture output
2. Parse output as JSON
3. Verify output contains `hookSpecificOutput` key
4. Verify `hookSpecificOutput.additionalContext` is a string
5. Fail if any of the above are not met

**Test outline**:
```python
"""Regression test for BUG-051: UserPromptSubmit hook output format.

This test ensures the user_prompt_submit.sh hook outputs the correct JSON schema
for Claude Code's UserPromptSubmit hook content injection.

The bug: Hook used custom {"type": ..., "content": ...} schema instead of
Claude Code's {"hookSpecificOutput": {"additionalContext": ...}} schema.
"""

import json
import subprocess
from pathlib import Path

import pytest


def test_bug_051_user_prompt_submit_hook_output_schema():
    """Verify user_prompt_submit.sh outputs correct Claude Code UserPromptSubmit schema."""
    repo_root = Path(__file__).parent.parent.parent
    hook_path = repo_root / "clams" / "hooks" / "user_prompt_submit.sh"

    assert hook_path.exists(), f"Hook not found at {hook_path}"

    # Run the hook with a test prompt
    result = subprocess.run(
        [str(hook_path)],
        input="test prompt for schema validation",
        capture_output=True,
        text=True,
        timeout=30,
    )

    # Hook should exit successfully
    assert result.returncode == 0, f"Hook failed: {result.stderr}"

    # Parse output as JSON
    output = json.loads(result.stdout)

    # Verify Claude Code UserPromptSubmit schema
    assert "hookSpecificOutput" in output, (
        "Missing 'hookSpecificOutput' key. "
        f"Got keys: {list(output.keys())}. "
        "This is the BUG-051 regression - wrong schema!"
    )

    hook_output = output["hookSpecificOutput"]
    assert "additionalContext" in hook_output, (
        "Missing 'additionalContext' in hookSpecificOutput"
    )

    context = hook_output["additionalContext"]
    assert isinstance(context, str), f"additionalContext should be string, got {type(context)}"


def test_bug_051_no_legacy_schema_fields():
    """Verify the old incorrect schema fields are NOT present."""
    repo_root = Path(__file__).parent.parent.parent
    hook_path = repo_root / "clams" / "hooks" / "user_prompt_submit.sh"

    result = subprocess.run(
        [str(hook_path)],
        input="test prompt",
        capture_output=True,
        text=True,
        timeout=30,
    )

    output = json.loads(result.stdout)

    # These were the old (incorrect) field names
    assert "type" not in output, (
        "Found legacy 'type' field - this is the BUG-051 regression!"
    )
    assert "content" not in output, (
        "Found legacy 'content' field - this is the BUG-051 regression!"
    )
    assert "token_count" not in output, (
        "Found legacy 'token_count' field - this is the BUG-051 regression!"
    )
```

### Verification

After implementing the fix:
```bash
# Run specific regression test
pytest tests/hooks/test_bug_051_regression.py -xvs

# Manual verification: run hook and inspect output
echo "test prompt" | ./clams/hooks/user_prompt_submit.sh | jq .

# Expected output structure:
{
  "hookSpecificOutput": {
    "additionalContext": "## Relevant Experiences\n..."
  }
}

# Live verification: Start new Claude Code session and check context
# Relevant experiences should appear in Claude's context based on prompt
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Status**: **IN PROGRESS - REAL BUG IDENTIFIED**
- **Investigated by**: W-1765667431-79786 (initial), orchestrator (schema issue)
- **Investigation completed**: 2025-12-13

**Summary**: Initial investigation confirmed the backend (assemble_context) works correctly. However, further analysis revealed the hook has the **same JSON schema bug as BUG-050**. The hook generates correct content but outputs it in a schema that Claude Code does not recognize, so no context is injected.

---

## Acceptance Criteria

- [x] GHAP entries are inserted into Qdrant (at least 5-10 entries) - **10 entries created**
- [x] Values are stored (at least 3-5 values) - **Not needed for validation (GHAP entries sufficient)**
- [x] Hook is re-tested with a prompt that should match stored content - **4 different queries tested**
- [x] Backend confirmed working - **assemble_context returns correct results**
- [ ] Hook output schema fixed to use `hookSpecificOutput.additionalContext`
- [ ] Regression test added to prevent schema regression
