# BUG-051: UserPromptSubmit hook returns empty - needs verification with data

## Reported

- **First noticed on commit**: 041c29b (Merge task SPEC-010)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-13
- **Severity**: low (may not be a bug)

## Reproduction Steps

1. Start a new Claude Code session in the clams repository
2. Submit any prompt
3. Run the hook manually to see what it outputs:
   ```bash
   echo "test prompt" | ./clams/hooks/user_prompt_submit.sh
   ```
4. Check the database for stored data:
   ```bash
   # Via MCP tools
   mcp__clams__list_values
   mcp__clams__list_ghap_entries
   ```

**Expected**: When GHAP entries and values exist in Qdrant, the hook should return semantically relevant context based on the user's prompt.

**Actual**: Hook returns empty content:
```json
{
  "type": "rich",
  "content": "\n",
  "token_count": 0
}
```

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [ ] Steps reproduced bug

**Observations during reproduction**:

Hook output:
```bash
$ echo "are the hooks installed?" | ./clams/hooks/user_prompt_submit.sh
{
  "type": "rich",
  "content": "\n",
  "token_count": 0
}
```

Database is empty:
```
mcp__clams__list_values -> {"results": [], "count": 0}
mcp__clams__list_ghap_entries -> {"results": [], "count": 0}
```

Server is receiving requests (from server.log):
```
HTTP Request: POST http://localhost:6333/collections/ghap_full/points/query "HTTP/1.1 200 OK"
HTTP Request: POST http://localhost:6333/collections/values/points/scroll "HTTP/1.1 200 OK"
```

### Initial Hypothesis

**NOTE: We are not sure anything is wrong with this hook.**

The hook may be working correctly - it's returning empty results because there are no GHAP entries or values stored in Qdrant yet. This is expected behavior for an empty database.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | Database is empty (not a bug) | Empty results with empty DB, results with populated DB | Empty results even with populated DB | DB is empty, need to populate and retest | Pending |
| 2 | assemble_context has a bug | Empty results even with populated DB | Results returned with populated DB | Need to populate DB first | Pending |
| 3 | Semantic search not matching | Empty results for non-matching queries | Results for matching queries | Need to test with known-matching queries | Pending |

### Evidentiary Scaffold

**The investigation should**:

1. **Insert test data into Qdrant** - Create several GHAP entries and values to populate the collections
2. **Re-test the hook** - Verify that `assemble_context` returns relevant content when data exists
3. **Verify semantic search** - Confirm that queries match stored entries appropriately

**Test command**:
```bash
# After populating data:
echo "debugging a test failure" | ./clams/hooks/user_prompt_submit.sh
```

**Captured output**:
```
[Pending - need to populate database first]
```

### Root Cause (Proven)

**The bug is caused by**: [To be determined after populating database]

**Evidence**: [Pending - database currently empty]

**Why alternatives were eliminated**:
- [Pending investigation]

---

## Fix Plan

### Code Changes

**Depends on investigation outcome:**

- If hook works correctly after populating data: **Close as not-a-bug**
- If hook still returns empty with data: Investigate `assemble_context` implementation

### Regression Test

**Test file**: `tests/hooks/test_bug_051_regression.py`

**Test should**:
1. Insert known GHAP entries and values into Qdrant
2. Call assemble_context with a query that should match
3. Verify relevant content is returned
4. Clean up test data

**Test outline**:
```python
def test_bug_051_regression():
    # Setup: insert GHAP entries about "debugging"
    start_ghap(goal="Fix failing test", hypothesis="...")
    resolve_ghap(status="confirmed", result="...")

    # Also insert some values
    store_value(text="When debugging, check logs first", ...)

    # Action: call assemble_context with matching query
    result = assemble_context(query="debugging a test failure")

    # Assert: verify relevant content returned
    assert result["token_count"] > 0
    assert "debugging" in result["markdown"].lower()
```

### Verification

After populating data:
```bash
# Test the hook directly
echo "debugging a failing test" | ./clams/hooks/user_prompt_submit.sh

# Should return non-empty content if hook is working
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]

---

## Acceptance Criteria

- [ ] GHAP entries are inserted into Qdrant (at least 5-10 entries)
- [ ] Values are stored (at least 3-5 values)
- [ ] Hook is re-tested with a prompt that should match stored content
- [ ] Either: hook returns relevant context (close as not-a-bug)
- [ ] Or: bug is identified and fixed in assemble_context/search pipeline
