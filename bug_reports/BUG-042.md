# BUG-042: Daemon crashes on macOS due to MPS fork safety

## Reported

- **First noticed on commit**: 9511df4 (SPEC-008 merge)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-13
- **Severity**: critical (installation broken on macOS)

## Reproduction Steps

1. Run `./scripts/install.sh --skip-qdrant` on macOS with Apple Silicon
2. Observe installation completes but daemon fails to start
3. Check `~/.clams/server.log`

**Expected**: Daemon starts successfully and responds to health checks
**Actual**: Daemon crashes with:
```
objc[42701]: +[MPSGraphObject initialize] may have been in progress in another thread when fork() was called.
objc[42701]: +[MPSGraphObject initialize] may have been in progress in another thread when fork() was called. We cannot safely call it or ignore it in the fork() child process. Crashing instead.
```

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
Server log shows it starts daemonizing, then crashes immediately when the forked child tries to continue.

### Initial Hypothesis

The `daemonize()` function in `http.py` uses `os.fork()`, but by the time it's called, PyTorch has already initialized MPS (Metal Performance Shaders) via the imports at the top of `main.py`. MPS doesn't support fork() after initialization.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | MPS initialized before fork | Crash with MPSGraphObject error | Different error or no crash | Exact error message matches MPS fork safety | **Confirmed** |
| 2 | Import chain loads PyTorch | `torch` in sys.modules before fork | torch not imported | `from clams.embedding import initialize_registry` triggers torch import | **Confirmed** |
| 3 | Works without --daemon flag | No crash in non-daemon mode | Crash in both modes | Non-daemon mode works fine (no fork) | **Confirmed** |

### Root Cause (Proven)

**The bug is caused by**: PyTorch MPS being initialized before `os.fork()` is called in `daemonize()`.

**Evidence**:
1. Error message explicitly states MPS was initializing when fork() was called
2. Import chain: `main.py` → `clams.embedding` → `nomic.py` → `torch` (initializes MPS)
3. `daemonize()` is called at line 261 of main.py, after imports have run

**Why alternatives were eliminated**:
- Not a uvicorn issue: crash happens before uvicorn starts
- Not a Qdrant issue: crash happens even with --skip-qdrant
- Not a configuration issue: same code works without --daemon flag

---

## Fix Plan

### Code Changes

1. **File**: `src/clams/server/main.py`
   **Function**: `main()`
   **Change**: Move daemonization to happen BEFORE any imports that trigger PyTorch
   **Rationale**: Fork must complete before MPS initializes in the child process

2. **Implementation approach**:
   - Create a new entry point that handles daemon logic before heavy imports
   - Use lazy imports for all PyTorch-dependent modules
   - Only import embedding/server modules AFTER fork completes in daemon mode

### Regression Test

**Test file**: `tests/server/test_bug_042_regression.py`

**Test should**:
1. Verify daemonize() can be called without MPS crash
2. Test that daemon mode works (start/stop/health check)
3. Ensure imports don't trigger torch until after daemonization decision

**Test outline**:
```python
def test_bug_042_daemon_does_not_crash():
    """Verify daemon mode doesn't crash due to MPS fork safety."""
    # Start daemon in subprocess
    # Wait for health check to pass
    # Stop daemon
    # Assert no crash occurred
```

### Verification

After implementing the fix:
```bash
# Test daemon starts without crash
./scripts/install.sh --skip-qdrant

# Verify health endpoint responds
curl http://127.0.0.1:6334/health

# Stop daemon
.venv/bin/clams-server --stop
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: `tests/server/test_bug_042_regression.py`

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
