# BUG-024: Error message mismatch between InMemoryVectorStore and Searcher

## Reported

- **First noticed on commit**: e2fab06
- **Reported by**: orchestrator (bug hunt agent)
- **Reported at**: 2025-12-08
- **Severity**: high

## Reproduction Steps

1. Use `InMemoryVectorStore` as the vector store backend
2. Call a Searcher method (e.g., `search_memories`) on a non-existent collection
3. Observe the exception type raised

**Expected**: `CollectionNotFoundError` should be raised
**Actual**: Raw `ValueError` propagates to caller

## Code Locations

### InMemoryVectorStore error message

**File**: `src/clams/storage/memory.py`
**Lines**: 34, 46, 69, 114, 130, 157, 170

```python
raise ValueError(f"Collection {name} does not exist")
```

### Searcher error conversion logic

**File**: `src/clams/search/searcher.py`
**Lines**: 141, 214, 293, 358, 425

```python
except ValueError as e:
    if "collection not found" in str(e).lower():
        raise CollectionNotFoundError(...)
    raise
```

## Analysis

The Searcher checks for `"collection not found"` in the error message, but InMemoryVectorStore uses `"does not exist"`. Since `"collection not found"` is NOT a substring of `"Collection X does not exist"`, the conversion never happens.

**Impact**:
- Callers expecting `CollectionNotFoundError` get unexpected `ValueError`
- Error handling logic breaks
- Tests using mocks pass (they use the expected message) but real usage fails

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [ ] Steps reproduced bug

**Observations during reproduction**:
[What did you observe when reproducing?]

### Initial Hypothesis

[What do you believe is causing this bug? Be specific: file, function, line.]

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | [Hypothesis A] | [Observable X] | [Observable Y] | [What you saw] | [Eliminated/Confirmed/Pending] |

### Evidentiary Scaffold

**Logging/assertions added**:
```python
# Location: file.py:123
# Purpose: Distinguish between hypothesis 1 and 2
logger.debug(f"State at critical point: {state}")
```

**Test command**:
```bash
[Command to run with scaffold in place]
```

**Captured output**:
```
[Actual output from scaffold run]
```

### Root Cause (Proven)

**The bug is caused by**: [Specific root cause]

**Evidence**: [What proves this is the cause]

**Why alternatives were eliminated**:
- Hypothesis 1 eliminated because: [reason with evidence]

---

## Fix Plan

### Code Changes

Option A (preferred): Update InMemoryVectorStore to match expected message
1. **File**: `src/clams/storage/memory.py`
   **Change**: Replace `"does not exist"` with `"not found"`
   **Rationale**: Matches what Searcher expects

Option B: Update Searcher to handle both messages
1. **File**: `src/clams/search/searcher.py`
   **Change**: Check for both `"not found"` and `"does not exist"`
   **Rationale**: More robust but requires changes in multiple places

### Regression Test

**Test file**: `tests/test_bug_024_regression.py`

**Test should**:
1. Use actual InMemoryVectorStore (not mock)
2. Call Searcher method on non-existent collection
3. Verify `CollectionNotFoundError` is raised

**Test outline**:
```python
async def test_bug_024_inmemory_raises_collection_not_found():
    # Setup: create Searcher with InMemoryVectorStore
    vector_store = InMemoryVectorStore()
    searcher = Searcher(vector_store, embedder)

    # Action & Assert: should raise CollectionNotFoundError
    with pytest.raises(CollectionNotFoundError):
        await searcher.search_memories("query")
```

### Verification

After implementing the fix:
```bash
# Run specific test
pytest tests/test_bug_024_regression.py -xvs

# Run full test suite
pytest -xvs
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
