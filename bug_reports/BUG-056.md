# BUG-056: Pre-commit hook for subprocess.run stdin

## Reported

- **First noticed on commit**: Multiple sessions (see retrospective-2025-12-14.md Theme 2)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-14
- **Severity**: medium

## Reproduction Steps

1. Write code using `subprocess.run()` without `stdin=subprocess.DEVNULL`
2. Code passes review and gets merged
3. Tests hang when subprocess waits for stdin input

**Expected**: Code that uses `subprocess.run()` without explicit stdin handling should be caught before commit.
**Actual**: Unsafe subprocess calls slip through, causing test hangs.

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
- Session cfc84635: GitPython processes hung waiting for input
- Session 4d7a8fb2: subprocess calls without stdin=DEVNULL caused hangs

### Initial Hypothesis

No static analysis or pre-commit hook exists to check for `subprocess.run()` calls without stdin handling.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | No pre-commit hook for subprocess | Unsafe calls pass | Hook rejects unsafe calls | Checked .pre-commit-config.yaml - no such check | Confirmed |

### Root Cause (Proven)

**The bug is caused by**: No automated check for `subprocess.run()` calls that don't specify stdin handling.

**Evidence**: Multiple sessions had hangs caused by subprocess calls waiting for stdin.

---

## Fix Plan

### Code Changes

1. **File**: `.pre-commit-config.yaml`
   **Change**: Add a custom hook that greps for subprocess.run patterns without stdin:
   ```yaml
   - repo: local
     hooks:
       - id: subprocess-stdin-check
         name: Check subprocess.run has stdin handling
         entry: bash -c 'grep -rn "subprocess\.run\|subprocess\.Popen" --include="*.py" src/ tests/ | grep -v "stdin=" && echo "ERROR: subprocess calls must specify stdin=subprocess.DEVNULL or stdin=subprocess.PIPE" && exit 1 || exit 0'
         language: system
         types: [python]
   ```
   **Rationale**: Prevents unsafe subprocess calls at commit time

2. **File**: `docs/CONTRIBUTING.md` (if exists)
   **Change**: Document the requirement for stdin handling in subprocess calls
   **Rationale**: Educates developers about the requirement

### Alternative Implementation

A more sophisticated approach using AST analysis:

```python
# .claude/hooks/check_subprocess.py
import ast
import sys

class SubprocessChecker(ast.NodeVisitor):
    def __init__(self, filename):
        self.filename = filename
        self.errors = []

    def visit_Call(self, node):
        if isinstance(node.func, ast.Attribute):
            if node.func.attr in ('run', 'Popen', 'call', 'check_call', 'check_output'):
                # Check if stdin is specified
                has_stdin = any(kw.arg == 'stdin' for kw in node.keywords)
                if not has_stdin:
                    self.errors.append(
                        f"{self.filename}:{node.lineno}: subprocess.{node.func.attr}() missing stdin= argument"
                    )
        self.generic_visit(node)
```

### Regression Test

Manual verification:
1. Pre-commit hook rejects code with `subprocess.run("cmd")` without stdin
2. Pre-commit hook accepts code with `subprocess.run("cmd", stdin=subprocess.DEVNULL)`
3. Pre-commit hook accepts code with `subprocess.run("cmd", stdin=subprocess.PIPE)`

### Verification

After implementing the fix:
```bash
# Test that unsafe code is rejected
echo 'import subprocess; subprocess.run(["ls"])' > /tmp/test.py
pre-commit run subprocess-stdin-check --files /tmp/test.py

# Test that safe code is accepted
echo 'import subprocess; subprocess.run(["ls"], stdin=subprocess.DEVNULL)' > /tmp/test.py
pre-commit run subprocess-stdin-check --files /tmp/test.py
```

---

## Implementation (filled by Implementer)

- **Implemented by**: W-1765688937-35828
- **Commit**: 6253951, 5d124cb
- **Regression test file**: tests/hooks/test_bug_056_regression.py

### Changes Made

1. **Created `.pre-commit-config.yaml`**: New pre-commit configuration file that references the AST-based subprocess checker hook.

2. **Created `.claude/hooks/check_subprocess.py`**: AST-based checker that:
   - Parses Python files and walks the AST
   - Detects calls to subprocess.run, Popen, call, check_call, check_output
   - Verifies each call has stdin= or input= parameter
   - Reports all issues with file:line:col format
   - Returns exit code 1 if issues found, 0 if clean

3. **Fixed existing subprocess calls** (added `stdin=subprocess.DEVNULL`):
   - `scripts/verify_install.py`: line 32
   - `tests/hooks/test_bug_050_regression.py`: lines 31, 72, 96
   - `tests/gates/test_check_types.py`: line 28
   - `tests/server/test_bug_042_regression.py`: lines 39, 79, 105, 113, 134

4. **Created regression test** `tests/hooks/test_bug_056_regression.py` with 8 tests:
   - Verifies checker detects missing stdin
   - Verifies checker accepts stdin=DEVNULL
   - Verifies checker accepts stdin=PIPE
   - Verifies checker accepts input= parameter
   - Verifies checker detects Popen without stdin
   - Verifies checker detects call without stdin
   - Verifies checker reports multiple issues
   - Verifies pre-commit config exists with subprocess hook

Note: Used the more sophisticated AST-based approach (Alternative Implementation) from the fix plan rather than the simple grep-based hook, as it provides more accurate detection and better error messages.

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
