# BUG-009: validate_value returns internal server error

## Reported

- **First noticed on commit**: fac4624 (main)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-07
- **Severity**: medium

## Reproduction Steps

1. Start the learning-memory-server MCP server
2. Call the `validate_value` tool:
   ```json
   {
     "text": "Always test each component individually before integration",
     "cluster_id": "full_0"
   }
   ```
3. Observe the response

**Expected**: A validation result indicating whether the value statement is valid for the cluster

**Actual**: Returns `{"error": {"type": "internal_error", "message": "Internal server error"}}`

## Technical Details

Related tools status:
- `get_clusters` - works (returns "insufficient data" when < 20 experiences)
- `get_cluster_members` - works (returns empty list)
- `store_value` - also fails with internal server error (BUG-010)
- `list_values` - works (returns empty list)
- `search_experiences` - works

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced by code trace

**Observations during reproduction**:
- The MCP tool `validate_value` calls `value_store.validate_value_candidate()` in `src/learning_memory_server/values/store.py`
- This method calls `_get_cluster()` → `get_clusters()` → `clusterer.cluster_axis()`
- With < 20 experiences, HDBSCAN may fail or return 0 clusters, causing an uncaught exception

### Initial Hypothesis

The `validate_value` MCP tool fails because `ValueStore.get_clusters()` does not check for minimum experience count before attempting to cluster.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | `ValueStore.get_clusters()` missing min experience count check | No check in `store.py` `get_clusters()` method; `learning.py` `get_clusters` tool has the check | Check exists in `ValueStore` | Confirmed: `store.py:58-99` has no count check; `learning.py:63-68` has check for >= 20 | **CONFIRMED** |
| 2 | HDBSCAN fails with insufficient data | HDBSCAN raises exception or returns unexpected results | HDBSCAN handles small datasets gracefully | HDBSCAN can run but may return 0 clusters (all noise) with small data | **PARTIAL** |
| 3 | Missing error handling in call chain | No try/except in `validate_value_candidate` | Proper exception handling exists | No exception handling for insufficient data case in `store.py:154-211` | **CONFIRMED** |

### Root Cause (Proven)

**Root cause**: `ValueStore.get_clusters()` (in `src/learning_memory_server/values/store.py` lines 58-99) does not validate minimum experience count before calling `clusterer.cluster_axis()`.

**Evidence**:
1. The MCP tool `get_clusters` (in `src/learning_memory_server/server/tools/learning.py` lines 63-68) correctly checks for >= 20 experiences and raises `InsufficientDataError`
2. The `ValueStore.get_clusters()` method bypasses this check and directly calls `clusterer.cluster_axis()` at line 80
3. When `validate_value` is called, it triggers: `validate_value_candidate()` → `_get_cluster()` → `get_clusters()` → `cluster_axis()`
4. With < 20 experiences, clustering may fail or return unexpected results, causing an unhandled exception that bubbles up as "internal_error"

**Why the MCP tool returns "internal_error"**:
- The exception from insufficient data is caught by the generic `except Exception` handler in `learning.py:297-304`
- This logs the error but returns a generic "internal_error" response instead of a meaningful error message

---

## Fix Plan

### Code Changes

1. **Add minimum experience count check to `ValueStore.get_clusters()`**:
   - File: `src/learning_memory_server/values/store.py`
   - Location: Lines 58-99 (in `get_clusters` method)
   - Change: Add count check before calling `cluster_axis()`:
     ```python
     # Check if enough experiences exist for clustering
     experience_count = await self.clusterer.count_experiences(axis)
     if experience_count < 20:
         raise ValueError(
             f"Not enough experiences for clustering. "
             f"Found {experience_count}, need at least 20."
         )
     ```

2. **Alternative: Handle ValueError in `validate_value_candidate()`**:
   - File: `src/learning_memory_server/values/store.py`
   - Location: Lines 154-211 (in `validate_value_candidate` method)
   - Change: Wrap `_get_cluster()` call in try/except to catch `ValueError` and return a more specific ValidationResult
   - This provides a better user experience by returning validation failure instead of error

**Recommended approach**: Implement both changes for defense in depth:
- Change #1 ensures `ValueStore.get_clusters()` enforces the same business rule as the MCP tool
- Change #2 provides graceful degradation with a user-friendly error message

### Regression Test

Add test case in `tests/learning_memory_server/values/test_store.py`:

```python
async def test_validate_value_with_insufficient_experiences():
    """Test that validate_value returns appropriate error when < 20 experiences exist."""
    # Setup: Create ValueStore with empty or small dataset
    # Action: Call validate_value_candidate with valid cluster_id
    # Assert: Should raise ValueError or return ValidationResult with valid=False
    #         Should NOT raise generic Exception
```

### Verification

1. Run existing tests: `pytest tests/learning_memory_server/values/ -v`
2. Add regression test and verify it fails before fix
3. Apply fix and verify regression test passes
4. Manually test the `validate_value` MCP tool with < 20 experiences
5. Verify error message is clear and actionable (not "internal_error")

---

## Implementation (filled by Implementer)

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
