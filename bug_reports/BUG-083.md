# Bug Report: BUG-083

## Title
Inconsistent error handling patterns across MCP tool categories

## First Noticed On Commit
9eb86cd (Merge task BUG-082)

## Reproduction Steps
1. Call a memory tool (e.g., `store_memory`) with invalid input (bad category)
2. Observe: raises `ValidationError` exception
3. Call a GHAP tool (e.g., `start_ghap`) with invalid input (bad domain)
4. Observe: returns `{"error": {"type": "validation_error", "message": "..."}}`
5. MCP dispatcher catches the exception from step 2 and returns `"Error: ..."` plain text
6. Consumer sees different error shapes depending on which tool category was called

## Expected Behavior
All tools should return errors in the same format: structured error dicts
`{"error": {"type": "...", "message": "..."}}` so consumers get a consistent
response shape regardless of tool category.

## Actual Behavior
Two conventions coexist:
- **GHAP & Learning tools**: Return structured error dicts (correct pattern)
- **Memory, Code, Git, Context, Session, Journal tools**: Raise `MCPError` or
  `ValidationError` exceptions, which the server dispatcher catches and converts
  to a plain `"Error: ..."` string (losing error type information)

## Root Cause
The tools were implemented at different times. GHAP and learning tools were
designed with internal try/except blocks returning `_error_response()` dicts.
Memory, code, git, context, session, and journal tools were designed to raise
exceptions, relying on the server dispatcher's generic catch-all.

This resulted in:
- Memory tools: `raise ValidationError(...)` / `raise MCPError(...)`
- Code tools: `raise ValidationError(...)` / `raise MCPError(...)`
- Git tools: `raise MCPError(...)` / `raise ValidationError(...)`
- Context tools: `raise ValidationError(...)`
- Session tools: `raise ValidationError(...)`
- Journal tools: `raise ValidationError(...)` / `raise MCPError(...)`

The server dispatcher at `app.py:764` catches all exceptions and converts them
to `f"Error: {str(e)}"` -- a plain string that loses the error type and the
structured format.

## Fix Plan
1. Add `_error_response()` helper to each tool module that lacks it
2. Wrap each tool function body in try/except blocks:
   - `except ValidationError as e:` -> `return _error_response("validation_error", str(e))`
   - `except Exception as e:` -> `return _error_response("internal_error", f"...")`
3. For git tools: `raise MCPError("not available")` -> `return _error_response("not_available", "...")`
4. Remove `MCPError` imports from all tool modules (keep `errors.py` definition as safety net)
5. Keep server-level exception handler as a safety net for truly unexpected errors
6. Update all tests that expected `pytest.raises(ValidationError/MCPError)` to check
   for structured error dicts instead

### Files Changed
- `src/calm/tools/memory.py` - Wrap all tools in try/except, return error dicts
- `src/calm/tools/code.py` - Wrap all tools in try/except, return error dicts
- `src/calm/tools/git.py` - Convert MCPError raises to error dict returns
- `src/calm/tools/context.py` - Wrap tool in try/except, return error dicts
- `src/calm/tools/session.py` - Wrap should_check_in validation in try/except
- `src/calm/tools/journal.py` - Wrap all tools in try/except, return error dicts
- `src/calm/tools/ghap.py` - Remove MCPError import, convert persist failure to error dict
- Tests: Updated ~16 test files to check for error dicts instead of raised exceptions
- `tests/test_bug_083_regression.py` - 24 new regression tests covering all tool categories
