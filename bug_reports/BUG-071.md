# BUG-071: Session start hook not using configurable port and host

## Reported

- **First noticed on commit**: d2886d0 (Merge task SPEC-040)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-17
- **Severity**: medium

## Reproduction Steps

1. Run: `pytest tests/infrastructure/test_shell_parity.py::TestShellScriptConfiguration -v`
2. Observe the test failures

**Expected**:
- `clams/hooks/session_start.sh` should source `~/.clams/config.env` for configuration
- Port should come from `$CLAMS_HTTP_PORT` environment variable
- Host should come from `$CLAMS_HTTP_HOST` environment variable

**Actual**: Session start hook does not properly use configurable port and host

## Failing Tests

- `tests/infrastructure/test_shell_parity.py::TestShellScriptConfiguration::test_session_start_uses_configurable_port`
- `tests/infrastructure/test_shell_parity.py::TestShellScriptConfiguration::test_session_start_uses_configurable_host`

## Related Specs

- SPEC-024: Configuration Parity Verification
- SPEC-029: Canonical Configuration Module

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug - tests failed as described

### Root Cause (Proven)

**The bug is caused by**: The test pattern was too strict. The tests expected a specific pattern like `SERVER_PORT="${CLAMS_PORT:-6334}"` (direct assignment with default), but `session_start.sh` uses a valid two-step pattern:

1. `CLAMS_HTTP_PORT="${CLAMS_HTTP_PORT:-6334}"` (fallback default)
2. `SERVER_PORT="${CLAMS_HTTP_PORT}"` (use the variable)

This two-step pattern is actually more robust because:
- It sources `config.env` first (if available)
- Falls back to defaults if the variable isn't set
- Assigns to `SERVER_PORT` from the (now definitely set) variable

**This is NOT a code bug in session_start.sh** - the shell script correctly implements configurable port/host. This is a **test pattern bug** where the regex was too restrictive.

---

## Fix Plan

1. [x] Update test patterns to recognize both:
   - Direct pattern: `SERVER_PORT="${...:-6334}"`
   - Indirect pattern: `CLAMS_HTTP_PORT="${CLAMS_HTTP_PORT:-6334}"`
2. [x] Same for host configuration
3. [x] Add docstring explaining both valid patterns
4. [x] Verify fix with: `pytest tests/infrastructure/test_shell_parity.py::TestShellScriptConfiguration -v`
