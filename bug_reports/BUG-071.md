# Bug Report: BUG-071

## Title
No CLI command to get next available task ID

## First Noticed On Commit
4145288 (current HEAD of main)

## Reproduction Steps
1. Have completed tasks in database (e.g., BUG-001 through BUG-066)
2. Run `calm task list` — shows "No tasks found" (filters out DONE tasks)
3. Try to create a new bug — must guess the ID or query SQLite directly

## Expected Behavior
A way to determine the next available task ID without direct database access:
- `calm task list --all` to include completed tasks, or
- `calm task next-id --prefix BUG` returning e.g. `BUG-067`

## Actual Behavior
`calm task list` only shows active-phase tasks. The only way to find the max ID is:
```sql
sqlite3 ~/.calm/metadata.db "SELECT id FROM tasks WHERE id LIKE 'BUG-%' ORDER BY id;"
```

## Reproduction Confirmation

Reproduced from the BUG-071 worktree:
```
$ cd /Users/elliotmilco/Documents/GitHub/clams/.worktrees/BUG-071
$ calm task list
No tasks found.
$ calm task list --include-done
No tasks found.
```

And from the main repo:
```
$ cd /Users/elliotmilco/Documents/GitHub/clams
$ calm task list
ID              Phase           Type       Title
----------------------------------------------------------------------
BUG-071         REPORTED        bug        No CLI command to get next available task ID
... (5 active tasks shown)
$ calm task list --include-done
json.decoder.JSONDecodeError  (unrelated data issue in blocked_by field)
```

## Root Cause

There are **two distinct issues** causing the reported friction:

### Issue 1 (Primary): `list_tasks` uses worktree path for project filtering

**Root cause**: `detect_project_path()` in `src/calm/orchestration/project.py` calls `git rev-parse --show-toplevel`, which returns the worktree path when run from a worktree (e.g., `/Users/elliotmilco/Documents/GitHub/clams/.worktrees/BUG-071`). However, all tasks are stored with the main repo path (`/Users/elliotmilco/Documents/GitHub/clams`). The SQL query in `list_tasks()` (line 192 of `tasks.py`) filters by `WHERE project_path = ?`, so zero rows match.

**Evidence**:
- From worktree: `git rev-parse --show-toplevel` returns `.worktrees/BUG-071` path
- DB query: `SELECT id, project_path FROM tasks` shows all tasks have `project_path=/Users/elliotmilco/Documents/GitHub/clams`
- Calling `list_tasks(project_path='/Users/elliotmilco/Documents/GitHub/clams', include_done=False)` from the worktree correctly returns 5 tasks

**Why this is the primary cause**: The reporter was running `calm task list` from a worktree directory. Even if `--include-done` were used, zero results would be returned.

### Issue 2 (Secondary): `--include-done` flag is undocumented

The `--include-done` flag already exists in the CLI (added at line 48 of `src/calm/cli/task.py`), and the `list_tasks()` function supports the `include_done` parameter (line 174 of `tasks.py`). However, this flag is not documented in CLAUDE.md's CLI reference section. The CLI reference shows:
```
calm task list [--phase <phase>] [--type <feature|bug>]
```
Missing: `[--include-done]`

### Eliminated Hypotheses

- **"No --all flag exists"**: Incorrect framing. The `--include-done` flag already provides this functionality. The issue is that it's undocumented AND a deeper project_path bug prevents it from working in worktrees.
- **"The SQL query is wrong"**: The SQL is correct. The problem is the input (`project_path`) is wrong when called from a worktree.
- **"The database schema is missing data"**: All tasks have correct data. The filtering parameter is the issue.

## Fix Plan

Three fixes required: (1) use main repo path for project filtering in tasks.py, (2) document --include-done flag in CLAUDE.md, (3) optionally add next-id subcommand.

### Fix 1: Use main repo path for project filtering (required)

**File**: `src/calm/orchestration/tasks.py`, function `list_tasks()` (line 188-190)

**Change**: When `project_path` is auto-detected, use `detect_main_repo()` instead of `detect_project_path()` so that queries from worktrees find tasks stored under the main repo path.

```python
# Before (line 189-190):
if project_path is None:
    project_path = detect_project_path()

# After:
if project_path is None:
    from calm.orchestration.project import detect_main_repo
    project_path = detect_main_repo()
```

**Scope note**: This same pattern affects `create_task()` (line 103-104). The fix should be applied consistently: `list_tasks` and `get_task` should use `detect_main_repo()` to ensure tasks created from the main repo are visible from worktrees. However, `create_task()` may need to stay with `detect_project_path()` if tasks should record which worktree created them -- but looking at the data, all tasks use the main repo path, so `detect_main_repo()` should be used in `create_task()` as well for consistency.

Functions to update:
- `list_tasks()` -- line 189
- `create_task()` -- line 103
- `get_task()` -- already takes explicit project_path, but its callers may need updating

### Fix 2: Document `--include-done` in CLAUDE.md (required)

**File**: `CLAUDE.md`, CLI reference section

**Change**: Update the task list command documentation:
```
# Before:
calm task list [--phase <phase>] [--type <feature|bug>]

# After:
calm task list [--phase <phase>] [--type <feature|bug>] [--include-done]
```

### Fix 3: Add `calm task next-id` subcommand (optional, nice-to-have)

**File**: `src/calm/cli/task.py`

**Change**: Add a new `next-id` subcommand that queries the max numeric ID for a given prefix and returns the next one:

```python
@task.command("next-id")
@click.argument("prefix", type=click.Choice(["BUG", "SPEC"]))
def next_id(prefix: str) -> None:
    """Get the next available task ID for a prefix."""
    # Query max ID matching prefix pattern
    # Parse numeric suffix
    # Return prefix-NNN+1
```

This is lower priority since `--include-done` combined with Fix 1 provides a workable path.

### Regression Test Requirements

1. **Test `list_tasks` from worktree context**: Mock `detect_main_repo()` to return the main repo path and verify tasks created with that path are returned.
2. **Test `--include-done` flag**: Create tasks in DONE and active phases, verify `include_done=True` returns all, `include_done=False` excludes DONE.
3. **Test `next-id` subcommand** (if implemented): Verify correct ID generation with gaps, empty database, and mixed prefixes.
