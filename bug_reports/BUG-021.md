# BUG-021: search_experiences returns internal server error

## Reported

- **First noticed on commit**: 722c1b07ca0274746cdc7505599e7a87235fea4e
- **Reported by**: orchestrator
- **Reported at**: 2025-12-08T18:00:00Z
- **Severity**: high

## Reproduction Steps

1. Start the clams MCP server
2. Call `search_experiences` tool with parameters `{"query": "debugging memory issues", "limit": 5}`
3. Observe the response

**Expected**: A JSON response with matching experiences (or empty list if none match)
**Actual**: `{"error": {"type": "internal_error", "message": "Internal server error"}}`

## Notes

- Related to other clustering/values tool failures
- May share common root cause with BUG-015, BUG-016, BUG-017, BUG-018, BUG-019, BUG-020
- search_experiences requires resolved GHAP entries to search over

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
Unit tests pass because they use mocks. The actual bug manifests when the MCP server tries to serialize `ExperienceResult` dataclass objects to JSON. The dispatcher in `src/clams/server/tools/__init__.py` uses `json.dumps(result, default=str)` which converts non-serializable objects to their string representation instead of proper JSON objects.

### Initial Hypothesis

The bug is in `src/clams/server/tools/search.py` at line 103. The `search_experiences` tool returns a dict with `"results": results` where `results` is a list of `ExperienceResult` dataclass objects. When the MCP dispatcher tries to serialize this to JSON (in `src/clams/server/tools/__init__.py` line 871), the dataclass objects cannot be serialized and get converted to string representations via the `default=str` parameter, producing malformed JSON that causes an internal server error.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | Dataclass serialization issue: `ExperienceResult` objects not converted to dicts | String representations like `"ExperienceResult(id='...')"` in serialized output, other search tools (memory, code) convert to dicts before returning | Proper JSON objects with field names as keys | Test script shows dataclass converts to string repr with `json.dumps(obj, default=str)`. Memory tools return plain dicts (line 153-159 of memory.py) | **CONFIRMED** |
| 2 | Missing collection: `ghap_full` collection doesn't exist in Qdrant | `CollectionNotFoundError` exception, error would mention "collection not found" | No collection-related errors, different error type | No evidence of collection errors in the code path | Eliminated |
| 3 | Embedding service failure: Query embedding fails | `EmbeddingError` exception from `searcher.search_experiences()` | Different error type | No embedding errors in exception flow | Eliminated |
| 4 | Invalid query parameters: Validation fails on axis/domain/outcome | `ValidationError` with specific validation message | Internal server error without validation context | Bug report shows generic "internal server error" not validation error | Eliminated |

### Evidentiary Scaffold

**Test script created**: `test_serialization.py`
```python
"""Quick test to reproduce the serialization issue."""
import json
from dataclasses import dataclass
from datetime import datetime

@dataclass
class TestResult:
    """Test dataclass."""
    id: str
    score: float
    created_at: datetime

# Try to serialize a dataclass
result = TestResult(
    id="test-123",
    score=0.95,
    created_at=datetime.now(),
)

response = {
    "results": [result],
    "count": 1,
}

# This is what the dispatcher does
try:
    serialized = json.dumps(response, default=str)
    print("Serialization succeeded:")
    print(serialized)
except Exception as e:
    print(f"Serialization failed: {e}")
```

**Test command**:
```bash
cd /Users/elliotmilco/Documents/GitHub/clams/.worktrees/BUG-021 && python test_serialization.py
```

**Captured output**:
```
Serialization succeeded:
{"results": ["TestResult(id='test-123', score=0.95, created_at=datetime.datetime(2025, 12, 8, 13, 30, 16, 886949))"], "count": 1}
```

This confirms the dataclass gets converted to a string representation, not a proper JSON object. The client receives malformed JSON and returns an internal server error.

### Root Cause (Proven)

**The bug is caused by**: The `search_experiences` tool in `src/clams/server/tools/search.py` returns a list of `ExperienceResult` dataclass objects (line 87-93), but these dataclass objects are not serializable to JSON. When the MCP dispatcher tries to serialize the response with `json.dumps(result, default=str)` (line 871 of `__init__.py`), the dataclass objects get converted to their string representation instead of proper JSON objects, producing malformed output like `"ExperienceResult(id='...')"` instead of `{"id": "...", ...}`.

**Evidence**:
1. Test script confirms dataclasses serialize to string repr with `json.dumps(obj, default=str)`
2. Memory tools (working correctly) convert search results to plain dicts before returning (memory.py lines 153-159)
3. Code comparison shows search_experiences returns raw `ExperienceResult` objects while retrieve_memories returns formatted dicts

**Why alternatives were eliminated**:
- Hypothesis 2 (Missing collection) eliminated: No `CollectionNotFoundError` in the exception flow, searcher would catch and raise that specifically
- Hypothesis 3 (Embedding failure) eliminated: No `EmbeddingError` in the exception flow, searcher wraps embedding errors explicitly
- Hypothesis 4 (Validation error) eliminated: Bug shows "internal_error" not "validation_error", validation happens before searcher call

---

## Fix Plan

### Code Changes

1. **File**: `src/clams/server/tools/search.py`
   **Function**: `search_experiences` (async function within `get_search_tools`)
   **Change**: Convert `ExperienceResult` objects to dictionaries before returning
   **Rationale**: The MCP dispatcher requires JSON-serializable data. Following the pattern used in memory tools, convert dataclass objects to plain dicts.

   Replace lines 102-105:
   ```python
   return {
       "results": results,
       "count": len(results),
   }
   ```

   With:
   ```python
   # Format results as dictionaries for JSON serialization
   formatted = [
       {
           "id": r.id,
           "ghap_id": r.ghap_id,
           "axis": r.axis,
           "domain": r.domain,
           "strategy": r.strategy,
           "goal": r.goal,
           "hypothesis": r.hypothesis,
           "action": r.action,
           "prediction": r.prediction,
           "outcome_status": r.outcome_status,
           "outcome_result": r.outcome_result,
           "surprise": r.surprise,
           "root_cause": (
               {
                   "category": r.root_cause.category,
                   "description": r.root_cause.description,
               }
               if r.root_cause
               else None
           ),
           "lesson": (
               {
                   "what_worked": r.lesson.what_worked,
                   "takeaway": r.lesson.takeaway,
               }
               if r.lesson
               else None
           ),
           "confidence_tier": r.confidence_tier,
           "iteration_count": r.iteration_count,
           "score": r.score,
           "created_at": r.created_at.isoformat(),
       }
       for r in results
   ]

   return {
       "results": formatted,
       "count": len(formatted),
   }
   ```

### Regression Test

**Test file**: `tests/server/tools/test_search.py` (add to existing test suite)

**Test should**:
1. Call `search_experiences` and verify results are JSON-serializable dicts
2. Verify all fields are present and correctly typed
3. Would fail before fix (dataclass objects not serializable)

**Test outline**:
```python
@pytest.mark.asyncio
async def test_search_experiences_returns_serializable_dicts(
    tools: dict[str, Any]
) -> None:
    """Test BUG-021 regression: results must be JSON-serializable dicts."""
    import json

    tool = tools["search_experiences"]
    result = await tool(
        query="debugging patterns",
        axis="full",
    )

    # Verify structure
    assert "error" not in result
    assert "results" in result
    assert "count" in result

    # Verify results are serializable (this would fail with dataclass objects)
    try:
        json.dumps(result)
    except (TypeError, ValueError) as e:
        pytest.fail(f"Results not JSON serializable: {e}")

    # If there are results, verify they are dicts with correct fields
    if result["results"]:
        first_result = result["results"][0]
        assert isinstance(first_result, dict)
        assert "id" in first_result
        assert "ghap_id" in first_result
        assert "score" in first_result
        assert "created_at" in first_result
        # created_at should be ISO string, not datetime object
        assert isinstance(first_result["created_at"], str)
```

### Verification

After implementing the fix:
```bash
# Run the new regression test
pytest tests/server/tools/test_search.py::test_search_experiences_returns_serializable_dicts -xvs

# Run all search tool tests
pytest tests/server/tools/test_search.py -xvs

# Run full test suite
pytest -xvs
```

**Expected outcome**:
- Regression test passes (confirms results are JSON-serializable dicts)
- All existing search tool tests still pass
- MCP server can successfully handle `search_experiences` calls without internal errors

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
