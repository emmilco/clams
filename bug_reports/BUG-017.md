# BUG-017: get_clusters returns internal server error

## Reported

- **First noticed on commit**: 722c1b07ca0274746cdc7505599e7a87235fea4e
- **Reported by**: orchestrator
- **Reported at**: 2025-12-08T18:00:00Z
- **Severity**: high

## Reproduction Steps

1. Start the clams MCP server
2. Call `get_clusters` tool with parameter `{"axis": "full"}`
3. Observe the response

**Expected**: A JSON response with cluster information (or empty if no clusters exist)
**Actual**: `{"error": {"type": "internal_error", "message": "Internal server error"}}`

## Notes

- All clustering/values tools fail with the same internal server error
- This may be related to missing GHAP data (clustering requires resolved GHAP entries)
- `list_values` works but returns empty results

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
- Examined code flow in `src/clams/server/tools/learning.py` and `src/clams/clustering/experience.py`
- The test suite uses mocks that return 25 experiences, so tests pass
- The bug occurs in production when GHAP collections don't exist in Qdrant
- The error handling catches specific exception types but not Qdrant's `UnexpectedResponse`

### Initial Hypothesis

The `get_clusters` tool calls `count_experiences()` which attempts to scroll a non-existent Qdrant collection (`ghap_full`). The Qdrant client raises `UnexpectedResponse` (404), which is not caught by the specific exception handlers in `learning.py:107-116`, causing it to fall through to the generic `Exception` handler that returns "internal_error".

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | Collection doesn't exist, scroll() raises UnexpectedResponse (404) | Internal server error, not InsufficientDataError | ValidationError or InsufficientDataError | Bug report: "may be related to missing GHAP data" | **Confirmed** |
| 2 | count_experiences() raises before cluster_axis() | Error on count call | Error on clustering call | Line 63 calls count_experiences first | **Confirmed** |
| 3 | UnexpectedResponse not caught by specific handlers | Falls to generic Exception handler | Caught by specific handler | Lines 107-116 don't catch UnexpectedResponse | **Confirmed** |
| 4 | Network/connectivity issue with Qdrant | Connection errors for all tools | 404 errors only for GHAP tools | list_values works (returns empty) | **Eliminated** |
| 5 | Code logic error unrelated to collections | Fails regardless of data | Different with/without data | Specific to missing GHAP data | **Eliminated** |

### Evidentiary Scaffold

**Analysis performed**:
1. Traced code execution path:
   - `get_clusters()` → `count_experiences()` → `vector_store.scroll()` → Qdrant API call
2. Examined exception handling in `learning.py:107-124`
3. Referenced BUG-003 findings about Qdrant exception types
4. Verified test mocks bypass the real issue

**Evidence from code**:
```python
# src/clams/server/tools/learning.py:107-124
except (ValidationError, InsufficientDataError, NotFoundError) as e:
    # Specific error types handled here
    ...
except Exception as e:
    # UnexpectedResponse falls through here
    logger.error("learning.unexpected_error", ...)
    return _error_response("internal_error", "Internal server error")
```

**Evidence from BUG-003**:
- Qdrant server raises `UnexpectedResponse` for 404/409 HTTP errors
- `UnexpectedResponse` inherits from `ApiException`, NOT `ValueError` or other expected types
- This exception is not in the specific catch list at line 107

### Root Cause (Proven)

**The bug is caused by**: The `get_clusters` tool (and other learning tools) call `count_experiences()` which attempts to scroll non-existent GHAP collections (`ghap_full`, `ghap_strategy`, `ghap_surprise`, `ghap_root_cause`). When these collections are missing, the Qdrant client raises `UnexpectedResponse` (404 Not Found). This exception is NOT caught by the specific handlers at `learning.py:107-116` (`ValidationError`, `InsufficientDataError`, `NotFoundError`), so it falls through to the generic `Exception` handler at line 117, which returns an "internal_error" response.

**Evidence**:
1. **Code flow**: `get_clusters()` → line 63 calls `count_experiences()` → line 53 in `experience.py` calls `scroll()` on collection
2. **Missing collections**: GHAP data doesn't exist yet, so collections `ghap_full` etc. are not created
3. **Exception type**: From BUG-003, Qdrant raises `UnexpectedResponse` (subclass of `ApiException`) for 404 errors
4. **Handler mismatch**: `UnexpectedResponse` is not in the catch list at `learning.py:107`
5. **list_values works**: The "values" collection may exist but be empty, so it returns `{"results": [], "count": 0}` instead of an error

**Why alternatives were eliminated**:
- **Hypothesis 4 (connectivity)**: Eliminated because `list_values` successfully queries Qdrant and returns empty results
- **Hypothesis 5 (logic error)**: Eliminated because the bug is specifically triggered by missing GHAP collections, not a general code defect

---

## Fix Plan

### Code Changes

1. **File**: `src/clams/clustering/experience.py`
   **Function**: `count_experiences` (line 35)
   **Change**: Catch the Qdrant exception when collection doesn't exist and return 0 instead of raising
   **Rationale**: When GHAP collections don't exist, there are 0 experiences, which is a valid state. Returning 0 allows the caller to handle it gracefully (e.g., return InsufficientDataError)

   **Implementation**:
   ```python
   async def count_experiences(self, axis: str) -> int:
       if axis not in AXIS_COLLECTIONS:
           raise ValueError(...)

       collection = AXIS_COLLECTIONS[axis]
       try:
           results = await self.vector_store.scroll(
               collection=collection,
               limit=10000,
               with_vectors=False,
           )
           return len(results)
       except Exception as e:
           # Collection doesn't exist - no experiences yet
           if "not found" in str(e).lower() or "404" in str(e):
               return 0
           # Re-raise other errors (connectivity, etc.)
           raise
   ```

2. **File**: `src/clams/clustering/experience.py`
   **Function**: `cluster_axis` (line 60)
   **Change**: Catch collection not found exception and raise `ValueError` with clear message
   **Rationale**: Consistent with existing error handling pattern (line 108 already raises ValueError for no embeddings)

   **Implementation**:
   ```python
   async def cluster_axis(self, axis: str) -> list[ClusterInfo]:
       ...
       try:
           results = await self.vector_store.scroll(...)
       except Exception as e:
           # Collection doesn't exist yet
           if "not found" in str(e).lower() or "404" in str(e):
               raise ValueError(
                   f"No embeddings found for axis '{axis}' (collection: {collection})"
               )
           # Re-raise other errors
           raise

       if not results:
           raise ValueError(...)
   ```

### Regression Test

**Test file**: `tests/server/tools/test_bug_017_regression.py`

**Test should**:
1. Use a real QdrantVectorStore (in-memory mode) with NO GHAP collections created
2. Call `get_clusters` with axis="full"
3. Verify it returns InsufficientDataError, NOT internal_error
4. Would fail before fix (returns internal_error due to UnexpectedResponse)

**Test outline**:
```python
import pytest
from clams.clustering import Clusterer, ExperienceClusterer
from clams.server.tools.learning import get_learning_tools
from clams.storage.qdrant import QdrantVectorStore
from clams.values import ValueStore


@pytest.mark.asyncio
async def test_bug_017_regression_get_clusters_no_collection():
    """Test that get_clusters returns InsufficientDataError (not internal_error) when GHAP collections don't exist.

    Regression test for BUG-017 where missing GHAP collections caused
    UnexpectedResponse to fall through to generic Exception handler,
    returning "internal_error" instead of "insufficient_data".
    """
    # Setup: in-memory Qdrant with NO collections created
    vector_store = QdrantVectorStore(url=":memory:")
    clusterer = Clusterer()
    experience_clusterer = ExperienceClusterer(
        vector_store=vector_store,
        clusterer=clusterer,
    )

    # Mock embedder for ValueStore
    class MockEmbedder:
        async def embed(self, text: str):
            return [0.1] * 768

    value_store = ValueStore(
        embedding_service=MockEmbedder(),
        vector_store=vector_store,
        clusterer=experience_clusterer,
    )

    tools = get_learning_tools(experience_clusterer, value_store)
    get_clusters = tools["get_clusters"]

    # Action: call get_clusters on non-existent collection
    result = await get_clusters(axis="full")

    # Assert: should return insufficient_data error, NOT internal_error
    assert "error" in result, "Expected error response"
    assert result["error"]["type"] == "insufficient_data", \
        f"Expected insufficient_data, got {result['error']['type']}"
    assert "not enough experiences" in result["error"]["message"].lower(), \
        f"Expected 'not enough experiences' message, got: {result['error']['message']}"

    # Before fix, this would have returned:
    # {"error": {"type": "internal_error", "message": "Internal server error"}}
```

### Verification

After implementing the fix:
```bash
# Run specific test
pytest tests/server/tools/test_bug_017_regression.py -xvs

# Run all learning tool tests
pytest tests/server/tools/test_learning.py -xvs

# Run full test suite
pytest -xvs
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
