# BUG-026: Enum mismatch between JSON schema and validation code

## Reported

- **First noticed on commit**: e2fab06
- **Reported by**: orchestrator (bug hunt agent)
- **Reported at**: 2025-12-08
- **Severity**: critical

## Reproduction Steps

1. Call `start_ghap` tool with `domain: "optimization"` (which schema says is valid)
2. Observe validation error

**Expected**: Tool accepts "optimization" as valid domain
**Actual**: ValidationError - "optimization" not in allowed values

## Code Locations

### JSON Schema (advertised values)

**File**: `src/clams/server/tools/__init__.py`
**Lines**: 463, 586, 717

```python
# domain enum in schema
["debugging", "refactoring", "feature", "optimization", "testing", "documentation", "other"]
```

**Line**: 546

```python
# root_cause category enum in schema
["incomplete_information", "wrong_assumption", "unexpected_behavior", "environment_issue", "other"]
```

### Validation code (actual accepted values)

**File**: `src/clams/server/tools/enums.py`
**Lines**: 6-16

```python
# GHAPDomain enum
["debugging", "refactoring", "feature", "testing", "configuration", "documentation", "performance", "security", "integration"]
```

**Lines**: 32-42

```python
# RootCauseCategory enum
["wrong-assumption", "missing-knowledge", "oversight", "environment-issue", "misleading-symptom", "incomplete-fix", "wrong-scope", "test-isolation", "timing-issue"]
```

## Analysis

### Domain Mismatches

| Schema Says | Enum Accepts | Result |
|-------------|--------------|--------|
| `optimization` | NO | Rejected |
| `other` | NO | Rejected |
| `configuration` | NO (not in schema) | Hidden |
| `performance` | NO (not in schema) | Hidden |
| `security` | NO (not in schema) | Hidden |
| `integration` | NO (not in schema) | Hidden |

### Root Cause Category Mismatches

| Schema Says | Enum Accepts | Result |
|-------------|--------------|--------|
| `incomplete_information` | NO (uses `missing-knowledge`) | Rejected |
| `wrong_assumption` | NO (uses `wrong-assumption` with hyphen) | Rejected |
| `unexpected_behavior` | NO | Rejected |
| `environment_issue` | NO (uses `environment-issue` with hyphen) | Rejected |
| `other` | NO | Rejected |

**Impact**:
- MCP clients see schema and send valid-looking values
- Validation rejects them with confusing errors
- The API contract is broken

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [ ] Steps reproduced bug

**Observations during reproduction**:
[What did you observe when reproducing?]

### Initial Hypothesis

[What do you believe is causing this bug? Be specific: file, function, line.]

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | [Hypothesis A] | [Observable X] | [Observable Y] | [What you saw] | [Eliminated/Confirmed/Pending] |

### Evidentiary Scaffold

**Logging/assertions added**:
```python
# Location: file.py:123
# Purpose: Distinguish between hypothesis 1 and 2
logger.debug(f"State at critical point: {state}")
```

**Test command**:
```bash
[Command to run with scaffold in place]
```

**Captured output**:
```
[Actual output from scaffold run]
```

### Root Cause (Proven)

**The bug is caused by**: [Specific root cause]

**Evidence**: [What proves this is the cause]

**Why alternatives were eliminated**:
- Hypothesis 1 eliminated because: [reason with evidence]

---

## Fix Plan

### Code Changes

Option A (preferred): Generate schema from enums
1. **File**: `src/clams/server/tools/__init__.py`
   **Change**: Import enums and use `[e.value for e in GHAPDomain]` in schema
   **Rationale**: Single source of truth, can't drift

Option B: Update schema to match enums
1. **File**: `src/clams/server/tools/__init__.py`
   **Change**: Manually update schema enum values to match enums.py
   **Rationale**: Quick fix but prone to future drift

### Regression Test

**Test file**: `tests/test_bug_026_regression.py`

**Test should**:
1. Verify all schema enum values are accepted by validation
2. Verify all enum values are present in schema

**Test outline**:
```python
def test_bug_026_schema_matches_domain_enum():
    from clams.server.tools.enums import GHAPDomain
    from clams.server.tools import TOOL_DEFINITIONS

    # Get schema enum values
    schema_values = get_domain_enum_from_schema(TOOL_DEFINITIONS)

    # Get actual enum values
    enum_values = {e.value for e in GHAPDomain}

    # Assert: they match exactly
    assert schema_values == enum_values
```

### Verification

After implementing the fix:
```bash
# Run specific test
pytest tests/test_bug_026_regression.py -xvs

# Run full test suite
pytest -xvs
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
