# BUG-063: Add pre-merge conflict check

## Reported

- **First noticed on commit**: Multiple sessions (see retrospective-2025-12-14.md Theme 7)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-14
- **Severity**: medium

## Reproduction Steps

1. Work on task in worktree for extended period
2. Main branch diverges with commits from other tasks
3. Attempt merge with `claws-worktree merge`
4. Merge fails with conflicts
5. Resolution is time-consuming and error-prone

**Expected**: Before merge, check if conflicts will occur and warn/block.
**Actual**: Conflicts discovered only at merge time.

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
- Session a4f3b7d1: "Merge failed with 5 conflicting files"
- Session 8b91c3e2: "Spent significant time resolving conflicts that could have been caught earlier"
- Retrospective Theme 7: Merge/integration issues

### Initial Hypothesis

`claws-worktree merge` does not perform a pre-merge conflict check.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | No pre-merge check | Conflicts at merge time | Warning before merge | Reviewed claws-worktree - direct merge, no check | Confirmed |

### Root Cause (Proven)

**The bug is caused by**: `claws-worktree merge` performs merge directly without checking for conflicts first.

**Evidence**: Reviewed `.claude/bin/claws-worktree` - merge function runs `git merge` directly.

---

## Fix Plan

### Code Changes

1. **File**: `.claude/bin/claws-worktree`
   **Function**: merge section
   **Change**: Add pre-merge conflict detection:
   ```bash
   # Before merge
   echo "Checking for conflicts..."
   cd "$MAIN_REPO"
   git fetch origin main

   # Try merge with --no-commit to detect conflicts
   if ! git merge --no-commit --no-ff "worktrees/$task_id" 2>/dev/null; then
       echo "ERROR: Merge would result in conflicts"
       git merge --abort

       # Show which files conflict
       echo "Conflicting files:"
       git diff --name-only --diff-filter=U

       echo ""
       echo "Options:"
       echo "  1. Rebase worktree on main first"
       echo "  2. Resolve conflicts in worktree before merge"
       echo "  3. Use --force to attempt merge anyway"

       exit 1
   fi

   # Abort test merge, will do real merge
   git merge --abort

   # Proceed with real merge
   git merge --no-ff "worktrees/$task_id" -m "Merge $task_id"
   ```

2. **File**: `.claude/bin/claws-worktree`
   **Change**: Add `merge --check-only` option:
   ```bash
   claws-worktree merge TASK-001 --check-only

   # Output:
   # Merge check: OK (no conflicts detected)
   # OR
   # Merge check: CONFLICTS
   #   - src/api.py
   #   - tests/test_api.py
   ```

3. **File**: `.claude/bin/claws-worktree`
   **Change**: Add periodic conflict check reminder in health command

### Regression Test

Manual verification:
1. Create two worktrees modifying same file
2. Merge first worktree
3. Attempt merge of second worktree
4. Verify conflict warning is shown
5. Verify `--force` bypasses warning

### Verification

After implementing the fix:
```bash
# Test conflict check
.claude/bin/claws-worktree merge TASK-001 --check-only

# Test merge with potential conflicts
.claude/bin/claws-worktree merge TASK-001
```

---

## Implementation (filled by Implementer)

- **Implemented by**: W-1765692195-90818
- **Commit**: 925273f
- **Regression test file**: `tests/scripts/test_bug_063_merge_conflict_check.py`

### Changes Made

1. **File**: `.claude/bin/claws-worktree`
   - Added `check_merge_conflicts()` function (lines 141-178) that:
     - Uses `git merge --no-commit --no-ff` to test for conflicts
     - Captures list of conflicting files using `git diff --name-only --diff-filter=U`
     - Always aborts test merge with `git merge --abort` to restore clean state
     - Returns 0 for no conflicts, 1 for conflicts
   - Updated `cmd_merge()` function to:
     - Parse `--check-only` and `--force` options
     - Call `check_merge_conflicts()` before actual merge
     - Display conflicting files when conflicts detected
     - Provide resolution guidance (rebase, resolve, or --force)
     - Block merge unless `--force` is specified
   - Updated usage documentation in header and usage() function

2. **File**: `tests/scripts/test_bug_063_merge_conflict_check.py`
   - Created 9 regression tests verifying:
     - check_merge_conflicts function exists
     - Uses `git merge --no-commit` for safe testing
     - Aborts test merge to restore clean state
     - --check-only option supported
     - --force option supported
     - Shows conflicting file names
     - Provides resolution guidance
     - cmd_merge calls the conflict check
     - Usage documentation includes options

3. **Linter fixes** (pre-existing issues):
   - Removed unused `Mount` import from `src/clams/server/http.py`
   - Added `"generate_*.py" = ["E501"]` to `pyproject.toml` per-file-ignores

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
