# Bug Report: BUG-067

## Title
MCP server registration uses wrong transport and non-existent subcommand

## First Noticed On Commit
4145288 (current HEAD of main)

## Reproduction Steps
1. Run `calm install --dev` (or `scripts/install.sh`) on a fresh machine
2. Observe `~/.claude.json` after installation
3. Start a Claude Code session — MCP server fails to connect

## Expected Behavior
`~/.claude.json` should register the CALM MCP server with SSE transport:
```json
{"mcpServers": {"calm": {"type": "sse", "url": "http://127.0.0.1:6335/sse"}}}
```

## Actual Behavior
The installer (`src/calm/install/config_merge.py:256-270`) registers a command-based (stdio) server:
```json
{"mcpServers": {"calm": {"command": "uv", "args": ["run", "--directory", "...", "calm", "server", "run"]}}}
```

This fails for two reasons:
1. **Wrong transport**: The server (`src/calm/server/main.py`) uses `SseServerTransport("/sse")`, not stdio
2. **Non-existent subcommand**: `calm server run` doesn't exist in `src/calm/cli/server.py` — only `start`, `stop`, `status`, `restart`

## Reproduction

Confirmed by reading the source code:

1. `register_mcp_server()` in `src/calm/install/config_merge.py` (lines 256-270) builds a command list `["calm", "server", "run"]` (production) or `["uv", "run", "--directory", ..., "calm", "server", "run"]` (dev mode).
2. `merge_mcp_server()` (lines 91-119) takes this command list and creates a stdio-style registration: `{"command": server_command[0], "args": server_command[1:]}`.
3. The actual working config in `~/.claude.json` (lines 1366-1371) uses SSE transport: `{"type": "sse", "url": "http://127.0.0.1:6335/sse"}`.
4. The CLI (`src/calm/cli/server.py`) defines only `start`, `stop`, `status`, `restart` subcommands -- there is no `run` subcommand.

## Differential Diagnosis

### Hypothesis A: Wrong transport type (command/stdio vs SSE)
- **Evidence**: `config_merge.py` produces `{"command": "calm", "args": ["server", "run"]}` but the server (`src/calm/server/main.py` line 80) uses `SseServerTransport("/sse")`, which is HTTP-based, not stdio.
- **Verdict**: CONFIRMED. The server is SSE-only; registering it as command-based means Claude Code would try to launch it as a subprocess and communicate over stdin/stdout, which is incompatible.

### Hypothesis B: Non-existent subcommand
- **Evidence**: `src/calm/cli/server.py` defines `@server.command("start")`, `@server.command("stop")`, `@server.command("status")`, `@server.command("restart")`. There is no `@server.command("run")`.
- **Verdict**: CONFIRMED. Even if the transport type were correct, `calm server run` would fail with a Click error ("No such command 'run'").

### Hypothesis C: Could the server support stdio as a fallback?
- **Evidence**: `src/calm/server/main.py` only creates an `SseServerTransport` and runs it via `uvicorn.Server`. There is no `StdioServerTransport` import or usage anywhere in the server code.
- **Verdict**: ELIMINATED. The server has no stdio support.

### Hypothesis D: Could the registration be unused (dead code)?
- **Evidence**: `src/calm/install/steps.py` line 197 calls `register_mcp_server()` during the install flow (step 6/9). It is actively called by `calm install`.
- **Verdict**: ELIMINATED. The code is live and runs during installation.

## Root Cause

The bug has two independent defects, both in `src/calm/install/config_merge.py`:

1. **Wrong transport type**: `merge_mcp_server()` registers the CALM server as a command-based (stdio) MCP server by producing `{"command": ..., "args": [...]}`. The CALM server exclusively uses SSE transport (`SseServerTransport("/sse")` in `src/calm/server/main.py`). The correct registration format is `{"type": "sse", "url": "http://<host>:<port>/sse"}`.

2. **Non-existent subcommand**: The command list includes `"server", "run"`, but `src/calm/cli/server.py` only defines `start`, `stop`, `status`, and `restart` subcommands. Even if the transport type were correct, the command would fail.

**Evidence**: The working configuration in `~/.claude.json` (manually set) uses `{"type": "sse", "url": "http://127.0.0.1:6335/sse"}`, confirming the server expects SSE connections. The `settings` object in `src/calm/config.py` provides `server_host` (default `"127.0.0.1"`) and `server_port` (default `6335`) which should be used to construct the URL.

## Fix Plan

### 1. Change `merge_mcp_server()` signature and body

**File**: `src/calm/install/config_merge.py`
**Function**: `merge_mcp_server()` (lines 91-119)

Change the function signature from:
```python
def merge_mcp_server(
    config: dict[str, Any],
    server_command: list[str],
) -> dict[str, Any]:
```
to:
```python
def merge_mcp_server(
    config: dict[str, Any],
    sse_url: str,
) -> dict[str, Any]:
```

Change the server entry (lines 114-117) from:
```python
result["mcpServers"]["calm"] = {
    "command": server_command[0],
    "args": server_command[1:],
}
```
to:
```python
result["mcpServers"]["calm"] = {
    "type": "sse",
    "url": sse_url,
}
```

Update the docstring to reflect that `sse_url` is the SSE endpoint URL (e.g., `"http://127.0.0.1:6335/sse"`).

### 2. Change `register_mcp_server()` to build an SSE URL

**File**: `src/calm/install/config_merge.py`
**Function**: `register_mcp_server()` (lines 235-284)

Replace the server_command construction (lines 256-270) with:
```python
from calm.config import settings
sse_url = f"http://{settings.server_host}:{settings.server_port}/sse"
```

Replace the call to `merge_mcp_server` (line 276) from:
```python
updated = merge_mcp_server(config, server_command)
```
to:
```python
updated = merge_mcp_server(config, sse_url)
```

The `dev_mode` and `dev_directory` parameters can remain in the function signature for now (they are unused in the SSE approach since the URL is the same regardless), or they can be removed. The fix should remove them since they are no longer relevant -- the SSE URL is derived from settings, not from a command path. However, to minimize scope, keeping the signature stable and simply ignoring those parameters is acceptable. The implementer should decide.

### 3. Update tests in `tests/test_install/test_config_merge.py`

**Class `TestMergeMcpServer`** (lines 118-161):

- `test_empty_config`: Change call from `merge_mcp_server({}, ["uv", "run", "calm"])` to `merge_mcp_server({}, "http://127.0.0.1:6335/sse")`. Assert the result contains `{"type": "sse", "url": "http://127.0.0.1:6335/sse"}` instead of `command`/`args`.
- `test_preserves_other_servers`: Same signature change.
- `test_preserves_other_keys`: Same signature change.
- `test_updates_existing_calm`: Change to pass SSE URL; assert the result has `"type": "sse"` and the correct URL instead of `command`/`args`.
- `test_does_not_mutate_original`: Same signature change.

**Class `TestRegisterMcpServer`** (lines 229-263):

- `test_creates_file_if_missing`: Assert that the written config contains `{"type": "sse", "url": ...}` instead of `command`/`args`.
- `test_dev_mode_includes_directory`: This test no longer makes sense with SSE. Either remove it or update it to verify that `dev_mode=True` still produces a valid SSE URL (same URL, since it comes from settings). The test should verify the SSE format is used regardless of `dev_mode`.
- `test_dry_run_no_changes`: This test should remain largely unchanged.

### 4. Regression test requirements

Add a test that explicitly verifies the output format matches what Claude Code expects:
```python
def test_registered_server_uses_sse_transport(self, tmp_path: Path) -> None:
    """Registered server must use SSE transport, not command-based."""
    path = tmp_path / ".claude.json"
    register_mcp_server(path, dev_mode=False)
    config = json.loads(path.read_text())
    calm_entry = config["mcpServers"]["calm"]
    # Must have SSE fields
    assert calm_entry["type"] == "sse"
    assert "url" in calm_entry
    assert calm_entry["url"].endswith("/sse")
    # Must NOT have command-based fields
    assert "command" not in calm_entry
    assert "args" not in calm_entry
```

### 5. Verification

After applying the fix:
1. Run `pytest tests/test_install/test_config_merge.py -vvsx` -- all tests must pass
2. Run `calm install --dev --dry-run` and verify the output indicates SSE registration (no crash from missing subcommand)
3. Inspect the JSON that would be written to `~/.claude.json` and confirm it matches `{"type": "sse", "url": "http://127.0.0.1:6335/sse"}`
