# Bug Report: BUG-085

## Title
No MCP server reconnection after restart

## First Noticed On Commit
9eb86cd (Merge task BUG-082)

## Reproduction Steps
1. Start a Claude Code session with CALM MCP server running
2. Use MCP tools (e.g., store_memory, retrieve_memories) to verify they work
3. Restart the CALM MCP server: `calm server restart`
4. Attempt to use MCP tools again in the same Claude Code session
5. Observe that all MCP tool calls fail silently

## Expected Behavior
The session_start hook should detect when the MCP server process is alive but the HTTP endpoint is unresponsive (indicating a potential disconnect between Claude Code's MCP client and the server), and warn the user with clear instructions to restart.

## Actual Behavior
The session_start hook only checks if the server process is alive via PID file + `os.kill(pid, 0)`. This check passes even when the HTTP server is not responding to requests, or when Claude Code's MCP client has lost its connection after a restart. The user gets "CALM is available" with no indication that MCP tools are broken.

## Root Cause

The `is_server_running()` function in `src/calm/hooks/common.py` only performs a PID-based liveness check -- it verifies the process exists but does not verify the HTTP endpoint is actually responding. There are two distinct failure modes this misses:

1. **Server process alive but HTTP stuck**: The process exists but the Starlette/uvicorn HTTP layer is hung or crashed internally. PID check passes, but no requests are served.

2. **Server restarted, MCP client disconnected**: Claude Code's MCP client establishes a connection at session start and does not auto-reconnect. After `calm server restart`, the server is healthy and responding, but the MCP client's existing connection is broken. The hooks (which use direct DB/file access) continue working, masking the problem.

**Alternative hypotheses eliminated:**
- *Hooks are broken after restart*: No -- hooks use direct file/DB access, not MCP. They continue working correctly.
- *Server fails to start after restart*: No -- `calm server restart` works fine; the server responds to new HTTP connections. The issue is specifically the stale MCP client connection.
- *PID file is stale*: No -- `stop_server()` in `daemon.py` cleans up the PID file, and `start_daemon()` writes a fresh one.

## Fix Plan

Since we cannot fix Claude Code's MCP client reconnection behavior, we add detection and user guidance:

1. **Add `check_server_health()` to `src/calm/hooks/common.py`**: A lightweight HTTP health check that pings `http://{host}:{port}/health` with a 2-second timeout. Returns True if HTTP 200, False otherwise.

2. **Update `src/calm/hooks/session_start.py`**:
   - After `ensure_server_running()` succeeds (PID alive), call `check_server_health()`
   - If health check fails (process alive but HTTP unresponsive), set `server_unhealthy=True`
   - Update `format_output()` to accept `server_unhealthy` parameter
   - When unhealthy, display: "[WARNING] MCP server process is running but not responding. Run `calm server restart` and start a new Claude Code session."

3. **Regression tests**:
   - `check_server_health()` returns True when server responds with 200
   - `check_server_health()` returns False on connection refused / timeout / non-200
   - `check_server_health()` uses configured host/port from settings
   - `format_output()` includes warning when `server_unhealthy=True`
   - `main()` shows health warning when server process alive but HTTP fails
   - `main()` skips health check when server process is not running
