# BUG-016: resolve_ghap returns internal server error

## Reported

- **First noticed on commit**: 722c1b07ca0274746cdc7505599e7a87235fea4e
- **Reported by**: orchestrator
- **Reported at**: 2025-12-08T18:00:00Z
- **Severity**: high

## Reproduction Steps

1. Start the clams MCP server
2. Call `start_ghap` to create a new GHAP entry (this succeeds)
3. Call `resolve_ghap` with parameters like `{"status": "confirmed", "result": "Test completed"}`
4. Observe the response

**Expected**: A JSON response confirming the GHAP was resolved
**Actual**: `{"error": {"type": "internal_error", "message": "Internal server error"}}`

## Notes

- `start_ghap` works correctly and returns a valid GHAP ID
- `update_ghap` works correctly
- `get_active_ghap` works correctly
- Only `resolve_ghap` fails when trying to close a GHAP entry
- After calling `resolve_ghap` (even though it errors), `get_active_ghap` shows no active GHAP

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
- Called `start_ghap` successfully - GHAP created with ID
- Called `resolve_ghap` with status="confirmed" and result text
- Received internal server error response
- Called `get_active_ghap` - no active GHAP (it was cleared despite error)
- This confirms the bug: GHAP is cleared but persistence fails

### Initial Hypothesis

The GHAP collections (`ghap_full`, `ghap_strategy`, etc.) are not created during server initialization. When `resolve_ghap` tries to persist the entry via `ObservationPersister.persist()`, it attempts to upsert to non-existent collections, causing a Qdrant error which bubbles up as an internal server error.

**Location**: `src/clams/server/tools/__init__.py`, line 784-788
**Problem**: `ObservationPersister` is created but `await persister.ensure_collections()` is never called

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | Collections not created - `ensure_collections()` never called | Qdrant error when upserting to `ghap_full`, `ghap_strategy`, etc. | Different error or success | Code inspection: no call to `ensure_collections()` in server init | **Confirmed** |
| 2 | Embedding service not initialized | RuntimeError about registry not initialized | Collections error or success | Embedding service is passed to persister, registry initialized in main.py | Eliminated |
| 3 | GHAP cleared before persist succeeds | `get_active_ghap` returns None after error | GHAP still active after error | Bug report states GHAP is gone after error | **Confirmed (secondary issue)** |

### Evidentiary Scaffold

**Code inspection performed**:
1. Checked `src/clams/server/tools/__init__.py` lines 780-832 (server initialization)
2. Confirmed `ObservationPersister` is created at line 784
3. Confirmed `ObservationPersister.ensure_collections()` is NEVER called
4. Checked `src/clams/observation/persister.py` lines 128-161 (ensure_collections implementation)
5. Checked `src/clams/observation/persister.py` lines 58-104 (persist implementation that requires collections)
6. Checked `src/clams/observation/collector.py` lines 207-278 (resolve_ghap clears GHAP before return)
7. Checked `src/clams/server/tools/ghap.py` lines 360-405 (resolve_ghap calls collector.resolve_ghap THEN persister.persist)

**Evidence trail**:
- Server init creates `ObservationPersister` but never calls `ensure_collections()`
- `persist()` calls `vector_store.upsert()` on collections that don't exist
- Qdrant raises an error when trying to upsert to non-existent collection
- Error bubbles up as "internal server error" through MCP dispatcher (line 878 in __init__.py)
- Meanwhile, `collector.resolve_ghap()` has already cleared the GHAP (line 268 in collector.py)
- Result: GHAP lost, error returned to user

### Root Cause (Proven)

**Primary root cause**: Missing collection initialization during server startup.

The GHAP vector collections (`ghap_full`, `ghap_strategy`, `ghap_surprise`, `ghap_root_cause`) are never created when the MCP server starts. When `resolve_ghap` is called, the `ObservationPersister.persist()` method attempts to upsert entries to these non-existent collections, causing Qdrant to raise an error which is caught and returned as "internal server error".

**Location**: `src/clams/server/tools/__init__.py`, function `register_all_tools()`, lines 784-788

**Evidence**:
1. Code inspection shows `ObservationPersister` is instantiated but `await observation_persister.ensure_collections()` is never called
2. The `ensure_collections()` method exists in `ObservationPersister` (lines 128-161 in persister.py) and creates the required collections
3. The `persist()` method (lines 58-104 in persister.py) calls `vector_store.upsert()` which requires collections to exist
4. User reports "internal server error" when calling `resolve_ghap`, consistent with Qdrant error during upsert
5. User reports GHAP is gone after error, consistent with `collector.resolve_ghap()` clearing GHAP before `persister.persist()` runs

**Why alternatives were eliminated**:
- Hypothesis 2 (embedding service not initialized) eliminated because: Embedding registry is properly initialized in `main.py` line 160, and semantic embedder is correctly passed to `ObservationPersister` at line 785 in `__init__.py`
- Hypothesis 3 (GHAP cleared before persist) is a secondary issue, not the root cause - the GHAP is intentionally cleared by design, but the bug causes persist to fail before clearing should happen

---

## Fix Plan

### Code Changes

1. **File**: `src/clams/server/tools/__init__.py`
   **Function**: `register_all_tools()`
   **Line**: After line 788 (after creating `observation_persister`)
   **Change**: Add `await observation_persister.ensure_collections()` to create the GHAP vector collections during server initialization
   **Rationale**: This ensures the collections exist before any `resolve_ghap` calls attempt to persist entries, preventing the Qdrant error

### Regression Test

**Test file**: `tests/server/test_bug_016.py`

**Test should**:
1. Simulate server startup by creating an `ObservationPersister` without calling `ensure_collections()`
2. Attempt to resolve a GHAP (which triggers persist)
3. Verify that with the fix (collections created), the operation succeeds
4. Verify the GHAP is persisted to all applicable collections
5. Would fail before fix (missing collections cause Qdrant error)

**Test outline**:
```python
@pytest.mark.asyncio
async def test_bug_016_resolve_ghap_requires_collections():
    """Regression test for BUG-016: resolve_ghap needs collections initialized.

    Before fix: resolve_ghap fails with internal error because collections don't exist
    After fix: collections are created during init, resolve_ghap succeeds
    """
    # Setup: Create collector and persister with in-memory vector store
    collector = ObservationCollector(journal_dir=temp_path)
    vector_store = QdrantVectorStore(url=":memory:")
    embedder = NomicEmbedding(settings=EmbeddingSettings())
    persister = ObservationPersister(
        embedding_service=embedder,
        vector_store=vector_store,
    )

    # CRITICAL: Ensure collections exist (this is what the fix adds)
    await persister.ensure_collections()

    # Create and resolve a GHAP
    await collector.create_ghap(...)
    resolved = await collector.resolve_ghap(status="confirmed", result="Test")

    # Persist should succeed (would fail before fix)
    await persister.persist(resolved)

    # Verify entry was persisted to collections
    # (Check ghap_full and ghap_strategy collections have the entry)
    assert await vector_store.get(collection="ghap_full", id=resolved.id)
```

### Verification

After implementing the fix:
```bash
# Run regression test
pytest tests/server/test_bug_016.py -xvs

# Run all GHAP tool tests
pytest tests/server/tools/test_ghap.py -xvs

# Run full test suite
pytest -xvs

# Manual verification via MCP:
# 1. Start MCP server
# 2. Call start_ghap to create a GHAP
# 3. Call resolve_ghap with status="confirmed" and result="Test"
# 4. Verify no internal server error
# 5. Call get_active_ghap to confirm GHAP was resolved (should be None)
# 6. Call list_ghap_entries to verify entry was persisted
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
