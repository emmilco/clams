# BUG-053: Gate script timeout with force-kill

## Reported

- **First noticed on commit**: Multiple sessions (see retrospective-2025-12-14.md Theme 2)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-14
- **Severity**: high

## Reproduction Steps

1. Run gate check on code with async cleanup issues
2. All tests pass
3. pytest process hangs during shutdown
4. Gate check never completes

**Expected**: After tests complete, if the pytest process doesn't exit within N seconds (e.g., 30s), the gate should force-kill the pytest process and FAIL the gate (cleanup failure = resource leak = bug).
**Actual**: Gate check hangs indefinitely waiting for pytest to exit.

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
Sessions 43763784 and c97d59ea documented gate checks hanging after tests passed.

### Initial Hypothesis

`claws-gate` script runs pytest synchronously and waits indefinitely for it to complete. No timeout or watchdog mechanism exists.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | No timeout in gate script | Infinite hang | Timeout after N seconds | Reviewed claws-gate - no timeout logic | Confirmed |

### Root Cause (Proven)

**The bug is caused by**: claws-gate runs pytest with no post-completion timeout mechanism.

**Evidence**: Reviewed `.claude/bin/claws-gate` - pytest is run directly with no timeout wrapper.

---

## Fix Plan

### Code Changes

1. **File**: `.claude/bin/claws-gate`
   **Function**: pytest execution section
   **Change**: Wrap pytest execution with timeout mechanism:
   - Parse pytest output to detect when all tests have completed
   - Start a cleanup timer after tests complete
   - If process doesn't exit within 30 seconds after completion, force-kill
   - Mark gate as FAILED (not passed) since cleanup failure indicates a bug
   **Rationale**: Prevents indefinite hangs while correctly treating cleanup failures as bugs

### Implementation Notes

```bash
# Pseudocode for the fix
CLEANUP_TIMEOUT=30

# Run pytest and capture output
pytest ... 2>&1 | tee test_output.log &
PYTEST_PID=$!

# Wait for pytest to complete or timeout
if ! wait_with_timeout $PYTEST_PID $CLEANUP_TIMEOUT; then
    echo "ERROR: pytest cleanup hung for ${CLEANUP_TIMEOUT}s after tests completed"
    kill -9 $PYTEST_PID 2>/dev/null
    echo "Gate FAILED: Cleanup hang indicates resource leak"
    exit 1
fi
```

### Regression Test

Manual verification:
1. Gate script has configurable post-test timeout
2. Hung processes are force-killed after timeout
3. Gate fails when cleanup hangs (not silently passes)
4. Clear error message distinguishes cleanup hang from test failure

### Verification

After implementing the fix:
```bash
# Verify timeout is configurable
CLAWS_CLEANUP_TIMEOUT=5 .claude/bin/claws-gate check BUG-053 REPORTED-INVESTIGATED
```

---

## Implementation (filled by Implementer)

- **Implemented by**: W-1765688935-33279
- **Commit**: 76e56a1eb90b548faf68ffd82b81047525531b20
- **Regression test file**: `tests/gates/test_cleanup_timeout.py`

### Changes Made

**File: `.claude/gates/check_tests.sh`**

1. **Added configurable cleanup timeout** (lines 11-21):
   - New environment variable `CLAWS_CLEANUP_TIMEOUT` (default: 30 seconds)
   - Clear documentation in script header explaining the feature

2. **Added `run_with_cleanup_timeout()` function** (lines 191-269):
   - Runs pytest command in background
   - Monitors for pytest completion by looking for the summary line (`=== X passed in Y.YYs ===`)
   - After test completion detected, starts cleanup timer
   - If process doesn't exit within timeout, sends SIGTERM then SIGKILL
   - Returns 1 (failure) on timeout, preserving original exit code otherwise

3. **Modified pytest execution** (lines 285-332):
   - All three pytest invocation paths (uv, pip, direct) now use `run_with_cleanup_timeout()`
   - Tracks `cleanup_timeout` flag to distinguish timeout from test failure

4. **Added cleanup timeout error handling** (lines 383-406):
   - Clear error message explaining the issue
   - Debugging tips (async cleanup, threads, connections)
   - Logs timeout as an "error" in test_runs table
   - Distinct from test failures (tests passed but cleanup failed)

**Behavior changes:**
- Gate now fails (correctly) when cleanup hangs instead of hanging forever
- Clear error message distinguishes cleanup hang from test failure
- Timeout is configurable via `CLAWS_CLEANUP_TIMEOUT` environment variable

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
