# Bug Report: BUG-068

## Title
Docker container/volume name mismatch between installer and uninstaller

## First Noticed On Commit
4145288 (current HEAD of main)

## Reproduction Steps
1. Run `calm install` (creates Qdrant container via `src/calm/install/docker.py`)
2. Run `scripts/uninstall.sh` (tries to remove container)
3. Observe uninstaller reports "calm-qdrant container not found (skipping)"

## Expected Behavior
The uninstaller should find and remove the Docker container and volume created by the installer.

## Actual Behavior
- Installer creates: container `qdrant`, volume `qdrant_data` (`docker.py:128-138`)
- Uninstaller looks for: container `calm-qdrant`, volume `calm_qdrant_storage` (`uninstall.sh:146-161`)
- Names don't match â€” uninstaller silently skips cleanup

## Reproduction

Confirmed by reading the source code. The installer and uninstaller use entirely different names:

| Resource | `docker.py` (installer) | `uninstall.sh` | `docker-compose.yml` |
|----------|------------------------|-----------------|---------------------|
| Container name | `qdrant` | `calm-qdrant` | `calm-qdrant` |
| Volume name | `qdrant_data` | `calm_qdrant_storage` | `qdrant_storage` |

Three files, three different naming conventions. Any container created by `docker.py` will never be found or cleaned up by `uninstall.sh`.

## Differential Diagnosis

### Hypothesis A: The installer (`docker.py`) was written without awareness of the uninstaller's naming convention
- **Evidence for**: `docker.py` uses generic names (`qdrant`, `qdrant_data`) with no `calm-` prefix. The uninstaller and `docker-compose.yml` both use the `calm-qdrant` prefix for the container name, suggesting the prefix was the intended convention. The volume names diverge across all three files, indicating each was written independently.
- **Verdict**: CONFIRMED. This is the root cause.

### Hypothesis B: The names were once consistent but a rename was only partially applied
- **Evidence against**: No git history of a rename. The names in `docker.py` (`qdrant`, `qdrant_data`) are typical Docker "getting started" defaults for Qdrant. The `calm-` prefixed names in `uninstall.sh` and `docker-compose.yml` look like the intentional project-scoped convention. This is a case of the files being authored independently with different naming assumptions, not a partial rename.
- **Verdict**: ELIMINATED.

### Hypothesis C: docker-compose.yml is the canonical source and docker.py should not exist
- **Evidence against**: `docker.py` is actively imported and used by the installer pipeline (`calm install`). Both code paths are intended to coexist: `docker-compose.yml` for manual/compose-based usage, `docker.py` for the programmatic `calm install` flow. The bug is the naming inconsistency, not the existence of `docker.py`.
- **Verdict**: ELIMINATED.

## Root Cause

The programmatic installer (`src/calm/install/docker.py`) hardcodes generic Docker names (`qdrant` for the container, `qdrant_data` for the volume) while the uninstaller (`scripts/uninstall.sh`) and `docker-compose.yml` use project-prefixed names (`calm-qdrant` for the container). The volume names are different in all three files. These files were written independently without a shared constant or naming convention.

**Specific locations:**
- `src/calm/install/docker.py` line 63: `"name=^qdrant$"` (status filter)
- `src/calm/install/docker.py` line 82: `"name=^qdrant$"` (status filter)
- `src/calm/install/docker.py` line 133: `"qdrant"` (container name in `docker run --name`)
- `src/calm/install/docker.py` line 137: `"qdrant_data:/qdrant/storage"` (volume mount)
- `src/calm/install/docker.py` line 173: `["docker", "start", "qdrant"]` (start command)
- `scripts/uninstall.sh` lines 146-151: looks for container `calm-qdrant`
- `scripts/uninstall.sh` lines 155-167: looks for volume `calm_qdrant_storage`
- `docker-compose.yml` line 4: `container_name: calm-qdrant`
- `docker-compose.yml` lines 9, 20: volume `qdrant_storage`

## Fix Plan

Standardize all three files on a single naming convention with `calm-` prefix for the container and `calm_qdrant_` prefix for the volume.

### Target naming convention
- Container name: `calm-qdrant` (prefixed to avoid conflicts with other Qdrant instances)
- Volume name: `calm_qdrant_data` (prefixed, uses `_data` suffix consistent with Docker conventions)

### File changes

#### 1. `src/calm/install/docker.py`

Add module-level constants at the top (after imports):

```python
CONTAINER_NAME = "calm-qdrant"
VOLUME_NAME = "calm_qdrant_data"
```

Update `get_qdrant_status()`:
- Line 63: `"name=^qdrant$"` -> `f"name=^{CONTAINER_NAME}$"`
- Line 82: `"name=^qdrant$"` -> `f"name=^{CONTAINER_NAME}$"`

Update `create_qdrant_container()`:
- Line 133: `"qdrant"` -> `CONTAINER_NAME`
- Line 137: `"qdrant_data:/qdrant/storage"` -> `f"{VOLUME_NAME}:/qdrant/storage"`

Update `start_qdrant_container()`:
- Line 173: `"qdrant"` -> `CONTAINER_NAME`

#### 2. `scripts/uninstall.sh`

Update container name references:
- Lines 146-151: already use `calm-qdrant` -- no change needed

Update volume name references:
- Line 155: `calm_qdrant_storage` -> `calm_qdrant_data`
- Line 161: `calm_qdrant_storage` -> `calm_qdrant_data`
- Line 164: `calm_qdrant_storage` -> `calm_qdrant_data` (both occurrences on this line)
- Line 167: `calm_qdrant_storage` -> `calm_qdrant_data`

#### 3. `docker-compose.yml`

Update volume name to match:
- Line 9: `qdrant_storage` -> `calm_qdrant_data`
- Line 20: `qdrant_storage:` -> `calm_qdrant_data:`

(Container name `calm-qdrant` on line 4 is already correct.)

#### 4. Tests: `tests/test_install/test_docker.py`

The existing tests monkeypatch `subprocess.run` and do not assert on the specific container/volume names passed in the command arguments. No test changes are strictly required for the name change to work. However, the implementer should add a dedicated test that verifies the constants are used correctly:

- Add a test that calls `create_qdrant_container()` with a mock and asserts the `docker run` command includes `--name calm-qdrant` and `calm_qdrant_data:/qdrant/storage`.
- Add a test that calls `get_qdrant_status()` with a mock and asserts the `docker ps` filter includes `name=^calm-qdrant$`.
- Add a test that calls `start_qdrant_container()` with a mock and asserts the `docker start` command includes `calm-qdrant`.

### Regression test requirements

The regression tests should verify:
1. `CONTAINER_NAME` equals `"calm-qdrant"`
2. `VOLUME_NAME` equals `"calm_qdrant_data"`
3. `create_qdrant_container()` passes `CONTAINER_NAME` and `VOLUME_NAME` to the Docker command
4. `get_qdrant_status()` filters by `CONTAINER_NAME`
5. `start_qdrant_container()` starts `CONTAINER_NAME`

### Verification

After applying the fix:
1. Run `pytest tests/test_install/test_docker.py -vvsx` to verify all tests pass
2. Run `ruff check src/calm/install/docker.py` to verify lint
3. Run `mypy --strict src/calm/install/docker.py` to verify types
4. Grep the codebase for any remaining bare `"qdrant"` container/volume references (excluding the Docker image name `qdrant/qdrant` which is correct)
