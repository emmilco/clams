# BUG-040: Duplicate result type definitions with incompatible fields

## Reported

- **First noticed on commit**: 8b5a8b70291b54c290d84625909d459bfe0f3161
- **Reported by**: Codebase auditor
- **Reported at**: 2025-12-11
- **Severity**: High

## Reproduction Steps

1. Create a `search.Searcher` instance with an embedding service and vector store
2. Pass this searcher to `ContextAssembler`
3. Call `assembler.assemble_context()` with `context_types=["code"]` or `context_types=["experiences"]`
4. The formatting functions will raise errors due to field name mismatches

**Expected**: Context assembly works correctly, using the result types returned by `search.Searcher`

**Actual**: Errors occur due to incompatible field names between:
- `context/searcher_types.py` result types (expected by formatting functions)
- `search/results.py` result types (returned by `search.Searcher`)

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
Code analysis reveals two separate type systems with incompatible definitions:

1. **context/searcher_types.py**: Defines result types used by `ContextAssembler` formatting functions
2. **search/results.py**: Defines result types returned by `search.Searcher`

When `search.Searcher` is passed to `ContextAssembler` (as done in E2E test at line 670 of `tests/integration/test_e2e.py`), the result types from `search/results.py` are passed to formatting functions that expect field names from `context/searcher_types.py`.

### Initial Hypothesis

The codebase has two parallel type systems that evolved independently, with `context/searcher_types.py` originally designed as an abstract interface but `search/results.py` being the actual implementation that doesn't match the interface.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | Intentional adapter pattern (types intentionally different) | Adapter/converter code between type systems | No conversion code | No adapter/converter exists. `ContextAssembler` accesses `result.__dict__` directly (line 379) | Eliminated |
| 2 | Parallel evolution oversight (types diverged unintentionally) | Different field names/types for same concept | Consistent field names | Multiple field mismatches documented below | Confirmed |
| 3 | E2E test doesn't actually exercise this code path | Test doesn't hit formatting code | Test triggers formatting | E2E test at line 670 creates `ContextAssembler(searcher)` where `searcher` is `search.Searcher` | Eliminated (test does use the code path) |

### Evidentiary Scaffold

**Field Mismatch Evidence**:

```python
# CodeResult field names
# context/searcher_types.py line 30-31:
start_line: int
end_line: int

# search/results.py line 85-86:
line_start: int
line_end: int
```

```python
# ValueResult field names
# context/searcher_types.py line 71-73:
cluster_size: int
similarity_to_centroid: float

# search/results.py line 193-194:
member_count: int
avg_confidence: float
```

```python
# MemoryResult
# context/searcher_types.py line 17:
importance: float  # <-- EXISTS

# search/results.py line 26-36:
# NO importance field
```

```python
# ExperienceResult lesson field type
# context/searcher_types.py line 57:
lesson: dict[str, Any] | None

# search/results.py line 135:
lesson: Lesson | None  # Lesson is a dataclass
```

**Formatting function evidence** (context/formatting.py):

```python
# Line 40 - format_code expects 'start_line':
start_line = metadata["start_line"]  # KeyError with search.results types!

# Line 90 - format_experience expects lesson to be a dict:
what_worked = lesson.get("what_worked", "")  # AttributeError if lesson is Lesson dataclass!

# Line 18 - format_memory expects 'importance':
importance = metadata.get("importance", 0.0)  # Data loss - defaults to 0.0

# Line 105 - format_value expects 'cluster_size':
cluster_size = metadata.get("cluster_size", 0)  # Data loss - defaults to 0
```

### Root Cause (Proven)

**The bug is caused by**: Two parallel type systems (`context/searcher_types.py` and `search/results.py`) that define the same result types with incompatible field names and types. The `ContextAssembler` formatting functions expect fields from `searcher_types.py` but receive types from `search/results.py` when using the concrete `search.Searcher` class.

**Evidence**:
1. E2E test at `tests/integration/test_e2e.py` line 670 passes `search.Searcher` to `ContextAssembler`
2. `search.Searcher` imports and returns types from `search/results.py` (line 10-16 of `search/searcher.py`)
3. `ContextAssembler` imports the `Searcher` ABC from `context/searcher_types.py` (line 18 of `context/assembler.py`)
4. Formatting functions in `context/formatting.py` use field names that exist in `context/searcher_types.py` but NOT in `search/results.py`

**Specific field mismatches that cause errors**:
| Result Type | searcher_types.py | search/results.py | Impact |
|-------------|-------------------|-------------------|--------|
| CodeResult | `start_line`, `end_line` | `line_start`, `line_end` | **KeyError** |
| ExperienceResult | `lesson: dict | None` | `lesson: Lesson | None` | **AttributeError** (`.get()` on dataclass) |
| MemoryResult | has `importance` | no `importance` | Data loss (defaults to 0.0) |
| ValueResult | `cluster_size`, `similarity_to_centroid` | `member_count`, `avg_confidence` | Data loss (defaults to 0) |
| CommitResult | `committed_at: str`, `insertions`, `deletions` | `committed_at: datetime`, no insertions/deletions | Type mismatch, data loss |
| CodeResult | no `project` | has `project` | Extra field (benign) |
| CommitResult | no `author_email` | has `author_email` | Extra field (benign) |

**Why alternatives were eliminated**:
- Hypothesis 1 eliminated because: No adapter code exists; `ContextAssembler._convert_results()` directly accesses `result.__dict__` assuming compatible field names
- Hypothesis 3 eliminated because: E2E test `test_context_assembly_workflow` explicitly creates `ContextAssembler(searcher)` with `search.Searcher`

---

## Fix Plan

### Code Changes

The fix should consolidate to a SINGLE source of truth for result types. Given that:
- `search/results.py` types have `from_search_result()` methods for converting from VectorStore results
- `context/searcher_types.py` types are only used by the ABC definition and formatting functions
- The concrete `search.Searcher` uses `search/results.py` types

**Recommendation**: Make `search/results.py` the canonical source and update everything else to match.

1. **File**: `src/clams/context/searcher_types.py`
   **Function**: All dataclass definitions
   **Change**: Remove duplicate dataclass definitions, import from `clams.search.results` instead
   **Rationale**: `search.results` types are the ones actually returned at runtime; keep the ABC but use correct types

2. **File**: `src/clams/context/formatting.py`
   **Function**: `format_code()` (line 40)
   **Change**: Use `line_start` instead of `start_line`
   **Rationale**: Match the field name in `search.results.CodeResult`

3. **File**: `src/clams/context/formatting.py`
   **Function**: `format_experience()` (line 89-91)
   **Change**: Handle `Lesson` dataclass instead of dict:
   ```python
   if lesson:
       if isinstance(lesson, dict):
           what_worked = lesson.get("what_worked", "")
       else:
           what_worked = getattr(lesson, "what_worked", "")
   ```
   **Rationale**: `search.results.ExperienceResult.lesson` is a `Lesson` dataclass

4. **File**: `src/clams/context/formatting.py`
   **Function**: `format_value()` (line 105)
   **Change**: Use `member_count` instead of `cluster_size`
   **Rationale**: Match the field name in `search.results.ValueResult`

5. **File**: `src/clams/search/results.py`
   **Function**: `MemoryResult` dataclass
   **Change**: Add `importance: float` field (with default value if needed)
   **Rationale**: The formatting function expects this field and it represents meaningful data

6. **File**: `tests/context/test_assembler.py`
   **Function**: MockSearcher and test data
   **Change**: Update to use correct field names matching `search.results` types
   **Rationale**: Tests should use the canonical type definitions

### Regression Test

**Test file**: `tests/context/test_bug_040_type_consistency.py`

**Test should**:
1. Create a `search.Searcher` with mocked dependencies
2. Pass it to `ContextAssembler`
3. Verify `assemble_context()` succeeds without KeyError/AttributeError for all context types
4. Verify formatting produces expected output with correct field values

**Test outline**:
```python
import pytest
from unittest.mock import AsyncMock, MagicMock

from clams.context.assembler import ContextAssembler
from clams.search.searcher import Searcher
from clams.search.results import (
    CodeResult, ExperienceResult, MemoryResult, ValueResult, CommitResult
)


def test_bug_040_code_result_field_names():
    """Verify CodeResult field names are consistent."""
    # Search results use line_start/line_end
    code = CodeResult(
        id="test",
        project="proj",
        file_path="/test.py",
        language="python",
        unit_type="function",
        qualified_name="test.func",
        code="def func(): pass",
        docstring=None,
        score=0.9,
        line_start=1,
        line_end=2,
    )

    # Formatting should use the correct field names
    from clams.context.formatting import format_code
    result = format_code(code.__dict__)
    assert "test.py:1" in result  # Uses line_start, not start_line


def test_bug_040_context_assembler_with_search_searcher():
    """Verify ContextAssembler works with search.Searcher types.

    This is a regression test for BUG-040 where field name mismatches
    between context/searcher_types.py and search/results.py caused
    KeyError and AttributeError at runtime.
    """
    # Test would set up search.Searcher and verify no errors in formatting
    pass
```

### Verification

After implementing the fix:
```bash
# Run specific test
pytest tests/context/test_bug_040_type_consistency.py -xvs

# Run all context tests
pytest tests/context/ -xvs

# Run full test suite
pytest -xvs
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
