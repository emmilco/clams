# BUG-058: Auto-sync pip after worktree merge

## Reported

- **First noticed on commit**: Multiple sessions (see retrospective-2025-12-14.md Theme 4)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-14
- **Severity**: medium

## Reproduction Steps

1. Task adds new dependency to pyproject.toml in worktree
2. Merge worktree to main using `claws-worktree merge`
3. Run tests or code on main
4. Import errors occur because new dependency not installed

**Expected**: After a worktree merge, dependencies should be automatically synced (e.g., `uv sync` or `pip install -e .`).
**Actual**: Manual dependency sync required after merge, leading to import failures.

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
- Session 8b91c3e2: "ModuleNotFoundError after merge because uv sync wasn't run"
- Session a4f3b7d1: Tests failed on main due to missing dependency added in worktree
- Retrospective Theme 4: "Worktree pain points" includes dependency sync issues

### Initial Hypothesis

`claws-worktree merge` performs git merge but does not sync Python dependencies.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | No dependency sync in merge | Manual sync needed | Dependencies auto-installed | Reviewed claws-worktree - no pip/uv call | Confirmed |

### Root Cause (Proven)

**The bug is caused by**: `claws-worktree merge` script does not run `uv sync` or equivalent after merging.

**Evidence**: Reviewed `.claude/bin/claws-worktree` - merge function does git operations only, no dependency management.

---

## Fix Plan

### Code Changes

1. **File**: `.claude/bin/claws-worktree`
   **Function**: merge section
   **Change**: Add post-merge dependency sync:
   ```bash
   # After successful merge
   echo "Syncing dependencies..."
   if [ -f "uv.lock" ]; then
       uv sync
   elif [ -f "requirements.txt" ]; then
       pip install -r requirements.txt
   elif [ -f "pyproject.toml" ]; then
       pip install -e .
   fi
   ```
   **Rationale**: Ensures dependencies are synced after any merge that might have added them

2. **File**: `.claude/bin/claws-worktree`
   **Change**: Add flag to skip sync if not needed:
   ```bash
   # Usage: claws-worktree merge <task_id> [--skip-sync]
   ```
   **Rationale**: Allows skipping in batch operations where sync will be done once at end

### Regression Test

**Test file**: Manual verification

**Test should**:
1. Create worktree with new dependency
2. Merge worktree
3. Verify dependency is importable on main

**Test outline**:
```bash
# Create worktree that adds a test dependency
.claude/bin/claws-worktree create TEST-001
cd .worktrees/TEST-001
echo 'pytest-mock' >> pyproject.toml  # Add dependency
git add . && git commit -m "Add test dep"
cd ../..

# Merge and verify sync happens
.claude/bin/claws-worktree merge TEST-001

# Verify dependency installed
python -c "import pytest_mock; print('OK')"
```

### Verification

After implementing the fix:
```bash
# Run merge and verify sync message appears
.claude/bin/claws-worktree merge TASK-XXX 2>&1 | grep "Syncing dependencies"

# Verify dependencies are installed
pip list | grep <new-package>
```

---

## Implementation (filled by Implementer)

- **Implemented by**: W-1765692191-87417
- **Commit**: 1ec693a
- **Regression test file**: tests/scripts/test_bug_058_worktree_sync.py

### Changes Made

Implemented the fix as planned, with the following changes:

1. **`.claude/bin/claws-worktree`**: Added dependency sync logic after the merge completes:
   - Checks for `uv.lock` first and runs `uv sync` (with check for uv availability)
   - Falls back to `pip install -r requirements.txt` if requirements.txt exists
   - Falls back to `pip install -e .` if pyproject.toml exists
   - Prints informative messages about which method was used
   - Respects `--skip-sync` flag for batch operations

2. **Additional linter fixes** (pre-existing issues):
   - Removed unused `Mount` import from `src/clams/server/http.py`
   - Added `"generate_*.py" = ["E501"]` to ruff per-file-ignores in `pyproject.toml`

3. **Regression test**: Created `tests/scripts/test_bug_058_worktree_sync.py` with 4 tests:
   - `test_claws_worktree_syncs_dependencies_after_merge`: Verifies sync logic exists
   - `test_claws_worktree_skip_sync_flag_exists`: Verifies --skip-sync flag support
   - `test_claws_worktree_checks_uv_availability`: Verifies uv command check
   - `test_sync_happens_in_merge_function`: Verifies sync is in correct order (after merge, before worktree removal)

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
