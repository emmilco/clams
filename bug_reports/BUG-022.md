# BUG-022: Pagination bug in _delete_file_units leaves orphaned entries

## Reported

- **First noticed on commit**: e2fab06
- **Reported by**: orchestrator (bug hunt agent)
- **Reported at**: 2025-12-08
- **Severity**: high

## Reproduction Steps

1. Index a very large source file that produces >1000 semantic units (functions, classes, etc.)
2. Make a change to the file and re-index
3. Check the vector store for entries from the old version

**Expected**: All old entries should be deleted before re-indexing
**Actual**: Only the first 1000 entries are deleted; remaining entries become orphaned

## Code Location

**File**: `src/clams/indexers/indexer.py`
**Lines**: 371-387

```python
async def _delete_file_units(self, path: str, project: str) -> None:
    """Delete all vector store entries for a file."""
    results = await self.vector_store.scroll(
        collection=self.COLLECTION_NAME,
        filters={"file_path": path, "project": project},
        limit=1000,  # BUG: Only fetches first 1000
        with_vectors=False,
    )
    # Delete each unit
    for result in results:
        await self.vector_store.delete(
            collection=self.COLLECTION_NAME,
            id=result.id,
        )
```

## Analysis

The `scroll` method returns at most `limit` entries. If a file has more than 1000 semantic units, only the first 1000 are deleted. The remaining entries:

1. Remain in the vector store
2. Point to outdated/non-existent code
3. Pollute search results with stale data
4. Accumulate over repeated re-indexes

While rare for typical source files, large generated files or files with many small functions could exceed this limit.

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [ ] Steps reproduced bug

**Observations during reproduction**:
[What did you observe when reproducing?]

### Initial Hypothesis

[What do you believe is causing this bug? Be specific: file, function, line.]

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | [Hypothesis A] | [Observable X] | [Observable Y] | [What you saw] | [Eliminated/Confirmed/Pending] |

### Evidentiary Scaffold

**Logging/assertions added**:
```python
# Location: file.py:123
# Purpose: Distinguish between hypothesis 1 and 2
logger.debug(f"State at critical point: {state}")
```

**Test command**:
```bash
[Command to run with scaffold in place]
```

**Captured output**:
```
[Actual output from scaffold run]
```

### Root Cause (Proven)

**The bug is caused by**: [Specific root cause]

**Evidence**: [What proves this is the cause]

**Why alternatives were eliminated**:
- Hypothesis 1 eliminated because: [reason with evidence]

---

## Fix Plan

### Code Changes

1. **File**: `src/clams/indexers/indexer.py`
   **Function**: `_delete_file_units`
   **Change**: Loop until `scroll` returns no more results
   **Rationale**: Ensures all entries are deleted regardless of count

### Regression Test

**Test file**: `tests/test_bug_022_regression.py`

**Test should**:
1. Create a mock file with >1000 semantic units
2. Call `_delete_file_units`
3. Verify all entries are deleted

**Test outline**:
```python
async def test_bug_022_delete_more_than_1000_units():
    # Setup: insert 1500 mock entries for a single file
    # Action: call _delete_file_units
    # Assert: verify 0 entries remain for that file
```

### Verification

After implementing the fix:
```bash
# Run specific test
pytest tests/test_bug_022_regression.py -xvs

# Run full test suite
pytest -xvs
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
