# BUG-061: Centralize implementation directory list

## Reported

- **First noticed on commit**: Multiple sessions (see retrospective-2025-12-14.md Theme 5)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-14
- **Severity**: medium

## Reproduction Steps

1. Gate check looks for implementation code in `src/` and `tests/`
2. Project has implementation in different locations (e.g., `clams/`, `scripts/`)
3. Gate check passes because it doesn't find code in src/
4. OR gate check fails because it doesn't find code in the right place

**Expected**: Implementation directories should be defined in a central config file and used consistently across all gate checks and tools.
**Actual**: Directory patterns are hardcoded in multiple scripts, leading to inconsistency.

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
- Session 027c2be2: "Gate check passed but implementation was in wrong directory"
- Session cfc84635: "Had to manually find where code should go"
- Retrospective Theme 5: Gate check inefficiencies

### Initial Hypothesis

Implementation directories are hardcoded in `.claude/bin/claws-gate` rather than defined centrally.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | Hardcoded directory list | Inconsistent checks | Single source of truth | Reviewed claws-gate - directories hardcoded | Confirmed |

### Root Cause (Proven)

**The bug is caused by**: Directory patterns like `src/`, `tests/`, `clams/` are hardcoded in multiple scripts without a central definition.

**Evidence**:
- `claws-gate` has hardcoded `src/` and `tests/`
- Different scripts may use different patterns
- No central config for project structure

---

## Fix Plan

### Code Changes

1. **File**: `.claude/project.json` (new file)
   **Change**: Create central project configuration:
   ```json
   {
     "implementation_dirs": ["src/", "clams/"],
     "test_dirs": ["tests/"],
     "script_dirs": [".claude/bin/", "scripts/"],
     "doc_dirs": ["docs/", "planning_docs/"]
   }
   ```
   **Rationale**: Single source of truth for project structure

2. **File**: `.claude/bin/claws-gate`
   **Change**: Read directories from project.json:
   ```bash
   # Read implementation dirs from config
   IMPL_DIRS=$(jq -r '.implementation_dirs[]' .claude/project.json 2>/dev/null || echo "src/")
   TEST_DIRS=$(jq -r '.test_dirs[]' .claude/project.json 2>/dev/null || echo "tests/")

   # Use in checks
   for dir in $IMPL_DIRS $TEST_DIRS; do
       if git diff --name-only HEAD~1 | grep -q "^$dir"; then
           has_implementation=true
       fi
   done
   ```

3. **File**: All scripts that reference directories
   **Change**: Update to read from project.json

### Regression Test

**Test file**: `tests/test_bug_061_regression.py`

**Test should**:
1. Verify project.json is parsed correctly
2. Verify gate check uses configured directories
3. Verify fallback works when project.json missing

**Test outline**:
```python
import json

def test_project_config_exists():
    """Verify project.json has required keys."""
    with open('.claude/project.json') as f:
        config = json.load(f)
    assert 'implementation_dirs' in config
    assert 'test_dirs' in config
```

### Verification

After implementing the fix:
```bash
# Verify config is read
cat .claude/project.json

# Verify gate uses config
.claude/bin/claws-gate check TASK-XXX IMPLEMENT-CODE_REVIEW --verbose 2>&1 | grep -i "impl"
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
