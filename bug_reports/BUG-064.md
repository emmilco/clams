# BUG-064: Auto-commit staged changes on wrapup

## Reported

- **First noticed on commit**: Multiple sessions (see retrospective-2025-12-14.md Theme 8)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-14
- **Severity**: medium

## Reproduction Steps

1. Worker makes changes in worktree
2. Worker stages changes with `git add`
3. Session ends before worker commits
4. `claws-session save` runs wrapup
5. Staged changes are left uncommitted
6. Next session finds uncommitted changes blocking operations

**Expected**: On wrapup, automatically commit any staged changes with a descriptive message.
**Actual**: Staged changes are left uncommitted, causing issues in next session.

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
- Session 027c2be2: "Found uncommitted staged changes from previous session"
- Session f324d9e6: "Had to manually commit changes left by previous worker"
- Retrospective Theme 8: Session continuity issues

### Initial Hypothesis

`claws-session save` does not check for or commit staged changes in worktrees.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | No auto-commit on wrapup | Staged changes persist | Changes committed | Reviewed claws-session - no git commit logic | Confirmed |

### Root Cause (Proven)

**The bug is caused by**: `claws-session save` does not handle uncommitted changes in active worktrees.

**Evidence**: Reviewed `.claude/bin/claws-session` - save function handles handoff but not git state.

---

## Fix Plan

### Code Changes

1. **File**: `.claude/bin/claws-session`
   **Function**: save section
   **Change**: Auto-commit staged changes in all active worktrees:
   ```bash
   # Before saving handoff
   echo "Checking for uncommitted changes..."

   for worktree in .worktrees/*; do
       task_id=$(basename "$worktree")
       cd "$worktree"

       # Check for staged changes
       if ! git diff --cached --quiet; then
           echo "Auto-committing staged changes in $task_id"
           git commit -m "WIP: Auto-commit at session end

   This commit was auto-generated by claws-session save.
   Staged changes were present when session ended.

   Session ID: $SESSION_ID"
       fi

       # Warn about unstaged changes (don't auto-add)
       if ! git diff --quiet; then
           echo "WARNING: $task_id has unstaged changes (not auto-committed)"
       fi
   done
   ```

2. **File**: `.claude/bin/claws-session`
   **Change**: Add `--no-auto-commit` flag to disable behavior

3. **File**: Handoff format
   **Change**: Include list of worktrees with auto-committed changes:
   ```
   ## Auto-Committed Worktrees
   - BUG-042: 3 files auto-committed
   - SPEC-001-02: 1 file auto-committed
   ```

### Regression Test

Manual verification:
1. Make changes in worktree, stage them
2. Run `claws-session save`
3. Verify changes were committed with WIP message
4. Verify handoff lists auto-committed worktrees

### Verification

After implementing the fix:
```bash
# Stage some changes
cd .worktrees/TASK-001
git add .

# Verify auto-commit on save
cd ../..
.claude/bin/claws-session save --continue

# Check commit was made
cd .worktrees/TASK-001
git log -1 --oneline
```

---

## Implementation (filled by Implementer)

- **Implemented by**: W-1765692196-91673
- **Commit**: c929b6c
- **Regression test file**: tests/scripts/test_bug_064_regression.py

### Changes Made

1. **`.claude/bin/claws-session`**: Added auto-commit logic to the `cmd_save()` function:
   - Iterates over all active worktrees in `$WORKTREE_DIR`
   - Checks each worktree for staged changes using `git diff --cached --quiet`
   - Auto-commits staged changes with a WIP message indicating session end
   - Warns about unstaged changes (does not auto-add them)
   - Appends "Auto-Committed Worktrees" and "Worktrees with Unstaged Changes" sections to handoff
   - Added `--no-auto-commit` flag to disable this behavior when needed

2. **Regression test**: Created `tests/scripts/test_bug_064_regression.py` with 4 tests:
   - `test_claws_session_has_auto_commit_logic`: Verifies key auto-commit components exist
   - `test_claws_session_iterates_worktrees`: Verifies worktree iteration loop
   - `test_claws_session_appends_to_handoff`: Verifies handoff sections added
   - `test_auto_commit_default_enabled`: Verifies auto-commit is opt-out (enabled by default)

3. **Linter fixes** (pre-existing issues):
   - Removed unused `Mount` import from `src/clams/server/http.py`
   - Added `"generate_*.py" = ["E501"]` to `pyproject.toml` ruff config

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
