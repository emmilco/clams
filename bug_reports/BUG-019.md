# BUG-019: validate_value returns internal server error (regression)

## Reported

- **First noticed on commit**: 722c1b07ca0274746cdc7505599e7a87235fea4e
- **Reported by**: orchestrator
- **Reported at**: 2025-12-08T18:00:00Z
- **Severity**: high

## Reproduction Steps

1. Start the clams MCP server
2. Call `validate_value` tool with parameters `{"text": "Test value statement", "cluster_id": "full_0"}`
3. Observe the response

**Expected**: A JSON response with validation result (similarity score, etc.)
**Actual**: `{"error": {"type": "internal_error", "message": "Internal server error"}}`

## Notes

- This was previously fixed in BUG-009 but appears to have regressed
- Related to other clustering/values tool failures
- May share common root cause with BUG-017, BUG-018, BUG-020, BUG-021

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
When calling `validate_value` with `{"text": "Test value statement", "cluster_id": "full_0"}` where the cluster exists but has no members, the tool returns:
```json
{"valid": false, "similarity": null, "cluster_id": "full_0"}
```

The bug is that `similarity` is `null` (None in Python), which can cause "internal server error" responses in certain MCP client contexts that expect `similarity` to always be a number when present.

### Initial Hypothesis

The bug is in `src/clams/server/tools/learning.py` lines 283-287, where the `validate_value` tool always includes `validation_result.similarity` in the response dict, even when it's `None`.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | `similarity` is always set in ValidationResult | All test cases show similarity with a float value | Some ValidationResult instances have similarity=None | Created test showing similarity=None when cluster has no members | **Eliminated** |
| 2 | The bug is in ValueStore.validate_value_candidate not setting similarity | ValidationResult type allows similarity=None, and validate_value_candidate returns it as None in error cases | validate_value_candidate always sets similarity | Checked ValueStore code: lines 178-193 return ValidationResult with no similarity field (defaults to None) | **Eliminated** |
| 3 | The bug is in learning.py tool response unconditionally including similarity | Tool response includes similarity even when None | Tool would exclude similarity when None or return a default value | Traced code path: learning.py:283-287 always includes `validation_result.similarity` in dict, can be None | **Confirmed** |
| 4 | MCP protocol requires similarity to be a number when present | MCP clients fail or return internal_error when similarity is null | MCP clients handle null similarity gracefully | Bug report states "internal server error" is returned; JSON with null serializes fine, so issue is likely MCP/client-side validation | **Likely** |

### Evidentiary Scaffold

**Test script created**: `test_bug_019_mcp.py`
```python
# Purpose: Reproduce the bug by calling validate_value with a cluster that has no members
# This triggers the code path where ValidationResult.similarity is None
```

**Test command**:
```bash
cd /Users/elliotmilco/Documents/GitHub/clams/.worktrees/BUG-019
python test_bug_019_mcp.py
```

**Captured output**:
```
Calling validate_value with empty cluster...
2025-12-08 13:30:57 [info] learning.value_validated cluster_id=full_0 similarity=None valid=False

Result dict: {'valid': False, 'similarity': None, 'cluster_id': 'full_0'}
**BUG CONFIRMED**: similarity field is None
```

**Evidence gathered**:
1. ValueStore.validate_value_candidate (lines 192-193) returns ValidationResult with similarity=None when cluster has no members
2. learning.py validate_value tool (lines 283-287) unconditionally includes validation_result.similarity in response
3. The response dict contains `"similarity": None` which serializes to JSON as `"similarity": null`
4. MCP clients may reject this as invalid (expecting a number type, not null)

### Root Cause (Proven)

**The bug is caused by**: In `src/clams/server/tools/learning.py` lines 283-287, the `validate_value` tool response unconditionally includes `validation_result.similarity` in the returned dict. When validation fails, `ValueStore.validate_value_candidate` returns a `ValidationResult` with `similarity=None`, causing the tool to return `{"valid": False, "similarity": null, "cluster_id": "..."}`.

**Code location**: `src/clams/server/tools/learning.py`, function `validate_value`, lines 283-287:
```python
return {
    "valid": validation_result.valid,
    "similarity": validation_result.similarity,  # Can be None!
    "cluster_id": cluster_id,
}
```

**When similarity is None**:
1. When `_get_cluster()` raises ValueError (insufficient experiences, invalid cluster_id) - lines 178-190 in ValueStore
2. When cluster has no members - lines 192-193 in ValueStore
3. When value is too far from centroid - lines 217-230 in ValueStore (doesn't set similarity in failure case)

**Evidence**:
- Created reproduction script `test_bug_019_mcp.py` that confirms similarity is None when cluster has no members
- Traced all code paths through ValueStore.validate_value_candidate showing when similarity is not set
- JSON serialization succeeds (None â†’ null), so the "internal server error" likely occurs at the MCP protocol/client layer when it validates the response schema

**Why alternatives were eliminated**:
- Hypothesis 1 (similarity always set) eliminated because: ValidationResult type defines similarity as optional (float | None), and multiple code paths in ValueStore return it as None
- Hypothesis 2 (bug in ValueStore) eliminated because: ValueStore correctly returns ValidationResult with similarity=None for error cases per its design. The bug is in the tool layer not handling this properly

---

## Fix Plan

### Code Changes

1. **File**: `src/clams/server/tools/learning.py`
   **Function**: `validate_value` (lines 229-304)
   **Change**: Conditionally include `similarity` in response dict only when it's not None. When valid=False and similarity is None, omit the field entirely from the response.
   **Rationale**: This prevents MCP clients from receiving `{"similarity": null}` which may violate their schema expectations. The `valid` field is sufficient to indicate validation failure.

   **Implementation options**:
   - **Option A** (Recommended): Omit similarity when None:
     ```python
     result = {
         "valid": validation_result.valid,
         "cluster_id": cluster_id,
     }
     if validation_result.similarity is not None:
         result["similarity"] = validation_result.similarity
     return result
     ```
   - **Option B**: Return 0.0 when None (less clear semantically):
     ```python
     return {
         "valid": validation_result.valid,
         "similarity": validation_result.similarity or 0.0,
         "cluster_id": cluster_id,
     }
     ```

   I recommend **Option A** because it makes the API clearer: similarity is only present when validation succeeded and a score was computed.

### Regression Test

**Test file**: `tests/server/tools/test_learning.py`

**Test should**:
1. Call validate_value with a cluster that has no members (or fails for another reason)
2. Verify the response has `valid=False`
3. Verify `similarity` field is either omitted OR is a float (not None)
4. The test would fail before the fix (similarity would be None)

**Test implementation**:
```python
@pytest.mark.asyncio
async def test_validate_value_no_similarity_when_invalid(
    tools: dict[str, Any],
    value_store: ValueStore,
) -> None:
    """Regression test for BUG-019: validate_value with empty cluster.

    When validation fails (e.g., cluster has no members), the response
    should NOT include similarity=None. Either omit the field or provide
    a valid number.
    """
    # Mock validate_value_candidate to return failure with no similarity
    mock_result = MagicMock()
    mock_result.valid = False
    mock_result.similarity = None  # This triggers the bug
    value_store.validate_value_candidate = AsyncMock(return_value=mock_result)

    tool = tools["validate_value"]
    result = await tool(text="Test value", cluster_id="full_0")

    # Should not have an error response
    assert "error" not in result

    # Should have valid=False
    assert result["valid"] is False

    # Similarity should either be absent or a float (not None)
    if "similarity" in result:
        assert isinstance(result["similarity"], float), (
            f"BUG-019 regression: similarity is {result['similarity']} (should be float or omitted)"
        )
```

### Verification

After implementing the fix:
```bash
# Run specific regression test
pytest tests/server/tools/test_learning.py::test_validate_value_no_similarity_when_invalid -xvs

# Run all validate_value tests
pytest tests/server/tools/test_learning.py::TestValidateValue -xvs

# Run full test suite
pytest -xvs
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
