# BUG-031: Clustering not forming with 63 GHAP entries - investigate HDBSCAN parameters

## Reported

- **First noticed on commit**: 22902b24ba20f1df332c8504901132ff379cb2e4
- **Reported by**: orchestrator
- **Reported at**: 2025-12-10T03:27:00Z
- **Severity**: medium

## Problem

With 63 resolved GHAP entries (many thematically similar - debugging async/concurrent issues), `get_clusters` returns empty clusters for both `full` and `strategy` axes. The semantic search works correctly and returns related results, but clustering fails to form any groups.

### Reproduction Steps

1. Generate 63+ GHAP entries with thematic similarity (debugging scenarios)
2. Call `get_clusters(axis="full")`
3. Observe empty clusters returned

**Expected**: At least some clusters should form given thematic similarity of entries

**Actual**: Returns `{"axis": "full", "clusters": [], "count": 0, "noise_count": 0}`

### Observations

- `search_experiences` returns semantically related results with good scores (0.5-0.7)
- `list_ghap_entries` confirms 63 entries exist
- Both `full` and `strategy` axes return empty (no error)
- `surprise` and `root_cause` axes have insufficient data (14 falsified entries, need 20)

---

## Investigation (filled by Bug Investigator)

### Hypotheses to Investigate

| # | Hypothesis | If True, Would See | If False, Would See | Status |
|---|------------|-------------------|---------------------|--------|
| 1 | HDBSCAN min_cluster_size too high | Lowering parameter forms clusters | Still no clusters | Pending |
| 2 | HDBSCAN min_samples too strict | Lowering parameter forms clusters | Still no clusters | Pending |
| 3 | Embeddings not being stored for clustering | Missing/empty experience embeddings table | Embeddings present | Pending |
| 4 | Embeddings too spread in high-dimensional space | t-SNE visualization shows uniform spread | Shows dense regions | Pending |
| 5 | Clustering code not being called correctly | Adding logging shows issue | Clustering runs correctly | Pending |

### Investigation Areas

1. **Check HDBSCAN parameters** in clustering code
   - Current `min_cluster_size` value
   - Current `min_samples` value
   - Compare to data size (63 entries)

2. **Verify experience embeddings exist**
   - Check vector store has experience entries
   - Verify embeddings are non-zero

3. **Analyze embedding distribution**
   - Calculate pairwise distances
   - Check if any points are close enough to cluster

---

## Fix Plan

### Likely Changes

1. **File**: `src/clams/values/cluster.py` (or similar)
   **Change**: Adjust HDBSCAN parameters based on data size
   - `min_cluster_size` should be small enough (e.g., 3-5) for 63 entries
   - `min_samples` should allow cluster formation

2. **Alternative**: Use different clustering algorithm if HDBSCAN unsuitable
   - K-Means with elbow method
   - DBSCAN with tuned epsilon
   - Agglomerative clustering

### Regression Test

**Test file**: `tests/values/test_bug_031_regression.py`

**Test should**:
1. Create 20+ similar GHAP entries
2. Call get_clusters
3. Verify at least one cluster forms
4. Verify cluster contains semantically related entries

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
