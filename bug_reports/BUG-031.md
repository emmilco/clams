# BUG-031: Clustering not forming with 63 GHAP entries - investigate HDBSCAN parameters

## Reported

- **First noticed on commit**: 22902b24ba20f1df332c8504901132ff379cb2e4
- **Reported by**: orchestrator
- **Reported at**: 2025-12-10T03:27:00Z
- **Severity**: medium

## Problem

With 63 resolved GHAP entries (many thematically similar - debugging async/concurrent issues), `get_clusters` returns empty clusters for both `full` and `strategy` axes. The semantic search works correctly and returns related results, but clustering fails to form any groups.

### Reproduction Steps

1. Generate 63+ GHAP entries with thematic similarity (debugging scenarios)
2. Call `get_clusters(axis="full")`
3. Observe empty clusters returned

**Expected**: At least some clusters should form given thematic similarity of entries

**Actual**: Returns `{"axis": "full", "clusters": [], "count": 0, "noise_count": 0}`

### Observations

- `search_experiences` returns semantically related results with good scores (0.5-0.7)
- `list_ghap_entries` confirms 63 entries exist
- Both `full` and `strategy` axes return empty (no error)
- `surprise` and `root_cause` axes have insufficient data (14 falsified entries, need 20)

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
Synthetic testing with 63 embeddings matching the data distribution confirms that current HDBSCAN parameters (`min_cluster_size=5`, `min_samples=3`) produce 0 clusters and classify all 63 points as noise.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | HDBSCAN min_cluster_size too high | Lowering parameter forms clusters | Still no clusters | Relaxing to min_cluster_size=3 forms 2 clusters | **Confirmed** |
| 2 | HDBSCAN min_samples too strict | Lowering parameter forms clusters | Still no clusters | Combined with hypothesis 1 | **Confirmed** |
| 3 | Embeddings not being stored | Missing/empty embeddings | Embeddings present | Code review confirms proper storage/retrieval | Eliminated |
| 4 | Embeddings too spread | Uniform spread | Dense regions | Related to #1/#2 - diffuse single-theme cloud | Contributing factor |
| 5 | Clustering code not being called | Logging shows issue | Runs correctly | Code flow verified | Eliminated |

### Evidentiary Scaffold

**Production configuration found at `src/clams/server/tools/__init__.py:800-805`**:
```python
clusterer = Clusterer(
    min_cluster_size=5,
    min_samples=3,
    metric="cosine",
    cluster_selection_method="eom",
)
```

**Synthetic testing results with 63 embeddings**:

| Configuration | min_cluster_size | min_samples | Clusters Found | Noise Points |
|--------------|------------------|-------------|----------------|--------------|
| **Production** | 5 | 3 | **0** | **63** |
| Relaxed | 3 | 2 | 2 | 57 |
| Very Relaxed | 2 | 1 | 7 | 26 |

**Well-separated clusters test**: Same production config with 5 well-separated clusters of 13 points each → Found all 5 clusters perfectly (0 noise).

### Root Cause (Proven)

**The bug is caused by**: HDBSCAN parameters (`min_cluster_size=5`, `min_samples=3`) are too conservative for the data distribution. The 63 GHAP entries are thematically similar (all about debugging async/concurrent issues) and form a single diffuse cloud in embedding space rather than tight sub-clusters.

**Evidence**:
- Production config produces 0 clusters, 63 noise points
- Relaxing to min_cluster_size=3, min_samples=2 produces 2 clusters
- Same production config works perfectly for well-separated clusters
- Existing test suite uses `min_cluster_size=3` in many tests

**Why alternatives were eliminated**:
- Hypothesis 3 eliminated: Code review confirms embeddings are retrieved and passed to clusterer
- Hypothesis 5 eliminated: Flow verified through `ExperienceClusterer.cluster_axis()` → `Clusterer.cluster()`

---

## Fix Plan

### Code Changes

1. **File**: `src/clams/server/tools/__init__.py` (lines 800-805)
   **Change**: Update HDBSCAN parameters:
   ```python
   clusterer = Clusterer(
       min_cluster_size=3,  # Changed from 5
       min_samples=2,       # Changed from 3
       metric="cosine",
       cluster_selection_method="eom",
   )
   ```
   **Rationale**:
   - Allows smaller clusters to form
   - Still filters noise effectively
   - Better suited for datasets with 20-100 points
   - Matches test suite usage patterns

### Regression Test

**Test file**: `tests/clustering/test_bug_031_regression.py`

**Test should**:
1. Create 25+ embeddings representing similar experiences (single theme, varied specifics)
2. Initialize `Clusterer(min_cluster_size=3, min_samples=2)`
3. Verify at least one cluster forms
4. Verify cluster contains at least 3 points
5. Test should fail with old config (min_cluster_size=5), pass with new config

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
