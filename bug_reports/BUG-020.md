# BUG-020: store_value returns internal server error (regression)

## Reported

- **First noticed on commit**: 722c1b07ca0274746cdc7505599e7a87235fea4e
- **Reported by**: orchestrator
- **Reported at**: 2025-12-08T18:00:00Z
- **Severity**: high

## Reproduction Steps

1. Start the clams MCP server
2. Call `store_value` tool with parameters `{"text": "Test value", "cluster_id": "full_0", "axis": "full"}`
3. Observe the response

**Expected**: A JSON response confirming the value was stored
**Actual**: `{"error": {"type": "internal_error", "message": "Internal server error"}}`

## Notes

- This was previously fixed in BUG-010 but appears to have regressed
- `list_values` works but returns empty results
- Related to other clustering/values tool failures
- May share common root cause with BUG-017, BUG-018, BUG-019, BUG-021

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
Called `store_value` with `{"text": "Test value", "cluster_id": "full_0", "axis": "full"}`. The tool returned:
```json
{"error": {"type": "internal_error", "message": "Internal server error"}}
```

The actual error (visible in logs) was:
```
ValueError: Value failed validation: Cluster has no members
```

This ValueError is being caught by the generic exception handler in `learning.py` line 371-378, which logs it and returns a generic "internal_error" response instead of a proper validation error.

### Initial Hypothesis

The bug is in `src/clams/server/tools/learning.py:store_value()` at lines 371-378. The generic exception handler catches `ValueError` exceptions from `ValueStore.store_value()` and returns a generic "internal_error" instead of distinguishing between validation errors (which should return "validation_error") and true internal errors.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | Generic exception handler in `learning.py` catches `ValueError` and returns "internal_error" | ValueError in logs with "Value failed validation", but response shows "internal_error" | ValueError would be returned as "validation_error" | Reproduction shows ValueError("Value failed validation: Cluster has no members") in logs, but response is {"error": {"type": "internal_error"}} | **Confirmed** |
| 2 | `ValueStore.store_value()` raises `ValueError` for validation failures | ValueError stack trace originates from `store.py:249` | ValueError would originate elsewhere | Stack trace shows: `store.py:249: raise ValueError(f"Value failed validation: {validation.reason}")` | **Confirmed** |
| 3 | The bug is a recent regression from SPEC-006/007 merge | Changes to exception handling in recent commits | BUG-010 fix would still be present unchanged | Exception handling from BUG-010 is present in `store.py` but exception type handling in `learning.py` was not updated | **Confirmed** |

### Evidentiary Scaffold

No additional scaffolding needed. The reproduction script at `reproduce_bug.py` clearly shows:

1. The stack trace originates from `store.py:249` where `ValueError` is raised
2. The exception is caught by the generic handler in `learning.py:371-378`
3. The generic handler logs it as "unexpected_error" and returns "internal_error"

**Test command**:
```bash
cd /Users/elliotmilco/Documents/GitHub/clams/.worktrees/BUG-020 && python reproduce_bug.py
```

**Captured output**:
```
ValueError: Value failed validation: Cluster has no members
Result: {'error': {'type': 'internal_error', 'message': 'Internal server error'}}
```

The fix verification will be to run the same command and see:
```
Result: {'error': {'type': 'validation_error', 'message': 'Value failed validation: Cluster has no members'}}
```

### Root Cause (Proven)

**The bug is caused by**: Missing exception handling for `ValueError` in `src/clams/server/tools/learning.py:store_value()` at lines 306-378.

When `ValueStore.store_value()` raises a `ValueError` due to validation failures (e.g., "Cluster has no members"), the exception is caught by the generic `except Exception` handler at line 371, which logs it as an "unexpected_error" and returns a generic "internal_error" response instead of a proper "validation_error" response.

**Evidence**:
1. Reproduction script shows `ValueError` is raised from `store.py:249` with message "Value failed validation: Cluster has no members"
2. The exception is caught by the generic handler in `learning.py:371-378`
3. The response is `{"error": {"type": "internal_error", "message": "Internal server error"}}`
4. Other tools in the same file (e.g., `validate_value` at lines 289-296) properly catch `ValidationError` and return "validation_error" responses

**Why this is a regression**:
BUG-010 fixed the underlying validation logic in `ValueStore` to return `ValidationResult(valid=False)` instead of raising exceptions. However, `ValueStore.store_value()` still raises `ValueError` when validation fails (by design, to prevent storing invalid values). The `learning.py` tool wrapper was never updated to handle this `ValueError` properly.

**Why alternatives were eliminated**:
- The issue is NOT in `ValueStore.store_value()` - it correctly raises `ValueError` for validation failures, which is standard Python convention
- The issue is NOT missing validation logic - the validation is working correctly and returning the right result
- The issue IS in the tool wrapper layer not handling the exception type properly

---

## Fix Plan

### Code Changes

1. **File**: `src/clams/server/tools/learning.py`
   **Function**: `store_value()` (lines 306-378)
   **Change**: Add explicit exception handling for `ValueError` before the generic exception handler
   **Rationale**: This matches the pattern used in other tools (e.g., `validate_value`) and properly distinguishes validation errors from internal errors

   **Specific change**:
   - Add a new `except ValueError as e:` block after the existing `except (ValidationError, NotFoundError)` block (which currently doesn't exist)
   - In this block, log a warning and return `{"error": {"type": "validation_error", "message": str(e)}}`
   - Keep the generic `except Exception` handler for true internal errors

2. No other changes needed - `ValueStore.store_value()` is working correctly

### Regression Test

**Test file**: `tests/server/tools/test_learning.py` (add new test to existing TestStoreValue class)

**Test should**:
1. Call `store_value` with a cluster_id that has no members (or mock the validation to return invalid)
2. Verify the response has `{"error": {"type": "validation_error", "message": "..."}}`
3. Verify it's NOT an "internal_error"

**Test outline**:
```python
@pytest.mark.asyncio
async def test_store_value_validation_failure(
    tools: dict[str, Any], value_store: ValueStore
) -> None:
    """Test that validation failures return validation_error, not internal_error."""
    # Mock store_value to raise ValueError (validation failure)
    value_store.store_value = AsyncMock(
        side_effect=ValueError("Value failed validation: Cluster has no members")
    )

    tool = tools["store_value"]
    result = await tool(
        text="Test value",
        cluster_id="full_0",
        axis="full",
    )

    # Should return validation_error, not internal_error
    assert "error" in result
    assert result["error"]["type"] == "validation_error"
    assert "validation" in result["error"]["message"].lower()
```

### Verification

After implementing the fix:
```bash
# Run the reproduction script - should now return validation_error
cd /Users/elliotmilco/Documents/GitHub/clams/.worktrees/BUG-020 && python reproduce_bug.py

# Run the new regression test
pytest tests/server/tools/test_learning.py::TestStoreValue::test_store_value_validation_failure -xvs

# Run all store_value tests
pytest tests/server/tools/test_learning.py::TestStoreValue -xvs

# Run full test suite
pytest -xvs
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
