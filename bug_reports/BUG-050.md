# BUG-050: SessionStart hook output not injected into context

## Reported

- **First noticed on commit**: 041c29b (Merge task SPEC-010)
- **Reported by**: orchestrator
- **Reported at**: 2025-12-13
- **Severity**: medium

## Reproduction Steps

1. Start a new Claude Code session in the clams repository
2. Observe the system reminders in context
3. Run the hook manually to see what it outputs:
   ```bash
   ./clams/hooks/session_start.sh
   ```

**Expected**: The GHAP Learning System instructions should appear in Claude's context at session start:
```
## GHAP Learning System

When you encounter tasks involving **debugging**, **investigation**, or **complex problem-solving**, use GHAP to track your reasoning:

1. **Start**: `mcp__clams__start_ghap` - State your goal, hypothesis, action, and prediction
2. **Update**: `mcp__clams__update_ghap` - Revise if your hypothesis changes
3. **Resolve**: `mcp__clams__resolve_ghap` - Record outcome (confirmed/falsified/abandoned)
...
```

**Actual**: Only a success message appears in context:
```
<system-reminder>
SessionStart:startup hook success: Success
</system-reminder>
```

The hook's JSON output with `"content"` field is not being processed/injected.

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:

Hook produces valid JSON output when run manually:
```bash
$ ./clams/hooks/session_start.sh
{
  "type": "light",
  "content": "## GHAP Learning System\n\nWhen you encounter tasks involving **debugging**..."
}
```

But Claude's context only shows:
```
SessionStart:startup hook success: Success
```

The context is NOT injected. Claude Code treats the unrecognized JSON as a success signal only.

### Initial Hypothesis

The hook outputs JSON with `{"type": ..., "content": ...}` but Claude Code's SessionStart hooks expect a different JSON schema: `{"hookSpecificOutput": {"additionalContext": ...}}`.

**Specific location**: `clams/hooks/session_start.sh`, `main()` function, lines 163-186 where the JSON output is built.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | Claude Code expects different output format | Documentation shows different schema | Our format matches docs | Docs show `hookSpecificOutput.additionalContext` required | **CONFIRMED** |
| 2 | SessionStart hooks don't support content injection | Docs say SessionStart is signal-only | Docs show content injection for SessionStart | Docs explicitly show SessionStart supports additionalContext | Eliminated |
| 3 | The `"content"` field needs different name/structure | Changing field name works | Field name is correct per docs | Field must be `additionalContext` inside `hookSpecificOutput` | **CONFIRMED** |

### Evidentiary Scaffold

**Documentation sources consulted**:
1. [Claude Code Hooks Reference](https://code.claude.com/docs/en/hooks)
2. [Claude Code Hook Schemas Gist](https://gist.github.com/FrancisBourre/50dca37124ecc43eaf08328cdcccdb34)

**Claude Code Expected SessionStart Output Schema**:
```json
{
  "hookSpecificOutput": {
    "hookEventName": "SessionStart",
    "additionalContext": "string content to inject"
  }
}
```

**Our Current Output Schema (INCORRECT)**:
```json
{
  "type": "light",
  "content": "string content"
}
```

**Test command**:
```bash
./clams/hooks/session_start.sh
```

**Captured output** (showing incorrect schema):
```json
{
  "type": "light",
  "content": "## GHAP Learning System\n\nWhen you encounter tasks involving **debugging**, **investigation**, or **complex problem-solving**, use GHAP to track your reasoning:\n\n1. **Start**: `mcp__clams__start_ghap` - State your goal, hypothesis, action, and prediction\n2. **Update**: `mcp__clams__update_ghap` - Revise if your hypothesis changes\n3. **Resolve**: `mcp__clams__resolve_ghap` - Record outcome (confirmed/falsified/abandoned)\n\nGHAP entries are embedded and clustered to surface relevant past experiences in future sessions.\n\n**When to use GHAP:**\n- Debugging a failing test or error\n- Investigating unexpected behavior\n- Exploring unfamiliar code\n- Any task where you form a hypothesis about root cause\n\n---\n"
}
```

### Root Cause (Proven)

**The bug is caused by**: Incorrect JSON output schema in `clams/hooks/session_start.sh`. The hook uses a custom schema with `"type"` and `"content"` fields, but Claude Code's SessionStart hooks require the official schema with `hookSpecificOutput.additionalContext`.

**Evidence**:
1. Claude Code documentation explicitly states SessionStart hooks use `hookSpecificOutput.additionalContext` for context injection
2. Our hook outputs `{"type": "light", "content": "..."}` which Claude Code does not recognize
3. Claude Code reports "Success" (exit code 0) but ignores the unrecognized JSON fields, resulting in no context injection

**Why alternatives were eliminated**:
- **Hypothesis 2 (SessionStart doesn't support injection)**: Eliminated - documentation clearly shows SessionStart supports `additionalContext` field for context injection
- **Plain stdout alternative**: While plain text stdout also works for SessionStart context injection, we are outputting JSON (not plain text), so Claude Code attempts to parse it as structured output. The unrecognized fields are silently ignored

---

## Fix Plan

### Code Changes

1. **File**: `clams/hooks/session_start.sh`
   **Function**: `main`
   **Lines**: 163-186 (JSON output section)

   **Change**: Replace the custom JSON output schema with Claude Code's official SessionStart output schema:

   **Before** (lines 169-175 for orphan case):
   ```bash
   cat <<EOF
   {
     "type": "orphan_detected",
     "content": "## Orphaned GHAP Detected\n\n..."
   }
   EOF
   ```

   **After**:
   ```bash
   cat <<EOF
   {
     "hookSpecificOutput": {
       "hookEventName": "SessionStart",
       "additionalContext": "## Orphaned GHAP Detected\n\n..."
     }
   }
   EOF
   ```

   **Before** (lines 180-185 for normal case):
   ```bash
   cat <<EOF
   {
     "type": "light",
     "content": $(echo "$full_content" | jq -Rs .)
   }
   EOF
   ```

   **After**:
   ```bash
   cat <<EOF
   {
     "hookSpecificOutput": {
       "hookEventName": "SessionStart",
       "additionalContext": $(echo "$full_content" | jq -Rs .)
     }
   }
   EOF
   ```

   **Rationale**: Claude Code's SessionStart hooks require the `hookSpecificOutput.additionalContext` structure for context injection. The custom `type`/`content` schema is not recognized.

### Regression Test

**Test file**: `tests/hooks/test_bug_050_regression.py`

**Test should**:
1. Run session_start.sh and capture output
2. Parse output as JSON
3. Verify output contains `hookSpecificOutput` key
4. Verify `hookSpecificOutput.hookEventName` equals "SessionStart"
5. Verify `hookSpecificOutput.additionalContext` is a non-empty string containing GHAP instructions
6. Fail if any of the above are not met (would have caught the original bug)

**Test outline**:
```python
"""Regression test for BUG-050: SessionStart hook output format.

This test ensures the session_start.sh hook outputs the correct JSON schema
for Claude Code's SessionStart hook content injection.

The bug: Hook used custom {"type": ..., "content": ...} schema instead of
Claude Code's {"hookSpecificOutput": {"additionalContext": ...}} schema.
"""

import json
import subprocess
from pathlib import Path

import pytest


def test_bug_050_session_start_hook_output_schema():
    """Verify session_start.sh outputs correct Claude Code SessionStart schema.

    This would have failed before the fix because the hook was outputting:
        {"type": "light", "content": "..."}

    Instead of the required:
        {"hookSpecificOutput": {"hookEventName": "SessionStart", "additionalContext": "..."}}
    """
    # Find the hook script
    repo_root = Path(__file__).parent.parent.parent
    hook_path = repo_root / "clams" / "hooks" / "session_start.sh"

    assert hook_path.exists(), f"Hook not found at {hook_path}"

    # Run the hook
    result = subprocess.run(
        [str(hook_path)],
        capture_output=True,
        text=True,
        timeout=10,
    )

    # Hook should exit successfully
    assert result.returncode == 0, f"Hook failed: {result.stderr}"

    # Parse output as JSON
    output = json.loads(result.stdout)

    # Verify Claude Code SessionStart schema
    assert "hookSpecificOutput" in output, (
        "Missing 'hookSpecificOutput' key. "
        f"Got keys: {list(output.keys())}. "
        "This is the BUG-050 regression - wrong schema!"
    )

    hook_output = output["hookSpecificOutput"]
    assert hook_output.get("hookEventName") == "SessionStart", (
        f"hookEventName should be 'SessionStart', got: {hook_output.get('hookEventName')}"
    )

    assert "additionalContext" in hook_output, (
        "Missing 'additionalContext' in hookSpecificOutput"
    )

    context = hook_output["additionalContext"]
    assert isinstance(context, str), f"additionalContext should be string, got {type(context)}"
    assert len(context) > 0, "additionalContext should not be empty"
    assert "GHAP" in context, "additionalContext should contain GHAP instructions"


def test_bug_050_no_legacy_schema_fields():
    """Verify the old incorrect schema fields are NOT present."""
    repo_root = Path(__file__).parent.parent.parent
    hook_path = repo_root / "clams" / "hooks" / "session_start.sh"

    result = subprocess.run(
        [str(hook_path)],
        capture_output=True,
        text=True,
        timeout=10,
    )

    output = json.loads(result.stdout)

    # These were the old (incorrect) field names
    assert "type" not in output, (
        "Found legacy 'type' field - this is the BUG-050 regression!"
    )
    assert "content" not in output, (
        "Found legacy 'content' field - this is the BUG-050 regression!"
    )
```

### Verification

After implementing the fix:
```bash
# Run specific regression test
pytest tests/hooks/test_bug_050_regression.py -xvs

# Run all hook tests
pytest tests/hooks/ -xvs

# Manual verification: run hook and inspect output
./clams/hooks/session_start.sh | jq .

# Expected output structure:
{
  "hookSpecificOutput": {
    "hookEventName": "SessionStart",
    "additionalContext": "## GHAP Learning System\n\n..."
  }
}

# Live verification: Start new Claude Code session and check context
# The GHAP Learning System instructions should appear in Claude's context
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
