# BUG-030: GHAP tools should return minimal responses to reduce token usage

## Reported

- **First noticed on commit**: 22902b24ba20f1df332c8504901132ff379cb2e4
- **Reported by**: orchestrator
- **Reported at**: 2025-12-10T03:22:00Z
- **Severity**: medium

## Reproduction Steps

1. Call `start_ghap` with domain, strategy, goal, hypothesis, action, and prediction
2. Observe the response - it contains all 8 fields (echoing back all input + id + created_at)
3. Call `resolve_ghap` with status and result
4. Observe the response - it contains 4 fields instead of minimal `{ok, id}`

**Expected**: Minimal responses: `{"ok": true, "id": "ghap_xxx"}`

**Actual**: Full records with all fields echoed back

---

## Problem

The GHAP MCP tools (`start_ghap`, `resolve_ghap`) return the full record with all fields on every operation. This wastes tokens, especially during bulk operations.

### Current Behavior

`start_ghap` returns:
```json
{"id": "ghap_xxx", "domain": "debugging", "strategy": "root-cause-analysis", "goal": "...", "hypothesis": "...", "action": "...", "prediction": "...", "created_at": "..."}
```

`resolve_ghap` returns:
```json
{"id": "ghap_xxx", "status": "confirmed", "confidence_tier": "silver", "resolved_at": "..."}
```

### Expected Behavior

Minimal responses that confirm success:

`start_ghap`:
```json
{"ok": true, "id": "ghap_xxx"}
```

`resolve_ghap`:
```json
{"ok": true, "id": "ghap_xxx"}
```

`update_ghap` (already good):
```json
{"success": true, "iteration_count": 2}
```

### Impact

- During bulk GHAP generation (e.g., 100 entries), returning full records wastes ~500+ tokens per entry
- Total waste: ~50,000 tokens for 100 entries
- Agents already know what they sent; echoing it back adds no value

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
Observed during bulk GHAP generation - each response contains full record that was just sent.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | Handlers return full dict | 8 fields in start_ghap, 4 in resolve_ghap | Minimal response | Code inspection confirms | **Confirmed** |

### Root Cause (Proven)

**The bug is caused by**: Tool handlers explicitly construct and return dictionaries with all fields instead of minimal acknowledgments.

**Evidence - Code inspection at `src/clams/server/tools/ghap.py`**:

1. **start_ghap handler** (lines 133-142): Returns 8 fields:
   ```python
   return {
       "id": entry.id,
       "domain": entry.domain.value,
       "strategy": entry.strategy.value,
       "goal": entry.goal,
       "hypothesis": entry.hypothesis,
       "action": entry.action,
       "prediction": entry.prediction,
       "created_at": entry.created_at.isoformat().replace("+00:00", "Z"),
   }
   ```

2. **resolve_ghap handler** (lines 413-418): Returns 4 fields:
   ```python
   return {
       "id": entry.id,
       "status": entry.outcome.status.value,
       "confidence_tier": entry.confidence_tier.value if entry.confidence_tier else None,
       "resolved_at": entry.outcome.captured_at.isoformat().replace("+00:00", "Z"),
   }
   ```

3. **update_ghap handler** (lines 215-218): Already follows minimal pattern (good):
   ```python
   return {"success": True, "iteration_count": entry.iteration_count}
   ```

---

## Fix Plan

### Code Changes

1. **File**: `src/clams/server/tools/ghap.py`
   **Function**: `start_ghap` handler
   **Change**: Return `{"ok": True, "id": ghap_id}` instead of full record

2. **File**: `src/clams/server/tools/ghap.py`
   **Function**: `resolve_ghap` handler
   **Change**: Return `{"ok": True, "id": ghap_id}` instead of full record

### Regression Test

**Test file**: `tests/server/tools/test_bug_030_regression.py`

**Test should**:
1. Call start_ghap and verify response only contains `ok` and `id`
2. Call resolve_ghap and verify response only contains `ok` and `id`
3. Verify no other fields are present in responses

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
