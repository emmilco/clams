# BUG-034: Float timeout truncation in QdrantVectorStore may cause zero timeout

## Reported

- **First noticed on commit**: fd6b43e
- **Reported by**: external investigator
- **Reported at**: 2025-12-11
- **Severity**: medium

## Reproduction Steps

1. Create a QdrantVectorStore with a float timeout value < 1.0 (e.g., 0.5)
2. Observe that the timeout becomes 0 due to int() truncation

**Expected**: Timeout of 0.5 seconds is preserved
**Actual**: Timeout becomes 0 (int(0.5) -> 0)

## Observations

In `src/clams/storage/qdrant.py` lines 59 and 65:
```python
self._client = AsyncQdrantClient(
    timeout=int(self._timeout),  # BUG: truncates 0.5 -> 0, 5.9 -> 5
)
```

The `int()` cast truncates float values:
- 0.5 -> 0 (zero timeout - may cause immediate timeouts)
- 5.9 -> 5 (loses 0.9 seconds)

**Investigation needed**:
1. Does Qdrant client accept float timeouts? If yes, remove `int()`
2. If not, should we use `round()` instead of `int()`?
3. What is the current default timeout value? Is this bug reachable in practice?

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:

Verified in Python REPL:
```python
>>> int(0.5)
0
>>> int(5.9)
5
```

The bug is mathematically confirmed: `int()` truncates toward zero, so any float timeout value < 1.0 becomes 0.

### Initial Hypothesis

The bug is in `src/clams/storage/qdrant.py` lines 59 and 65, where the `int()` cast unnecessarily converts float timeouts to integers. Since Qdrant underlying HTTP client (httpx) accepts float timeouts, the cast is both unnecessary and harmful.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | Qdrant client requires integer timeouts | TypeError when passing float | Float accepted without error | `AsyncQdrantClient(timeout=30.5)` succeeds | Eliminated |
| 2 | Type hint `Optional[int]` is enforced at runtime | TypeError when passing float | Float silently accepted | Float 30.5 accepted without error | Eliminated |
| 3 | The int() cast was added to satisfy mypy | No runtime error but mypy flags float | Type hint says int but float works | Type hint is `Optional[int]` but runtime accepts float | Confirmed |
| 4 | httpx requires int timeout | httpx.AsyncClient rejects float | httpx accepts float | `httpx.AsyncClient(timeout=0.5)` works | Eliminated |
| 5 | timeout=0 causes immediate timeout errors | Network ops fail immediately | Ops succeed or hang indefinitely | In httpx, timeout=0 means no timeout (infinite wait) | Noted |

### Evidentiary Scaffold

**Test 1: Qdrant client accepts float timeout**
```python
>>> from qdrant_client import AsyncQdrantClient
>>> client = AsyncQdrantClient(location=':memory:', timeout=30.5)
>>> print("SUCCESS")
SUCCESS
```

**Test 2: httpx accepts float timeout**
```python
>>> import httpx
>>> client = httpx.AsyncClient(timeout=0.5)
>>> print(client.timeout)
Timeout(timeout=0.5)
```

**Test 3: httpx timeout=0 means infinite wait**
```python
>>> client = httpx.AsyncClient(timeout=0)
>>> print(client.timeout)
Timeout(timeout=0)
# In httpx, 0 = no timeout (infinite wait), not immediate timeout
```

**Test 4: Default timeout is float in settings**
```python
>>> from clams.storage.base import StorageSettings
>>> settings = StorageSettings()
>>> print(f"{settings.qdrant_timeout} (type: {type(settings.qdrant_timeout).__name__})")
30.0 (type: float)
```

### Root Cause (Proven)

**The bug is caused by**: Unnecessary `int()` cast on timeout values at lines 59 and 65 of `src/clams/storage/qdrant.py`. This cast was likely added to satisfy the Qdrant client type hint of `Optional[int]`, but:

1. Python does not enforce type hints at runtime
2. The underlying httpx library accepts float timeouts
3. The cast truncates rather than rounds, causing values < 1.0 to become 0

**Evidence**:
- `AsyncQdrantClient(location=':memory:', timeout=30.5)` succeeds (Qdrant accepts floats)
- `httpx.AsyncClient(timeout=0.5)` works and properly sets a 500ms timeout
- `int(0.5)` returns `0`, demonstrating the truncation bug
- In httpx, `timeout=0` means no timeout (infinite wait), not immediate timeout - so truncating 0.5 to 0 changes semantic from 500ms timeout to infinite timeout

**Why alternatives were eliminated**:
- Hypothesis 1 (Qdrant requires int): Eliminated because passing float timeout directly to AsyncQdrantClient succeeds without error
- Hypothesis 2 (Runtime type enforcement): Eliminated because Python does not enforce type hints at runtime; the float is accepted
- Hypothesis 4 (httpx requires int): Eliminated because httpx.AsyncClient(timeout=0.5) works correctly

---

## Fix Plan

### Code Changes

1. **File**: `src/clams/storage/qdrant.py`
   **Lines**: 59 and 65
   **Change**: Remove the `int()` cast entirely. Pass `self._timeout` directly to the AsyncQdrantClient constructor.
   **Rationale**:
   - Qdrant client accepts float timeouts at runtime despite `Optional[int]` type hint
   - The underlying httpx library natively supports float timeouts
   - Removing `int()` preserves the exact timeout value specified by the user
   - For mypy compliance, add a `# type: ignore[arg-type]` comment

2. **Alternative** (if mypy strict compliance is required without ignores):
   **Change**: Use `round()` instead of `int()` to convert float to int
   **Rationale**: `round(0.5)` returns 0 (banker rounding) but `round(0.6)` returns 1, still better than truncation

### Recommended Fix (Option 1 - Remove int() cast)

```python
# Line 59 (in-memory mode)
self._client = AsyncQdrantClient(
    location=":memory:",
    timeout=self._timeout,  # type: ignore[arg-type]
)

# Line 65 (URL mode)
self._client = AsyncQdrantClient(
    url=self._url,
    api_key=self._api_key,
    timeout=self._timeout,  # type: ignore[arg-type]
)
```

### Regression Test

**Test file**: `tests/storage/test_bug_034_regression.py`

**Test should**:
1. Create QdrantVectorStore with a sub-second timeout (e.g., 0.5)
2. Verify the timeout value is not truncated to 0
3. Verify behavior with float values like 5.9 preserves the decimal

**Test outline**:
```python
import pytest
from unittest.mock import patch, MagicMock

def test_bug_034_float_timeout_not_truncated():
    """Regression test: Float timeout should not be truncated to int.

    Bug: int(0.5) = 0, which changes timeout semantics entirely.
    Fix: Remove int() cast, pass float directly to Qdrant client.
    """
    from clams.storage.qdrant import QdrantVectorStore

    # Mock AsyncQdrantClient to capture the timeout argument
    with patch('clams.storage.qdrant.AsyncQdrantClient') as mock_client:
        # Test with sub-second timeout
        store = QdrantVectorStore(url=":memory:", timeout=0.5)

        # Verify the timeout was NOT truncated to 0
        call_kwargs = mock_client.call_args.kwargs
        assert call_kwargs.get('timeout') == 0.5,             f"Expected timeout=0.5, got timeout={call_kwargs.get('timeout')} (truncation bug!)"

def test_bug_034_float_timeout_preserves_decimal():
    """Verify decimal portion of timeout is preserved."""
    from clams.storage.qdrant import QdrantVectorStore

    with patch('clams.storage.qdrant.AsyncQdrantClient') as mock_client:
        store = QdrantVectorStore(url=":memory:", timeout=5.9)

        call_kwargs = mock_client.call_args.kwargs
        # With bug: int(5.9) = 5
        # Fixed: 5.9 preserved
        assert call_kwargs.get('timeout') == 5.9,             f"Expected timeout=5.9, got timeout={call_kwargs.get('timeout')}"
```

### Verification

After implementing the fix:
```bash
# Run regression test
pytest tests/storage/test_bug_034_regression.py -xvs

# Run full test suite
pytest -xvs

# Verify mypy still passes
mypy --strict src/clams/storage/qdrant.py
```

---

## Implementation (filled by Implementer)

- **Implemented by**: [worker ID]
- **Commit**: [SHA]
- **Regression test file**: [path]

### Changes Made

[Brief summary of actual changes vs plan]

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
