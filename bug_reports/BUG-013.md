# BUG-013: search_commits fails with 'Commit object has no attribute score'

## Reported

- **First noticed on commit**: 372d7535e06753d773c46bb327eddc3ace434017
- **Reported by**: orchestrator
- **Reported at**: 2025-12-07
- **Severity**: high

## Reproduction Steps

1. Index some commits using `index_commits` MCP tool
2. Call `search_commits` with any query

**Example call**:
```python
# First index commits (this works)
index_commits(limit=50)
# Returns: {"commits_indexed": 50, "commits_skipped": 0, ...}

# Then search (this fails)
search_commits(query="fix bug error", limit=5)
```

**Expected**:
- Returns a list of commits matching the semantic query with similarity scores

**Actual**:
- Error: `Failed to search commits: 'Commit' object has no attribute 'score'`

## Notes

The error message suggests the code is trying to access a `.score` attribute on a `Commit` object, but the `Commit` model doesn't have this attribute. The score should come from the vector search results, not the `Commit` model itself.

Likely issue locations:
- `src/learning_memory_server/git/` - git-related code
- `src/learning_memory_server/server/tools/` - tool handler for search_commits

---

## Investigation (filled by Bug Investigator)

### Reproduction Confirmed

- [x] Steps reproduced bug

**Observations during reproduction**:
The bug is easily reproduced by code inspection. The error occurs at line 166 in `src/learning_memory_server/server/tools/git.py` where the code attempts to access `c.score` on a `Commit` object. The `Commit` dataclass (defined in `src/learning_memory_server/git/base.py` lines 48-59) does not have a `score` attribute.

### Initial Hypothesis

The `search_commits` tool handler in `src/learning_memory_server/server/tools/git.py` (line 166) attempts to access a `.score` attribute on `Commit` objects returned by `GitAnalyzer.search_commits()`. However, the `Commit` dataclass does not have this attribute. The score information is lost during the conversion from `SearchResult` objects (which DO have a `.score` attribute) to `Commit` objects in `GitAnalyzer.search_commits()`.

### Differential Diagnosis

| # | Hypothesis | If True, Would See | If False, Would See | Evidence | Status |
|---|------------|-------------------|---------------------|----------|--------|
| 1 | `Commit` dataclass is missing `score` field | `Commit` definition has no `score` field | `Commit` definition includes `score` field | Examined `git/base.py` lines 48-59: no `score` field exists | Confirmed |
| 2 | `GitAnalyzer.search_commits()` doesn't return scores | Method returns plain `Commit` objects without score data | Method returns objects with score data attached | Examined `git/analyzer.py` lines 310-365: converts `SearchResult` (with `.score`) to `Commit` (without score) | Confirmed |
| 3 | Vector search doesn't provide scores | `SearchResult` objects have no `score` attribute | `SearchResult` objects include `score` | Examined `storage/base.py` lines 14-22: `SearchResult` has `score: float` field | Eliminated - scores ARE available from vector search |
| 4 | Tool handler incorrectly accesses score | Handler code tries to access `.score` on `Commit` objects | Handler would access score from a different source | Examined `server/tools/git.py` line 166: `"score": c.score` directly accesses attribute on `Commit` object | Confirmed |

### Evidentiary Scaffold

**Code inspection evidence**:

1. **VectorStore returns SearchResult with scores**: `storage/base.py` lines 14-22
   ```python
   @dataclass
   class SearchResult:
       id: str
       score: float  # ← Score is available here
       payload: dict[str, Any]
       vector: Vector | None = None
   ```

2. **GitAnalyzer discards scores**: `git/analyzer.py` lines 348-363
   ```python
   # Convert payloads back to Commit objects
   commits = []
   for result in results:  # ← result is SearchResult with .score
       p = result.payload
       commits.append(
           Commit(  # ← Creates Commit WITHOUT preserving result.score
               sha=p["sha"],
               message=p["message"],
               # ... other fields but NO score
           )
       )
   return commits
   ```

3. **Tool handler assumes score exists**: `server/tools/git.py` line 166
   ```python
   formatted = [
       {
           # ... other fields ...
           "score": c.score,  # ← AttributeError: 'Commit' object has no attribute 'score'
       }
       for c in commits
   ]
   ```

**No runtime testing needed** - the bug is proven by code inspection and type analysis.

### Root Cause (Proven)

**The bug is caused by**: A data transformation error in `GitAnalyzer.search_commits()` that discards score information when converting `SearchResult` objects (which contain scores) to `Commit` objects (which don't have a score field).

**Evidence**:
1. The vector store search returns `SearchResult` objects with a `score` field (storage/base.py:14-22)
2. `GitAnalyzer.search_commits()` extracts payload data from `SearchResult` but discards the `score` field (git/analyzer.py:348-363)
3. The method returns `Commit` objects which lack a `score` attribute (git/base.py:48-59)
4. The tool handler tries to access the non-existent `.score` attribute (server/tools/git.py:166)

**Why alternatives were eliminated**:
- Hypothesis 3 (vector search doesn't provide scores) eliminated because: `SearchResult` dataclass explicitly includes `score: float` field, and vector search operations populate this field
- All other hypotheses confirmed and contribute to the root cause: the scores exist but are lost in translation

---

## Fix Plan

### Code Changes

**Option 1: Return SearchResult tuples (Recommended)**

1. **File**: `src/learning_memory_server/git/analyzer.py`
   **Function**: `search_commits` (lines 310-365)
   **Change**: Return a list of `(Commit, float)` tuples or create a new `CommitSearchResult` dataclass that includes both commit data and score
   **Rationale**: Preserves the semantic separation between the git domain model (`Commit`) and search-specific data (score). Keeps `Commit` clean for non-search operations.

   **Detailed approach**:
   ```python
   # In git/base.py, add new dataclass:
   @dataclass
   class CommitSearchResult:
       """Represents a commit with search relevance score."""
       commit: Commit
       score: float

   # In git/analyzer.py, modify search_commits() to return:
   results_with_scores = []
   for result in results:
       p = result.payload
       commit = Commit(...)
       results_with_scores.append(CommitSearchResult(commit=commit, score=result.score))
   return results_with_scores
   ```

2. **File**: `src/learning_memory_server/server/tools/git.py`
   **Function**: `search_commits` (lines 94-177)
   **Change**: Update formatting logic to handle `CommitSearchResult` objects
   **Rationale**: Extract both commit data and score from the new result type

   **Detailed approach**:
   ```python
   # Change line 155-169 from:
   formatted = [
       {
           "sha": c.sha,
           ...
           "score": c.score,  # ← This fails
       }
       for c in commits
   ]

   # To:
   formatted = [
       {
           "sha": r.commit.sha,
           "message": r.commit.message,
           "author": r.commit.author,
           "author_email": r.commit.author_email,
           "timestamp": r.commit.timestamp.isoformat(),
           "files_changed": r.commit.files_changed,
           "file_count": len(r.commit.files_changed),
           "insertions": r.commit.insertions,
           "deletions": r.commit.deletions,
           "score": r.score,  # ← Now accesses score from result wrapper
       }
       for r in commits  # ← Now iterates over CommitSearchResult objects
   ]
   ```

**Option 2: Add optional score field to Commit (Not Recommended)**

This would add `score: float | None = None` to the `Commit` dataclass. However, this pollutes the domain model with search-specific data and could cause confusion when `Commit` objects are used in non-search contexts (file history, blame, etc.).

**Chosen approach: Option 1** - Create `CommitSearchResult` wrapper to preserve clean separation of concerns.

### Regression Test

**Test file**: `tests/server/tools/test_git.py`

**Test should**:
1. Mock `GitAnalyzer.search_commits()` to return `CommitSearchResult` objects with scores
2. Call the `search_commits` tool handler
3. Verify the returned JSON includes score fields
4. Would fail before fix (AttributeError on c.score) but pass after fix

**Test outline**:
```python
@pytest.mark.asyncio
async def test_search_commits_includes_scores(mock_services):
    """Regression test for BUG-013: search_commits must return similarity scores."""
    from learning_memory_server.git.base import Commit, CommitSearchResult
    from datetime import datetime, UTC

    # Setup: Create mock commits with scores
    mock_results = [
        CommitSearchResult(
            commit=Commit(
                sha="abc123",
                message="Fix bug in parser",
                author="Test Author",
                author_email="test@example.com",
                timestamp=datetime(2024, 1, 1, 12, 0, tzinfo=UTC),
                files_changed=["parser.py"],
                insertions=10,
                deletions=5,
            ),
            score=0.95,
        ),
        CommitSearchResult(
            commit=Commit(
                sha="def456",
                message="Update documentation",
                author="Doc Writer",
                author_email="docs@example.com",
                timestamp=datetime(2024, 1, 2, 14, 0, tzinfo=UTC),
                files_changed=["README.md"],
                insertions=20,
                deletions=3,
            ),
            score=0.82,
        ),
    ]

    # Mock GitAnalyzer to return search results
    mock_analyzer = AsyncMock()
    mock_analyzer.search_commits.return_value = mock_results
    mock_services.git_analyzer = mock_analyzer

    # Action: Call search_commits tool
    tools = get_git_tools(mock_services)
    search_commits = tools["search_commits"]
    result = await search_commits(query="bug fix", limit=5)

    # Assert: Verify scores are included in response
    assert result["count"] == 2
    assert len(result["results"]) == 2

    # Check first result has all fields including score
    first_result = result["results"][0]
    assert first_result["sha"] == "abc123"
    assert first_result["message"] == "Fix bug in parser"
    assert first_result["score"] == 0.95  # ← Would fail before fix with AttributeError

    # Check second result
    second_result = result["results"][1]
    assert second_result["sha"] == "def456"
    assert second_result["score"] == 0.82
```

### Verification

After implementing the fix:
```bash
# Run specific regression test
pytest tests/server/tools/test_git.py::test_search_commits_includes_scores -xvs

# Run all git tool tests
pytest tests/server/tools/test_git.py -xvs

# Run full test suite
pytest -xvs

# Verify with mypy (should have no type errors)
mypy --strict src/learning_memory_server/git/analyzer.py
mypy --strict src/learning_memory_server/server/tools/git.py
```

---

## Implementation (filled by Implementer)

- **Implemented by**: W-1765135977-85561
- **Commit**: be14216
- **Regression test file**: tests/server/tools/test_git.py::test_search_commits_includes_scores

### Changes Made

Implemented exactly as planned in the fix plan:

1. **Added CommitSearchResult dataclass** (`src/learning_memory_server/git/base.py`):
   - New dataclass wrapping `Commit` with `score: float`
   - Preserves clean separation between git domain model and search results

2. **Modified GitAnalyzer.search_commits()** (`src/learning_memory_server/git/analyzer.py`):
   - Changed return type from `list[Commit]` to `list[CommitSearchResult]`
   - Now preserves `result.score` from vector search when creating results
   - Updated docstring to reflect new return type

3. **Updated tool handler** (`src/learning_memory_server/server/tools/git.py`):
   - Changed to iterate over `CommitSearchResult` objects (renamed `commits` to `search_results`)
   - Access commit fields via `r.commit.sha`, `r.commit.message`, etc.
   - Access score via `r.score`

4. **Added regression test** (`tests/server/tools/test_git.py`):
   - New test `test_search_commits_includes_scores()` verifies scores are preserved
   - Creates mock `CommitSearchResult` objects with explicit scores
   - Verifies all fields including score are present in JSON response

5. **Updated existing tests**:
   - Fixed `tests/git/test_analyzer.py` tests to handle `CommitSearchResult` instead of `Commit`
   - Fixed `test_index_and_search_commits_workflow` to use proper `CommitSearchResult` type
   - Corrected score range assertion (-1 to 1 for cosine similarity)

**Verification**: All tests pass, linter clean, mypy strict passes with no errors.

---

## Review (filled by Reviewers)

| Review # | Reviewer | Result | Date |
|----------|----------|--------|------|
| 1 | [worker ID] | [approved/changes_requested] | [date] |
| 2 | [worker ID] | [approved/changes_requested] | [date] |

---

## Resolution

- **Fixed in commit**: [SHA on main]
- **Verified by**: [worker ID]
- **Closed at**: [timestamp]
