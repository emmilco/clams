#!/usr/bin/env bash
#
# clams-review: Manage artifact reviews
#
# Usage:
#   clams-review record <task_id> <artifact_type> <result> [--worker <id>] [--issues <text>]
#   clams-review list <task_id> [<artifact_type>]
#   clams-review check <task_id> <artifact_type>
#   clams-review clear <task_id> [<artifact_type>]
#
# Artifact types: spec, proposal, code
# Results: approved, changes_requested

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/clams-common.sh"

REQUIRED_REVIEWS=2

if [[ ! -f "$DB_PATH" ]]; then
    echo "Error: Database not found at $DB_PATH. Run clams-init first." >&2
    exit 1
fi

usage() {
    echo "Usage:"
    echo "  clams-review record <task_id> <artifact_type> <result> [options]"
    echo "  clams-review list <task_id> [<artifact_type>]"
    echo "  clams-review check <task_id> <artifact_type>"
    echo "  clams-review clear <task_id> [<artifact_type>]"
    echo ""
    echo "Artifact types: spec, proposal, code"
    echo "Results: approved, changes_requested"
    echo ""
    echo "Options for 'record':"
    echo "  --worker <id>      Worker ID who performed review"
    echo "  --issues <text>    Issues found (for changes_requested)"
    echo ""
    echo "Examples:"
    echo "  clams-review record SPEC-001-01 spec approved --worker W-abc123"
    echo "  clams-review record SPEC-001-01 proposal changes_requested --issues 'Missing error handling'"
    echo "  clams-review check SPEC-001-01 spec"
    echo "  clams-review list SPEC-001-01"
    exit 1
}

validate_artifact_type() {
    local type="$1"
    case "$type" in
        spec|proposal|code) return 0 ;;
        *)
            echo "Error: Invalid artifact type '$type'. Must be: spec, proposal, code" >&2
            exit 1
            ;;
    esac
}

validate_result() {
    local result="$1"
    case "$result" in
        approved|changes_requested) return 0 ;;
        *)
            echo "Error: Invalid result '$result'. Must be: approved, changes_requested" >&2
            exit 1
            ;;
    esac
}

cmd_record() {
    local task_id="$1"
    local artifact_type="$2"
    local result="$3"
    shift 3

    validate_artifact_type "$artifact_type"
    validate_result "$result"

    local worker_id=""
    local issues=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --worker)
                worker_id="$2"
                shift 2
                ;;
            --issues)
                issues="$2"
                shift 2
                ;;
            *)
                echo "Unknown option: $1" >&2
                usage
                ;;
        esac
    done

    # Check task exists
    local task_exists
    task_exists=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM tasks WHERE id = '$task_id';")
    if [[ "$task_exists" -eq 0 ]]; then
        echo "Error: Task not found: $task_id" >&2
        exit 1
    fi

    # Get next review number for this artifact
    local existing_count
    existing_count=$(sqlite3 "$DB_PATH" \
        "SELECT COUNT(*) FROM reviews WHERE task_id = '$task_id' AND artifact_type = '$artifact_type';")

    if [[ "$existing_count" -ge "$REQUIRED_REVIEWS" ]]; then
        echo "Error: Already have $REQUIRED_REVIEWS reviews for $artifact_type on $task_id" >&2
        echo "Use 'clams-review clear $task_id $artifact_type' to reset if needed." >&2
        exit 1
    fi

    local review_num=$((existing_count + 1))

    # If changes_requested, clear any existing reviews (restart the review cycle)
    if [[ "$result" == "changes_requested" ]]; then
        sqlite3 "$DB_PATH" \
            "DELETE FROM reviews WHERE task_id = '$task_id' AND artifact_type = '$artifact_type';"
        echo "Review cycle restarted due to changes requested."
        review_num=1
    fi

    # Escape single quotes for SQL
    local issues_escaped="${issues//\'/\'\'}"
    local worker_escaped="${worker_id//\'/\'\'}"

    # Insert review
    sqlite3 "$DB_PATH" <<EOF
INSERT INTO reviews (task_id, artifact_type, review_num, reviewer_worker_id, result, issues_found)
VALUES ('$task_id', '$artifact_type', $review_num, '$worker_escaped', '$result', '$issues_escaped');
EOF

    echo "Review recorded:"
    echo "  Task: $task_id"
    echo "  Artifact: $artifact_type"
    echo "  Review #: $review_num of $REQUIRED_REVIEWS"
    echo "  Result: $result"
    [[ -n "$worker_id" ]] && echo "  Reviewer: $worker_id"
    [[ -n "$issues" ]] && echo "  Issues: $issues"

    # Show status
    local approved_count
    approved_count=$(sqlite3 "$DB_PATH" \
        "SELECT COUNT(*) FROM reviews WHERE task_id = '$task_id' AND artifact_type = '$artifact_type' AND result = 'approved';")

    if [[ "$approved_count" -ge "$REQUIRED_REVIEWS" ]]; then
        echo ""
        echo "✓ $artifact_type has $REQUIRED_REVIEWS approved reviews - gate requirement met"
    else
        local remaining=$((REQUIRED_REVIEWS - approved_count))
        echo ""
        echo "→ $remaining more approved review(s) needed for $artifact_type"
    fi
}

cmd_list() {
    local task_id="$1"
    local artifact_type="${2:-}"

    local where_clause="WHERE task_id = '$task_id'"
    if [[ -n "$artifact_type" ]]; then
        validate_artifact_type "$artifact_type"
        where_clause="$where_clause AND artifact_type = '$artifact_type'"
    fi

    echo "=== Reviews for $task_id ==="
    echo ""

    local reviews
    reviews=$(sqlite3 -header -column "$DB_PATH" \
        "SELECT artifact_type, review_num, result, reviewer_worker_id, created_at
         FROM reviews $where_clause ORDER BY artifact_type, review_num;")

    if [[ -z "$reviews" ]]; then
        echo "No reviews recorded."
    else
        echo "$reviews"
    fi

    echo ""
    echo "=== Summary ==="
    for type in spec proposal code; do
        local count
        count=$(sqlite3 "$DB_PATH" \
            "SELECT COUNT(*) FROM reviews WHERE task_id = '$task_id' AND artifact_type = '$type' AND result = 'approved';")
        local status
        if [[ "$count" -ge "$REQUIRED_REVIEWS" ]]; then
            status="✓ COMPLETE ($count/$REQUIRED_REVIEWS)"
        elif [[ "$count" -gt 0 ]]; then
            status="→ IN PROGRESS ($count/$REQUIRED_REVIEWS)"
        else
            status="  NOT STARTED (0/$REQUIRED_REVIEWS)"
        fi
        printf "  %-10s %s\n" "$type:" "$status"
    done
}

cmd_check() {
    local task_id="$1"
    local artifact_type="$2"

    validate_artifact_type "$artifact_type"

    local approved_count
    approved_count=$(sqlite3 "$DB_PATH" \
        "SELECT COUNT(*) FROM reviews WHERE task_id = '$task_id' AND artifact_type = '$artifact_type' AND result = 'approved';")

    echo "=== Review Check: $task_id / $artifact_type ==="
    echo "Required: $REQUIRED_REVIEWS approved reviews"
    echo "Current:  $approved_count approved"
    echo ""

    if [[ "$approved_count" -ge "$REQUIRED_REVIEWS" ]]; then
        echo "✓ PASS: Review requirement met"
        exit 0
    else
        local remaining=$((REQUIRED_REVIEWS - approved_count))
        echo "✗ FAIL: Need $remaining more approved review(s)"
        exit 1
    fi
}

cmd_clear() {
    local task_id="$1"
    local artifact_type="${2:-}"

    local where_clause="WHERE task_id = '$task_id'"
    local desc="all reviews for $task_id"

    if [[ -n "$artifact_type" ]]; then
        validate_artifact_type "$artifact_type"
        where_clause="$where_clause AND artifact_type = '$artifact_type'"
        desc="$artifact_type reviews for $task_id"
    fi

    local count
    count=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM reviews $where_clause;")

    if [[ "$count" -eq 0 ]]; then
        echo "No reviews to clear."
        exit 0
    fi

    sqlite3 "$DB_PATH" "DELETE FROM reviews $where_clause;"
    echo "Cleared $count review(s): $desc"
}

# Main
if [[ $# -lt 1 ]]; then
    usage
fi

command="$1"
shift

case "$command" in
    record)
        [[ $# -lt 3 ]] && usage
        cmd_record "$@"
        ;;
    list)
        [[ $# -lt 1 ]] && usage
        cmd_list "$@"
        ;;
    check)
        [[ $# -lt 2 ]] && usage
        cmd_check "$@"
        ;;
    clear)
        [[ $# -lt 1 ]] && usage
        cmd_clear "$@"
        ;;
    *)
        echo "Unknown command: $command" >&2
        usage
        ;;
esac
