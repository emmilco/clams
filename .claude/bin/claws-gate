#!/usr/bin/env bash
#
# claws-gate: Run gate checks for phase transitions
#
# Usage:
#   claws-gate check <task_id> <transition>
#   claws-gate list
#
# Feature transitions: SPEC-DESIGN, DESIGN-IMPLEMENT, IMPLEMENT-CODE_REVIEW,
#                      CODE_REVIEW-TEST, TEST-INTEGRATE, INTEGRATE-VERIFY, VERIFY-DONE
#
# Bug transitions: REPORTED-INVESTIGATED, INVESTIGATED-FIXED, FIXED-REVIEWED,
#                  REVIEWED-TESTED, TESTED-MERGED, MERGED-DONE

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/claws-common.sh"

if [[ ! -f "$DB_PATH" ]]; then
    echo "Error: Database not found at $DB_PATH. Run claws-init first." >&2
    exit 1
fi

# Read directory configuration from project.json
# Falls back to defaults if config is missing or invalid
PROJECT_CONFIG="$SCRIPT_DIR/../project.json"

get_impl_dirs() {
    if [[ -f "$PROJECT_CONFIG" ]] && command -v jq &>/dev/null; then
        local dirs
        dirs=$(jq -r '.implementation_dirs[]? // empty' "$PROJECT_CONFIG" 2>/dev/null | tr '\n' ' ')
        if [[ -n "$dirs" ]]; then
            echo "$dirs"
            return
        fi
    fi
    # Default fallback
    echo "src/ tests/"
}

get_test_dirs() {
    if [[ -f "$PROJECT_CONFIG" ]] && command -v jq &>/dev/null; then
        local dirs
        dirs=$(jq -r '.test_dirs[]? // empty' "$PROJECT_CONFIG" 2>/dev/null | tr '\n' ' ')
        if [[ -n "$dirs" ]]; then
            echo "$dirs"
            return
        fi
    fi
    # Default fallback
    echo "tests/"
}

get_frontend_dirs() {
    if [[ -f "$PROJECT_CONFIG" ]] && command -v jq &>/dev/null; then
        local dirs
        dirs=$(jq -r '.frontend_dirs[]? // empty' "$PROJECT_CONFIG" 2>/dev/null | tr '\n' ' ')
        if [[ -n "$dirs" ]]; then
            echo "$dirs"
            return
        fi
    fi
    # Default fallback
    echo "clams-visualizer/"
}

# Build git diff path arguments from directory list
build_git_paths() {
    local dirs="$1"
    local paths=""
    for dir in $dirs; do
        paths="$paths '$dir'"
    done
    echo "$paths"
}

# Record a successful gate pass in the database.
# The UNIQUE constraint on (task_id, transition, commit_sha) means:
# - Same commit can only have one record per gate (INSERT OR REPLACE updates timestamp)
# - Different commits create new records, preserving history
record_gate_pass() {
    local task_id="$1"
    local transition="$2"
    local worktree="$3"

    # Get current commit SHA
    local commit_sha
    commit_sha=$(cd "$worktree" && git rev-parse HEAD)

    if [[ -z "$commit_sha" ]]; then
        echo "Error: Could not determine commit SHA" >&2
        return 1
    fi

    # Record in database with proper SQL escaping
    # Task IDs and transitions are controlled strings (alphanumeric + hyphen)
    # Commit SHAs are hex strings from git - safe but we escape anyway
    sqlite3 "$DB_PATH" <<EOF
INSERT OR REPLACE INTO gate_passes (task_id, transition, commit_sha)
VALUES ('$(echo "$task_id" | sed "s/'/''/g")', '$(echo "$transition" | sed "s/'/''/g")', '$(echo "$commit_sha" | sed "s/'/''/g")');
EOF

    echo "Gate pass recorded for commit ${commit_sha:0:7}"
}

usage() {
    echo "Usage:"
    echo "  claws-gate check <task_id> <transition>   Run gate checks"
    echo "  claws-gate list                           List transitions and their gates"
    echo ""
    echo "Transitions:"
    echo "  SPEC-DESIGN       Human approves spec"
    echo "  DESIGN-IMPLEMENT  Human approves design, proposal documented"
    echo "  IMPLEMENT-CODE_REVIEW  Tests pass, linter clean, type check, code exists"
    echo "  CODE_REVIEW-TEST       2 code reviews approved"
    echo "  TEST-INTEGRATE    Full test suite passes"
    echo "  INTEGRATE-VERIFY  Clean merge, suite passes, docs updated"
    echo "  VERIFY-DONE       Acceptance verified, no orphans"
    exit 1
}

cmd_list() {
    echo "=== Feature Gate Requirements by Transition ==="
    echo ""
    echo "SPEC → DESIGN (semi-automated)"
    echo "  - [auto] 2 spec reviews with APPROVED status"
    echo "  - Human approves spec"
    echo ""
    echo "DESIGN → IMPLEMENT (semi-automated)"
    echo "  - [auto] Technical proposal exists in planning_docs/"
    echo "  - [auto] 2 proposal reviews with APPROVED status"
    echo "  - Human approves design"
    echo ""
    echo "IMPLEMENT → CODE_REVIEW (automated)"
    echo "  - [auto] Tests pass (check_tests.sh)"
    echo "  - [auto] Linter clean (check_linter.sh)"
    echo "  - [auto] Type check clean (check_types.sh)"
    echo "  - [auto] No untracked TODOs (check_todos.sh)"
    echo "  - [auto] Implementation code exists in configured dirs ($(get_impl_dirs))"
    echo ""
    echo "CODE_REVIEW → TEST (automated)"
    echo "  - [auto] 2 code reviews with APPROVED status"
    echo ""
    echo "TEST → INTEGRATE (automated)"
    echo "  - [auto] Full test suite passes (check_tests.sh)"
    echo ""
    echo "INTEGRATE → VERIFY (semi-automated)"
    echo "  - [auto] Changelog entry exists (changelog.d/TASK-XXX.md)"
    echo "  - Then run: claws-worktree merge TASK-XXX"
    echo ""
    echo "VERIFY → DONE (manual - worktree gone)"
    echo "  - Run tests on main branch"
    echo "  - Verify acceptance criteria met"
    echo "  - Check for orphaned code"
    echo ""
    echo "=== Bug Gate Requirements by Transition ==="
    echo ""
    echo "REPORTED → INVESTIGATED (automated)"
    echo "  - [auto] Bug report exists (bug_reports/BUG-XXX.md)"
    echo "  - [auto] Reproduction steps documented"
    echo "  - [auto] Root cause section filled"
    echo "  - [auto] Fix plan documented"
    echo ""
    echo "INVESTIGATED → FIXED (automated)"
    echo "  - [auto] Tests pass (check_tests.sh)"
    echo "  - [auto] Linter clean (check_linter.sh)"
    echo "  - [auto] Type check clean (check_types.sh)"
    echo "  - [auto] Implementation code exists in configured dirs ($(get_impl_dirs))"
    echo "  - [auto] Regression test added (new test file or test function)"
    echo ""
    echo "FIXED → REVIEWED (automated)"
    echo "  - [auto] 2 bugfix reviews with APPROVED status"
    echo ""
    echo "REVIEWED → TESTED (automated)"
    echo "  - [auto] Full test suite passes, no skipped tests (check_tests.sh)"
    echo ""
    echo "TESTED → MERGED (semi-automated)"
    echo "  - [auto] Changelog entry exists (changelog.d/BUG-XXX.md)"
    echo "  - Then run: claws-worktree merge BUG-XXX"
    echo ""
    echo "MERGED → DONE (manual - worktree gone)"
    echo "  - Run tests on main branch"
    echo "  - Verify bug is fixed"
    echo "  - Verify regression test passes"
}

run_gate() {
    local name="$1"
    local script="$2"
    local worktree="$3"
    local extra_arg="${4:-}"

    echo "--- Gate: $name ---"
    if [[ -n "$extra_arg" ]]; then
        if "$GATES_DIR/$script" "$worktree" "$extra_arg"; then
            echo "✓ $name: PASS"
            return 0
        else
            echo "✗ $name: FAIL"
            return 1
        fi
    else
        if "$GATES_DIR/$script" "$worktree"; then
            echo "✓ $name: PASS"
            return 0
        else
            echo "✗ $name: FAIL"
            return 1
        fi
    fi
}

# Run a gate check via the dispatcher (type-aware routing)
# Usage: run_dispatch_gate <description> <category> <worktree> [project_type]
run_dispatch_gate() {
    local name="$1"
    local category="$2"
    local worktree="$3"
    local project_type="${4:-}"

    echo "--- Gate: $name ---"

    local dispatch_args=("$category" "$worktree")
    if [[ -n "$project_type" ]]; then
        dispatch_args+=("$project_type")
    fi

    if "$SCRIPT_DIR/claws-gate-dispatch" "${dispatch_args[@]}"; then
        echo "✓ $name: PASS"
        return 0
    else
        local exit_code=$?
        if [[ $exit_code -eq 2 ]]; then
            # Exit code 2 = configuration error or tool not available (skip)
            echo "⚠ $name: SKIP (tool not available)"
            return 0
        fi
        echo "✗ $name: FAIL"
        return 1
    fi
}

# Run checks for composite project (multiple language subdirs)
# Usage: run_composite_checks <worktree>
# Returns: 0 if all checks pass, 1 if any check fails
run_composite_checks() {
    local worktree="$1"
    local composite_failed=0

    # Read composite types from project.json
    local project_config="$CLAUDE_DIR/project.json"

    if [[ ! -f "$project_config" ]] || ! command -v jq &>/dev/null; then
        return 0
    fi

    # Check if composite_types is configured
    if ! jq -e '.gate_config.composite_types' "$project_config" &>/dev/null; then
        return 0
    fi

    echo ""
    echo "=== Composite Project Checks ==="

    # Iterate over composite subdirs
    local subdirs
    subdirs=$(jq -r '.gate_config.composite_types | keys[]' "$project_config" 2>/dev/null)

    for subdir in $subdirs; do
        local subtype subpath
        subtype=$(jq -r --arg d "$subdir" '.gate_config.composite_types[$d]' "$project_config")
        subpath="$worktree/$subdir"

        if [[ ! -d "$subpath" ]]; then
            echo "Warning: Composite subdir not found: $subpath"
            continue
        fi

        echo ""
        echo "--- Checking composite subdir: $subdir ($subtype) ---"

        # Run checks for this subdir with explicit type
        if ! run_dispatch_gate "Tests pass ($subdir)" "tests" "$subpath" "$subtype"; then
            composite_failed=1
        fi
        echo ""
        if ! run_dispatch_gate "Linter clean ($subdir)" "linter" "$subpath" "$subtype"; then
            composite_failed=1
        fi
        echo ""
        if ! run_dispatch_gate "Type check ($subdir)" "types" "$subpath" "$subtype"; then
            composite_failed=1
        fi
    done

    return $composite_failed
}

check_file_exists() {
    local path="$1"
    local desc="$2"

    echo "--- Gate: $desc ---"
    if [[ -f "$path" ]]; then
        echo "✓ $desc: PASS (found: $path)"
        return 0
    else
        echo "✗ $desc: FAIL (not found: $path)"
        return 1
    fi
}

check_dir_not_empty() {
    local path="$1"
    local desc="$2"

    echo "--- Gate: $desc ---"
    if [[ -d "$path" ]] && [[ -n "$(ls -A "$path" 2>/dev/null)" ]]; then
        echo "✓ $desc: PASS"
        ls "$path"
        return 0
    else
        echo "✗ $desc: FAIL (empty or missing: $path)"
        return 1
    fi
}

check_reviews() {
    local task_id="$1"
    local artifact_type="$2"
    local required=2

    echo "--- Gate: $artifact_type reviews (${required}x required) ---"

    local approved_count
    approved_count=$(sqlite3 "$DB_PATH" \
        "SELECT COUNT(*) FROM reviews WHERE task_id = '$task_id' AND artifact_type = '$artifact_type' AND result = 'approved';")

    if [[ "$approved_count" -ge "$required" ]]; then
        echo "✓ $artifact_type reviews: PASS ($approved_count/$required approved)"
        # Show review details
        sqlite3 -header -column "$DB_PATH" \
            "SELECT review_num, reviewer_worker_id, result, created_at FROM reviews
             WHERE task_id = '$task_id' AND artifact_type = '$artifact_type'
             ORDER BY review_num;" | sed 's/^/  /'
        return 0
    else
        echo "✗ $artifact_type reviews: FAIL ($approved_count/$required approved)"
        echo ""
        echo "  Required: $required approved reviews"
        echo "  Current:  $approved_count approved"
        echo ""
        echo "  Record reviews with:"
        echo "    .claude/bin/claws-review record $task_id $artifact_type approved --worker <worker_id>"
        return 1
    fi
}

cmd_check() {
    local task_id="$1"
    local transition="$2"

    # Get worktree path
    local worktree
    worktree=$(sqlite3 "$DB_PATH" "SELECT worktree_path FROM tasks WHERE id = '$task_id';")

    if [[ -z "$worktree" ]]; then
        echo "Error: Task not found or no worktree: $task_id" >&2
        exit 1
    fi

    if [[ ! -d "$worktree" ]]; then
        echo "Error: Worktree directory not found: $worktree" >&2
        exit 1
    fi

    echo "=== Gate Check: $transition ==="
    echo "Task: $task_id"
    echo "Worktree: $worktree"

    # Detect project type for this worktree
    local project_type
    project_type=$(detect_project_type "$worktree")
    echo "Project type: $project_type"
    echo ""

    local failed=0

    case "$transition" in
        SPEC-DESIGN)
            echo "This transition requires HUMAN APPROVAL after reviews complete."
            echo ""
            # Check for 2 spec reviews
            if ! check_reviews "$task_id" "spec"; then
                failed=1
            fi
            echo ""
            if [[ $failed -eq 0 ]]; then
                echo "Reviews complete. Human can now approve the spec."
            fi
            ;;

        DESIGN-IMPLEMENT)
            echo "This transition requires HUMAN APPROVAL after reviews complete."
            echo ""
            # Check for proposal
            if ! check_dir_not_empty "$worktree/planning_docs/$task_id" "Technical proposal exists"; then
                failed=1
            fi
            echo ""
            # Check for 2 proposal reviews
            if ! check_reviews "$task_id" "proposal"; then
                failed=1
            fi
            echo ""
            if [[ $failed -eq 0 ]]; then
                echo "Proposal and reviews complete. Human can now approve the design."
            fi
            ;;

        IMPLEMENT-CODE_REVIEW)
            echo ""
            # Check for actual implementation code
            echo "--- Gate: Implementation code exists ---"
            local code_changes
            # Check implementation dirs from config (includes src/, clams-visualizer/, etc.)
            local impl_dirs test_dirs frontend_dirs
            impl_dirs=$(get_impl_dirs)
            test_dirs=$(get_test_dirs)
            frontend_dirs=$(get_frontend_dirs)
            # Build path arguments for git diff
            local all_impl_dirs="$impl_dirs $test_dirs"
            code_changes=$(cd "$worktree" && eval "git diff main...HEAD --name-only -- $all_impl_dirs" 2>/dev/null | grep -v '__pycache__' | head -10)
            if [[ -z "$code_changes" ]]; then
                echo "✗ Implementation code exists: FAIL"
                echo ""
                echo "No changes found in configured implementation directories: $all_impl_dirs"
                echo "The task appears to have only documentation changes."
                failed=1
            else
                echo "✓ Implementation code exists: PASS"
                echo "Changed files:"
                echo "$code_changes" | sed 's/^/  /'
            fi

            # Run type-aware checks via dispatcher
            echo ""
            if ! run_dispatch_gate "Tests pass" "tests" "$worktree"; then
                failed=1
            fi
            echo ""
            if ! run_dispatch_gate "Linter clean" "linter" "$worktree"; then
                failed=1
            fi
            echo ""
            if ! run_dispatch_gate "Type check clean" "types" "$worktree"; then
                failed=1
            fi
            echo ""
            if ! run_dispatch_gate "No untracked TODOs" "todos" "$worktree"; then
                failed=1
            fi

            # Run composite project checks if configured
            if ! run_composite_checks "$worktree"; then
                failed=1
            fi
            ;;

        CODE_REVIEW-TEST)
            echo "This transition requires 2 code reviews with APPROVED status."
            echo ""
            # Check for 2 code reviews
            if ! check_reviews "$task_id" "code"; then
                failed=1
            fi
            ;;

        TEST-INTEGRATE)
            echo ""
            if ! run_dispatch_gate "Full test suite passes" "tests" "$worktree"; then
                failed=1
            fi
            ;;

        INTEGRATE-VERIFY)
            # Check changelog entry exists
            echo ""
            if ! check_file_exists "$worktree/changelog.d/$task_id.md" "Changelog entry exists"; then
                failed=1
            fi
            echo ""
            echo "NOTE: Merge and post-merge tests handled by claws-worktree merge"
            ;;

        VERIFY-DONE)
            echo "NOTE: VERIFY phase runs on main branch after merge."
            echo "Worktree no longer exists - automated checks limited."
            echo ""
            echo "MANUAL CHECKS REQUIRED:"
            echo "  1. Run tests on main: pytest -xvs"
            echo "  2. Verify all acceptance criteria are met"
            echo "  3. Check for orphaned code (unused imports, dead functions)"
            echo ""
            echo "If all checks pass, transition with:"
            echo "  .claude/bin/claws-task transition $task_id DONE --gate-result pass"
            exit 0
            ;;

        # ========== BUG TRANSITIONS ==========

        REPORTED-INVESTIGATED)
            echo ""
            # Check bug report exists
            if ! check_file_exists "$worktree/bug_reports/$task_id.md" "Bug report exists"; then
                failed=1
            fi
            echo ""
            # Check required sections are filled (basic structure)
            echo "--- Gate: Bug report sections complete ---"
            local bug_report="$worktree/bug_reports/$task_id.md"
            local missing_sections=()

            if ! grep -q "## Reproduction Steps" "$bug_report" 2>/dev/null; then
                missing_sections+=("Reproduction Steps")
            fi
            if ! grep -q "### Root Cause" "$bug_report" 2>/dev/null; then
                missing_sections+=("Root Cause")
            fi
            if ! grep -q "## Fix Plan" "$bug_report" 2>/dev/null; then
                missing_sections+=("Fix Plan")
            fi

            if [[ ${#missing_sections[@]} -gt 0 ]]; then
                echo "✗ Bug report sections: FAIL"
                echo "  Missing sections:"
                for section in "${missing_sections[@]}"; do
                    echo "    - $section"
                done
                failed=1
            else
                echo "✓ Bug report sections: PASS"
            fi

            # Run investigation quality checks (SPEC-011)
            echo ""
            if ! run_gate "Investigation quality" "check_bug_investigation.sh" "$worktree" "$task_id"; then
                failed=1
            fi
            ;;

        INVESTIGATED-FIXED)
            echo ""
            # Check for actual implementation code
            echo "--- Gate: Implementation code exists ---"
            local code_changes
            # Read directories from config
            local impl_dirs test_dirs
            impl_dirs=$(get_impl_dirs)
            test_dirs=$(get_test_dirs)
            local all_impl_dirs="$impl_dirs $test_dirs"
            code_changes=$(cd "$worktree" && eval "git diff main...HEAD --name-only -- $all_impl_dirs" 2>/dev/null | grep -v '__pycache__' | head -10)
            if [[ -z "$code_changes" ]]; then
                echo "✗ Implementation code exists: FAIL"
                echo ""
                echo "No changes found in configured directories: $all_impl_dirs"
                failed=1
            else
                echo "✓ Implementation code exists: PASS"
                echo "Changed files:"
                echo "$code_changes" | sed 's/^/  /'
            fi
            echo ""

            # Check regression test was added (language-appropriate pattern)
            echo "--- Gate: Regression test added ---"
            local test_changes test_pattern
            case "$project_type" in
                python) test_pattern='\.py$' ;;
                javascript) test_pattern='\.(js|ts|jsx|tsx)$' ;;
                rust) test_pattern='\.rs$' ;;
                go) test_pattern='_test\.go$' ;;
                *) test_pattern='\.*' ;;
            esac
            test_changes=$(cd "$worktree" && eval "git diff main...HEAD --name-only -- $test_dirs" 2>/dev/null | grep -v '__pycache__' | grep -E "$test_pattern" || true)
            if [[ -z "$test_changes" ]]; then
                echo "✗ Regression test added: FAIL"
                echo ""
                echo "Bug fixes must include regression tests."
                echo "No test file changes found in configured test directories: $test_dirs"
                failed=1
            else
                echo "✓ Regression test added: PASS"
                echo "Test files changed:"
                echo "$test_changes" | sed 's/^/  /'
            fi
            echo ""

            # Run type-aware checks via dispatcher
            if ! run_dispatch_gate "Tests pass" "tests" "$worktree"; then
                failed=1
            fi
            echo ""
            if ! run_dispatch_gate "Linter clean" "linter" "$worktree"; then
                failed=1
            fi
            echo ""
            if ! run_dispatch_gate "Type check clean" "types" "$worktree"; then
                failed=1
            fi
            ;;

        FIXED-REVIEWED)
            echo "This transition requires 2 bugfix reviews with APPROVED status."
            echo ""
            if ! check_reviews "$task_id" "bugfix"; then
                failed=1
            fi
            ;;

        REVIEWED-TESTED)
            echo ""
            # Test check already enforces no skipped tests (fails if any are skipped)
            # So this single gate covers both "tests pass" and "no skipped tests"
            if ! run_dispatch_gate "Full test suite passes (no skipped tests)" "tests" "$worktree"; then
                failed=1
            fi
            ;;

        TESTED-MERGED)
            echo ""
            if ! check_file_exists "$worktree/changelog.d/$task_id.md" "Changelog entry exists"; then
                failed=1
            fi
            echo ""
            echo "NOTE: Merge handled by claws-worktree merge"
            ;;

        MERGED-DONE)
            echo "NOTE: MERGED phase runs on main branch after merge."
            echo "Worktree no longer exists - automated checks limited."
            echo ""
            echo "MANUAL CHECKS REQUIRED:"
            echo "  1. Run tests on main: pytest -xvs"
            echo "  2. Verify the bug is fixed"
            echo "  3. Verify regression test catches the original bug"
            echo ""
            echo "If all checks pass, transition with:"
            echo "  .claude/bin/claws-task transition $task_id DONE --gate-result pass"
            exit 0
            ;;

        *)
            echo "Unknown transition: $transition" >&2
            echo ""
            usage
            ;;
    esac

    echo ""
    echo "=========================================="
    if [[ $failed -eq 0 ]]; then
        echo "GATE RESULT: PASS"

        # Record gate pass for transitions that require verification
        case "$transition" in
            IMPLEMENT-CODE_REVIEW|TEST-INTEGRATE|INVESTIGATED-FIXED|REVIEWED-TESTED)
                record_gate_pass "$task_id" "$transition" "$worktree"
                ;;
        esac

        echo ""
        echo "Proceed with transition:"
        echo "  .claude/bin/claws-task transition $task_id <next_phase> --gate-result pass"
        exit 0
    else
        echo "GATE RESULT: FAIL"
        echo ""
        echo "Fix the failing gates before proceeding."
        exit 1
    fi
}

# Main
if [[ $# -lt 1 ]]; then
    usage
fi

command="$1"
shift

case "$command" in
    check)
        [[ $# -lt 2 ]] && usage
        cmd_check "$@"
        ;;
    list)
        cmd_list
        ;;
    *)
        echo "Unknown command: $command" >&2
        usage
        ;;
esac
