#!/usr/bin/env bash
#
# clams-backup: Database backup and restore utilities
#
# Usage:
#   clams-backup create [name]     Create a backup (optional name)
#   clams-backup list              List available backups
#   clams-backup restore <name>    Restore from a backup
#   clams-backup auto              Create auto-backup (rotates, keeps last 10)

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/claws-common.sh"
BACKUP_DIR="$CLAUDE_DIR/backups"

# Ensure backup directory exists
mkdir -p "$BACKUP_DIR"

usage() {
    echo "Usage:"
    echo "  clams-backup create [name]     Create a named backup"
    echo "  clams-backup list              List available backups"
    echo "  clams-backup restore <name>    Restore from a backup"
    echo "  clams-backup auto              Create auto-backup (keeps last 10)"
    exit 1
}

cmd_create() {
    local name="${1:-$(date +%Y%m%d_%H%M%S)}"
    local backup_path="$BACKUP_DIR/clams_${name}.db"

    if [[ ! -f "$DB_PATH" ]]; then
        echo "Error: Database not found at $DB_PATH" >&2
        exit 1
    fi

    # Use sqlite3 backup command for consistency
    sqlite3 "$DB_PATH" ".backup '$backup_path'"

    echo "Backup created: $backup_path"

    # Show backup info
    local task_count
    task_count=$(sqlite3 "$backup_path" "SELECT COUNT(*) FROM tasks;")
    echo "  Tasks: $task_count"
}

cmd_list() {
    echo "=== Available Backups ==="
    echo ""

    if [[ ! -d "$BACKUP_DIR" ]] || [[ -z "$(ls -A "$BACKUP_DIR" 2>/dev/null)" ]]; then
        echo "No backups found."
        return
    fi

    for backup in "$BACKUP_DIR"/clams_*.db; do
        if [[ -f "$backup" ]]; then
            local name
            name=$(basename "$backup" .db | sed 's/clams_//')
            local size
            size=$(du -h "$backup" | cut -f1)
            local task_count
            task_count=$(sqlite3 "$backup" "SELECT COUNT(*) FROM tasks;" 2>/dev/null || echo "?")
            local date_modified
            date_modified=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M" "$backup" 2>/dev/null || stat -c "%y" "$backup" 2>/dev/null | cut -d. -f1 || echo "?")

            printf "%-25s %6s  %3s tasks  %s\n" "$name" "$size" "$task_count" "$date_modified"
        fi
    done
}

cmd_restore() {
    local name="$1"
    local backup_path="$BACKUP_DIR/clams_${name}.db"

    if [[ ! -f "$backup_path" ]]; then
        echo "Error: Backup not found: $backup_path" >&2
        echo ""
        echo "Available backups:"
        cmd_list
        exit 1
    fi

    # Create a backup of current state first
    if [[ -f "$DB_PATH" ]]; then
        local safety_backup="$BACKUP_DIR/clams_pre_restore_$(date +%Y%m%d_%H%M%S).db"
        sqlite3 "$DB_PATH" ".backup '$safety_backup'"
        echo "Current state backed up to: $safety_backup"
    fi

    # Restore
    cp "$backup_path" "$DB_PATH"

    echo "Restored from: $backup_path"

    # Show restored info
    local task_count
    task_count=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM tasks;")
    echo "  Tasks restored: $task_count"
}

cmd_auto() {
    local backup_path="$BACKUP_DIR/clams_auto_$(date +%Y%m%d_%H%M%S).db"

    if [[ ! -f "$DB_PATH" ]]; then
        echo "Error: Database not found at $DB_PATH" >&2
        exit 1
    fi

    # Create backup
    sqlite3 "$DB_PATH" ".backup '$backup_path'"

    # Rotate: keep only last 10 auto backups
    local auto_backups
    auto_backups=$(ls -1t "$BACKUP_DIR"/clams_auto_*.db 2>/dev/null | tail -n +11)

    if [[ -n "$auto_backups" ]]; then
        echo "$auto_backups" | xargs rm -f
        echo "Rotated old auto-backups"
    fi

    echo "Auto-backup created: $(basename "$backup_path")"
}

# Main
if [[ $# -lt 1 ]]; then
    usage
fi

command="$1"
shift

case "$command" in
    create)
        cmd_create "${1:-}"
        ;;
    list)
        cmd_list
        ;;
    restore)
        [[ $# -lt 1 ]] && usage
        cmd_restore "$1"
        ;;
    auto)
        cmd_auto
        ;;
    *)
        echo "Unknown command: $command" >&2
        usage
        ;;
esac
