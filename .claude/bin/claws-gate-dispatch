#!/usr/bin/env bash
#
# claws-gate-dispatch: Route gate checks to type-specific scripts
#
# Usage: claws-gate-dispatch <category> <worktree_path> [project_type]
#
# Arguments:
#   category      - Check category (tests, linter, types, todos, orphans)
#   worktree_path - Path to the worktree
#   project_type  - Optional override (auto-detected if not provided)
#
# Exit codes:
#   0 - Check passed (or skipped due to null config)
#   1 - Check failed (issues found)
#   2 - Configuration error (missing registry, script, etc.)
#
# The dispatcher:
#   1. Loads registry.json
#   2. Determines project type (provided or auto-detect)
#   3. Looks up: checks[category][type] or checks[category][default]
#   4. If null, skips the check (returns 0)
#   5. Executes the type-specific script
#   6. Returns script's exit code

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/claws-common.sh"

usage() {
    echo "Usage: claws-gate-dispatch <category> <worktree_path> [project_type]"
    echo ""
    echo "Categories: tests, linter, types, todos, orphans"
    echo ""
    echo "Arguments:"
    echo "  category      - Check category to run"
    echo "  worktree_path - Path to the worktree"
    echo "  project_type  - Optional override (python, javascript, rust, go, shell, unknown)"
    echo ""
    echo "Exit codes:"
    echo "  0 - Check passed (or skipped)"
    echo "  1 - Check failed"
    echo "  2 - Configuration error"
    exit 2
}

[[ $# -lt 2 ]] && usage

CATEGORY="$1"
WORKTREE="$2"
PROJECT_TYPE="${3:-}"

# Validate category
VALID_CATEGORIES="tests linter types todos orphans"
if ! echo "$VALID_CATEGORIES" | grep -qw "$CATEGORY"; then
    echo "Error: Invalid category '$CATEGORY'" >&2
    echo "Valid categories: $VALID_CATEGORIES" >&2
    exit 2
fi

# Verify worktree exists
if [[ ! -d "$WORKTREE" ]]; then
    echo "Error: Worktree not found: $WORKTREE" >&2
    exit 2
fi

# Verify jq is available
if ! command -v jq &>/dev/null; then
    echo "Error: jq is required for gate dispatch" >&2
    echo "Install with: brew install jq (macOS) or apt install jq (Linux)" >&2
    exit 2
fi

# Registry path (in the GATES_DIR from claws-common.sh)
REGISTRY="$GATES_DIR/registry.json"

if [[ ! -f "$REGISTRY" ]]; then
    echo "Error: Registry not found at $REGISTRY" >&2
    exit 2
fi

# Validate registry JSON
if ! jq empty "$REGISTRY" 2>/dev/null; then
    echo "Error: Invalid JSON in registry file: $REGISTRY" >&2
    exit 2
fi

# Auto-detect project type if not provided
if [[ -z "$PROJECT_TYPE" ]]; then
    PROJECT_TYPE=$(detect_project_type "$WORKTREE")
fi

echo "Dispatching: category=$CATEGORY type=$PROJECT_TYPE worktree=$WORKTREE"

# Look up script in registry: checks[category][type] or checks[category][default]
# Use jq to safely handle JSON parsing
SCRIPT=$(jq -r --arg cat "$CATEGORY" --arg type "$PROJECT_TYPE" \
    '
    if .checks[$cat] then
        if .checks[$cat][$type] then
            .checks[$cat][$type]
        elif .checks[$cat]["default"] then
            .checks[$cat]["default"]
        else
            "NOTFOUND"
        end
    else
        "NOTFOUND"
    end
    ' "$REGISTRY")

# Handle null (skip) case - jq returns "null" as string for JSON null
if [[ "$SCRIPT" == "null" ]]; then
    echo "Skip: $CATEGORY check not applicable for $PROJECT_TYPE (configured as null)"
    exit 0
fi

# Handle missing configuration
if [[ "$SCRIPT" == "NOTFOUND" || -z "$SCRIPT" ]]; then
    echo "Error: No script configured for category=$CATEGORY type=$PROJECT_TYPE" >&2
    echo "Check registry.json for available mappings" >&2
    exit 2
fi

# Resolve script path
SCRIPT_PATH="$GATES_DIR/$SCRIPT"

# Verify script exists and is executable
if [[ ! -f "$SCRIPT_PATH" ]]; then
    echo "Error: Script not found: $SCRIPT_PATH" >&2
    echo "Referenced in registry.json: checks.$CATEGORY.$PROJECT_TYPE" >&2
    exit 2
fi

if [[ ! -x "$SCRIPT_PATH" ]]; then
    echo "Error: Script not executable: $SCRIPT_PATH" >&2
    echo "Run: chmod +x $SCRIPT_PATH" >&2
    exit 2
fi

echo "Executing: $SCRIPT"
echo ""

# Execute the type-specific script
# Pass worktree as first argument (standard interface)
exec "$SCRIPT_PATH" "$WORKTREE"
