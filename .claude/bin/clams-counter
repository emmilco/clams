#!/usr/bin/env bash
#
# clams-counter: Manage system counters for batch job triggers
#
# Usage:
#   clams-counter list                    Show all counters
#   clams-counter get <name>              Get counter value
#   clams-counter set <name> <value>      Set counter to value
#   clams-counter reset <name>            Reset counter to 0
#   clams-counter increment <name>        Increment counter by 1
#   clams-counter add <name> [value]      Create new counter (default 0)

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/clams-common.sh"

if [[ ! -f "$DB_PATH" ]]; then
    echo "Error: Database not found at $DB_PATH. Run clams-init first." >&2
    exit 1
fi

usage() {
    echo "Usage:"
    echo "  clams-counter list                    Show all counters"
    echo "  clams-counter get <name>              Get counter value"
    echo "  clams-counter set <name> <value>      Set counter to value"
    echo "  clams-counter reset <name>            Reset counter to 0"
    echo "  clams-counter increment <name>        Increment counter by 1"
    echo "  clams-counter add <name> [value]      Create new counter"
    echo ""
    echo "Built-in counters:"
    echo "  merges_since_e2e    Triggers E2E batch job at 12"
    echo "  merges_since_docs   Triggers doc update batch job at 12"
    echo "  merge_lock          Blocks merges when > 0 (E2E failed)"
    exit 1
}

cmd_list() {
    sqlite3 -header -column "$DB_PATH" "SELECT name, value FROM system_counters ORDER BY name;"
}

cmd_get() {
    local name="$1"
    local value
    value=$(sqlite3 "$DB_PATH" "SELECT value FROM system_counters WHERE name = '$name';")

    if [[ -z "$value" ]]; then
        echo "Error: Counter not found: $name" >&2
        exit 1
    fi

    echo "$value"
}

cmd_set() {
    local name="$1"
    local value="$2"

    # Validate value is a number
    if ! [[ "$value" =~ ^[0-9]+$ ]]; then
        echo "Error: Value must be a non-negative integer" >&2
        exit 1
    fi

    local exists
    exists=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM system_counters WHERE name = '$name';")

    if [[ "$exists" -eq 0 ]]; then
        echo "Error: Counter not found: $name" >&2
        echo "Use 'clams-counter add $name $value' to create it" >&2
        exit 1
    fi

    sqlite3 "$DB_PATH" "UPDATE system_counters SET value = $value WHERE name = '$name';"
    echo "$name = $value"
}

cmd_reset() {
    local name="$1"
    cmd_set "$name" 0
}

cmd_increment() {
    local name="$1"

    local exists
    exists=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM system_counters WHERE name = '$name';")

    if [[ "$exists" -eq 0 ]]; then
        echo "Error: Counter not found: $name" >&2
        exit 1
    fi

    sqlite3 "$DB_PATH" "UPDATE system_counters SET value = value + 1 WHERE name = '$name';"

    local new_value
    new_value=$(sqlite3 "$DB_PATH" "SELECT value FROM system_counters WHERE name = '$name';")
    echo "$name = $new_value"
}

cmd_add() {
    local name="$1"
    local value="${2:-0}"

    # Validate value is a number
    if ! [[ "$value" =~ ^[0-9]+$ ]]; then
        echo "Error: Value must be a non-negative integer" >&2
        exit 1
    fi

    local exists
    exists=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM system_counters WHERE name = '$name';")

    if [[ "$exists" -gt 0 ]]; then
        echo "Error: Counter already exists: $name" >&2
        exit 1
    fi

    sqlite3 "$DB_PATH" "INSERT INTO system_counters (name, value) VALUES ('$name', $value);"
    echo "Created: $name = $value"
}

# Main
if [[ $# -lt 1 ]]; then
    usage
fi

command="$1"
shift

case "$command" in
    list)
        cmd_list
        ;;
    get)
        [[ $# -lt 1 ]] && usage
        cmd_get "$@"
        ;;
    set)
        [[ $# -lt 2 ]] && usage
        cmd_set "$@"
        ;;
    reset)
        [[ $# -lt 1 ]] && usage
        cmd_reset "$@"
        ;;
    increment|incr)
        [[ $# -lt 1 ]] && usage
        cmd_increment "$@"
        ;;
    add)
        [[ $# -lt 1 ]] && usage
        cmd_add "$@"
        ;;
    *)
        echo "Unknown command: $command" >&2
        usage
        ;;
esac
