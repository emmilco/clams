============================= test session starts ==============================
platform darwin -- Python 3.12.12, pytest-9.0.1, pluggy-1.6.0 -- /Users/elliotmilco/Documents/GitHub/clams/.worktrees/SPEC-002-03/.venv/bin/python
cachedir: .pytest_cache
rootdir: /Users/elliotmilco/Documents/GitHub/clams/.worktrees/SPEC-002-03
configfile: pyproject.toml
testpaths: tests
plugins: anyio-4.12.0, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 30 items

tests/storage/test_memory.py::TestInMemoryVectorStore::test_create_collection PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_create_duplicate_collection PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_delete_collection PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_upsert_and_get PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_upsert_update PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_upsert_wrong_dimension PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_search_cosine_similarity PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_search_with_filters PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_delete PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_scroll PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_scroll_with_filters PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_count PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_count_with_filters PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_get_nonexistent PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_operations_on_nonexistent_collection PASSED
tests/storage/test_qdrant.py::TestQdrantVectorStore::test_create_collection PASSED
tests/storage/test_qdrant.py::TestQdrantVectorStore::test_delete_collection PASSED
tests/storage/test_qdrant.py::TestQdrantVectorStore::test_upsert_and_get PASSED
tests/storage/test_qdrant.py::TestQdrantVectorStore::test_upsert_update PASSED
tests/storage/test_qdrant.py::TestQdrantVectorStore::test_search_cosine_similarity FAILED

=================================== FAILURES ===================================
_____________ TestQdrantVectorStore.test_search_cosine_similarity ______________

self = <tests.storage.test_qdrant.TestQdrantVectorStore object at 0x10b091c70>
store = <learning_memory_server.storage.qdrant.QdrantVectorStore object at 0x10b0b2c30>
collection = 'test_collection'

    async def test_search_cosine_similarity(
        self, store: QdrantVectorStore, collection: str
    ) -> None:
        """Test cosine similarity search."""
        # Insert some test vectors
        vectors = [
            (np.array([1.0, 0.0, 0.0], dtype=np.float32), {"label": "x"}),
            (np.array([0.0, 1.0, 0.0], dtype=np.float32), {"label": "y"}),
            (np.array([0.0, 0.0, 1.0], dtype=np.float32), {"label": "z"}),
            (np.array([0.9, 0.1, 0.0], dtype=np.float32), {"label": "x-ish"}),
        ]
    
        for i, (vec, payload) in enumerate(vectors):
            await store.upsert(collection, f"id{i}", vec, payload)
    
        # Search for x-like vectors
        query = np.array([1.0, 0.0, 0.0], dtype=np.float32)
>       results = await store.search(collection, query, limit=2)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/storage/test_qdrant.py:133: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <learning_memory_server.storage.qdrant.QdrantVectorStore object at 0x10b0b2c30>
collection = 'test_collection', query = array([1., 0., 0.], dtype=float32)
limit = 2, filters = None

    async def search(
        self,
        collection: str,
        query: Vector,
        limit: int = 10,
        filters: dict[str, Any] | None = None,
    ) -> list[SearchResult]:
        """Search for similar vectors."""
        # Convert filters to Qdrant filter format
        qdrant_filter = self._build_filter(filters) if filters else None
    
>       results = await self._client.search(
                        ^^^^^^^^^^^^^^^^^^^
            collection_name=collection,
            query_vector=query.tolist(),
            limit=limit,
            query_filter=qdrant_filter,
            with_payload=True,
            with_vectors=False,
        )
E       AttributeError: 'AsyncQdrantClient' object has no attribute 'search'

src/learning_memory_server/storage/qdrant.py:119: AttributeError
=========================== short test summary info ============================
FAILED tests/storage/test_qdrant.py::TestQdrantVectorStore::test_search_cosine_similarity
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
========================= 1 failed, 19 passed in 0.93s =========================
