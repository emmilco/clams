============================= test session starts ==============================
platform darwin -- Python 3.13.6, pytest-8.4.2, pluggy-1.6.0 -- /Users/elliotmilco/.pyenv/versions/3.13.6/bin/python3.13
cachedir: .pytest_cache
rootdir: /Users/elliotmilco/Documents/GitHub/clams/.worktrees/SPEC-002-18
configfile: pyproject.toml
plugins: asyncio-1.2.0, xdist-3.8.0, timeout-2.4.0, anyio-4.10.0, cov-7.0.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 43 items

tests/context/test_assembler.py::test_assemble_single_source_memories 2025-12-04 12:45:07 [info     ] assembling_context             component=context_assembler context_types=['memories'] limit=20 max_tokens=1000 query='coding preferences'
2025-12-04 12:45:07 [info     ] deduplication_complete         component=context_assembler deduplicated_count=1 original_count=1
2025-12-04 12:45:07 [debug    ] source_budget_used             budget=1000 component=context_assembler items_selected=1 source=memories unused=983 used=17
2025-12-04 12:45:07 [debug    ] redistributing_unused_budget   component=context_assembler total_unused=983
PASSED
tests/context/test_assembler.py::test_assemble_multiple_sources 2025-12-04 12:45:07 [info     ] assembling_context             component=context_assembler context_types=['memories', 'code'] limit=20 max_tokens=2000 query='python examples'
2025-12-04 12:45:07 [info     ] deduplication_complete         component=context_assembler deduplicated_count=2 original_count=2
2025-12-04 12:45:07 [debug    ] source_budget_used             budget=666 component=context_assembler items_selected=1 source=memories unused=649 used=17
2025-12-04 12:45:07 [debug    ] source_budget_used             budget=1333 component=context_assembler items_selected=1 source=code unused=1308 used=25
2025-12-04 12:45:07 [debug    ] redistributing_unused_budget   component=context_assembler total_unused=1957
PASSED
tests/context/test_assembler.py::test_invalid_context_type PASSED
tests/context/test_assembler.py::test_empty_results 2025-12-04 12:45:07 [info     ] assembling_context             component=context_assembler context_types=['memories', 'code'] limit=20 max_tokens=1000 query=nothing
2025-12-04 12:45:07 [info     ] deduplication_complete         component=context_assembler deduplicated_count=0 original_count=0
PASSED
tests/context/test_assembler.py::test_token_budget_distribution 2025-12-04 12:45:07 [info     ] assembling_context             component=context_assembler context_types=['memories'] limit=20 max_tokens=500 query=test
2025-12-04 12:45:07 [info     ] deduplication_complete         component=context_assembler deduplicated_count=1 original_count=20
2025-12-04 12:45:07 [debug    ] source_budget_used             budget=500 component=context_assembler items_selected=1 source=memories unused=485 used=15
2025-12-04 12:45:07 [debug    ] redistributing_unused_budget   component=context_assembler total_unused=485
FAILED

=================================== FAILURES ===================================
________________________ test_token_budget_distribution ________________________

assembler = <learning_memory_server.context.assembler.ContextAssembler object at 0x10985fbb0>
mock_searcher = <tests.context.test_assembler.MockSearcher object at 0x10985fce0>

    @pytest.mark.asyncio
    async def test_token_budget_distribution(
        assembler: ContextAssembler, mock_searcher: MockSearcher
    ) -> None:
        """Test token budget is distributed correctly."""
        # Create many short memories
        mock_searcher.memories = [
            MemoryResult(
                id=f"mem_{i}",
                category="fact",
                content=f"Short memory {i}",
                score=0.9 - (i * 0.01),
                importance=0.5,
                tags=[],
                created_at=datetime.now(timezone.utc),
                verified_at=None,
                verification_status=None,
            )
            for i in range(20)
        ]
    
        result = await assembler.assemble_context(
            query="test",
            context_types=["memories"],
            limit=20,
            max_tokens=500,  # Limited budget
        )
    
        # Should fit multiple items within budget
>       assert len(result.items) > 1
E       AssertionError: assert 1 > 1
E        +  where 1 = len([ContextItem(source='memory', content='**Memory**: Short memory 0\n*Category: fact, Importance: 0.50*', relevance=0.9, metadata={'id': 'mem_0', 'category': 'fact', 'content': 'Short memory 0', 'score': 0.9, 'importance': 0.5, 'tags': [], 'created_at': datetime.datetime(2025, 12, 4, 17, 45, 7, 870330, tzinfo=datetime.timezone.utc), 'verified_at': None, 'verification_status': None})])
E        +    where [ContextItem(source='memory', content='**Memory**: Short memory 0\n*Category: fact, Importance: 0.50*', relevance=0.9, metadata={'id': 'mem_0', 'category': 'fact', 'content': 'Short memory 0', 'score': 0.9, 'importance': 0.5, 'tags': [], 'created_at': datetime.datetime(2025, 12, 4, 17, 45, 7, 870330, tzinfo=datetime.timezone.utc), 'verified_at': None, 'verification_status': None})] = FormattedContext(markdown='# Context\n\n\n## Memories\n\n\n**Memory**: Short memory 0\n*Category: fact, Importance: 0.50*\n\n\n---\n*1 items from 1 sources*', items=[ContextItem(source='memory', content='**Memory**: Short memory 0\n*Category: fact, Importance: 0.50*', relevance=0.9, metadata={'id': 'mem_0', 'category': 'fact', 'content': 'Short memory 0', 'score': 0.9, 'importance': 0.5, 'tags': [], 'created_at': datetime.datetime(2025, 12, 4, 17, 45, 7, 870330, tzinfo=datetime.timezone.utc), 'verified_at': None, 'verification_status': None})], token_count=29, sources_used={'memories': 1}, budget_exceeded=False, truncated_items=[]).items

tests/context/test_assembler.py:235: AssertionError
=========================== short test summary info ============================
FAILED tests/context/test_assembler.py::test_token_budget_distribution - Asse...
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
========================= 1 failed, 4 passed in 0.06s ==========================
