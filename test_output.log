============================= test session starts ==============================
platform darwin -- Python 3.12.12, pytest-9.0.1, pluggy-1.6.0 -- /Users/elliotmilco/Documents/GitHub/clams/.worktrees/SPEC-002-03/.venv/bin/python
cachedir: .pytest_cache
rootdir: /Users/elliotmilco/Documents/GitHub/clams/.worktrees/SPEC-002-03
configfile: pyproject.toml
testpaths: tests
plugins: anyio-4.12.0, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 30 items

tests/storage/test_memory.py::TestInMemoryVectorStore::test_create_collection PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_create_duplicate_collection PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_delete_collection PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_upsert_and_get PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_upsert_update PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_upsert_wrong_dimension PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_search_cosine_similarity PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_search_with_filters PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_delete PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_scroll PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_scroll_with_filters PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_count PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_count_with_filters PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_get_nonexistent PASSED
tests/storage/test_memory.py::TestInMemoryVectorStore::test_operations_on_nonexistent_collection PASSED
tests/storage/test_qdrant.py::TestQdrantVectorStore::test_create_collection PASSED
tests/storage/test_qdrant.py::TestQdrantVectorStore::test_delete_collection PASSED
tests/storage/test_qdrant.py::TestQdrantVectorStore::test_upsert_and_get FAILED

=================================== FAILURES ===================================
__________________ TestQdrantVectorStore.test_upsert_and_get ___________________

self = <tests.storage.test_qdrant.TestQdrantVectorStore object at 0x1094a5610>
store = <learning_memory_server.storage.qdrant.QdrantVectorStore object at 0x10967b650>
collection = 'test_collection'

    async def test_upsert_and_get(
        self, store: QdrantVectorStore, collection: str
    ) -> None:
        """Test inserting and retrieving a vector."""
        vector = np.array([1.0, 2.0, 3.0], dtype=np.float32)
        payload = {"text": "test", "category": "A"}
    
        await store.upsert(collection, "id1", vector, payload)
    
        # Get without vector
        result = await store.get(collection, "id1", with_vector=False)
        assert result is not None
        assert result.id == "id1"
        assert result.payload == payload
        assert result.vector is None
    
        # Get with vector
        result = await store.get(collection, "id1", with_vector=True)
        assert result is not None
        assert result.vector is not None
        # Qdrant returns lists, convert for comparison
        result_array = np.array(result.vector, dtype=np.float32)
>       np.testing.assert_array_almost_equal(result_array, vector, decimal=5)
E       AssertionError: 
E       Arrays are not almost equal to 5 decimals
E       
E       Mismatched elements: 3 / 3 (100%)
E       Max absolute difference among violations: 2.1982164
E       Max relative difference among violations: 0.7327388
E        ACTUAL: array([0.26726, 0.53452, 0.80178], dtype=float32)
E        DESIRED: array([1., 2., 3.], dtype=float32)

tests/storage/test_qdrant.py:91: AssertionError
=========================== short test summary info ============================
FAILED tests/storage/test_qdrant.py::TestQdrantVectorStore::test_upsert_and_get
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
========================= 1 failed, 17 passed in 0.70s =========================
